c7ee47123509f0bb02b420af63306d96
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.BaseService = void 0;
const common_1 = require("@nestjs/common");
const typeorm_1 = require("typeorm");
let BaseService = class BaseService {
    constructor(repository) {
        this.repository = repository;
        this.logger = new common_1.Logger(this.constructor.name);
        this.defaultPageSize = 10;
        this.maxPageSize = 100;
    }
    /**
     * Create a new entity
     */
    async createEntity(data) {
        try {
            const entity = this.repository.create(data);
            return await this.repository.save(entity);
        }
        catch (error) {
            this.handleError(error, 'create entity');
        }
    }
    /**
     * Find entity by ID with optional relations
     */
    async findEntityById(id, relations = []) {
        try {
            const entity = await this.repository.findOne({
                where: { id },
                relations,
            });
            if (!entity) {
                throw new common_1.NotFoundException(`Entity with ID ${id} not found`);
            }
            return entity;
        }
        catch (error) {
            if (error instanceof common_1.NotFoundException)
                throw error;
            this.handleError(error, 'find entity by ID', `ID: ${id}`);
        }
    }
    /**
     * Find entities with pagination and filtering
     */
    async findEntitiesWithPagination(options) {
        try {
            const { page = 1, limit = this.defaultPageSize, sortBy, sortOrder = 'ASC', ...findOptions } = options;
            // Ensure page and limit are within reasonable bounds
            const safePage = Math.max(1, page);
            const safeLimit = Math.min(Math.max(1, limit), this.maxPageSize);
            const skip = (safePage - 1) * safeLimit;
            const [data, total] = await this.repository.findAndCount({
                ...findOptions,
                skip,
                take: safeLimit,
                order: sortBy ? { [sortBy]: sortOrder } : undefined,
            });
            return {
                data,
                total,
                page: safePage,
                limit: safeLimit,
                totalPages: Math.ceil(total / safeLimit),
            };
        }
        catch (error) {
            this.handleError(error, 'find entities with pagination');
        }
    }
    /**
     * Update entity by ID
     */
    async updateEntity(id, data) {
        try {
            await this.findEntityById(id);
            await this.repository.update(id, data);
            return await this.findEntityById(id);
        }
        catch (error) {
            if (error instanceof common_1.NotFoundException)
                throw error;
            this.handleError(error, 'update entity', `ID: ${id}`);
        }
    }
    /**
     * Delete entity by ID (soft delete if available, with fallback to hard delete)
     */
    async deleteEntity(id, forceHardDelete = false) {
        try {
            if (forceHardDelete) {
                const result = await this.repository.delete(id);
                if (result.affected === 0) {
                    throw new common_1.NotFoundException(`Entity with ID ${id} not found`);
                }
            }
            else {
                // Try soft delete first, fallback to hard delete if not supported
                try {
                    const result = await this.repository.softDelete(id);
                    if (result.affected === 0) {
                        throw new common_1.NotFoundException(`Entity with ID ${id} not found`);
                    }
                }
                catch (softDeleteError) {
                    this.logger.warn(`Soft delete not supported for entity ${id}, using hard delete`);
                    const result = await this.repository.delete(id);
                    if (result.affected === 0) {
                        throw new common_1.NotFoundException(`Entity with ID ${id} not found`);
                    }
                }
            }
        }
        catch (error) {
            if (error instanceof common_1.NotFoundException)
                throw error;
            this.handleError(error, 'delete entity', `ID: ${id}`);
        }
    }
    /**
     * Check if entity exists
     */
    async entityExists(where) {
        try {
            const count = await this.repository.count({ where });
            return count > 0;
        }
        catch (error) {
            this.handleError(error, 'check entity existence');
        }
    }
    /**
     * Handle service errors consistently
     */
    handleError(error, operation, context) {
        const contextInfo = context ? ` in ${context}` : '';
        this.logger.error(`Error during ${operation}${contextInfo}: ${error.message}`, error.stack);
        if (error instanceof common_1.NotFoundException || error instanceof common_1.InternalServerErrorException) {
            throw error;
        }
        throw new common_1.InternalServerErrorException(`Error during ${operation}`);
    }
};
exports.BaseService = BaseService;
exports.BaseService = BaseService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_1.Repository !== "undefined" && typeorm_1.Repository) === "function" ? _a : Object])
], BaseService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxvam9zZXBoXFxEb2N1bWVudHNcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFxjb21tb25cXHNlcnZpY2VzXFxiYXNlLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUFxRztBQUNyRyxxQ0FBd0U7QUFrQmpFLElBQWUsV0FBVyxHQUExQixNQUFlLFdBQVc7SUFLL0IsWUFBK0IsVUFBeUI7UUFBekIsZUFBVSxHQUFWLFVBQVUsQ0FBZTtRQUpyQyxXQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMzQyxvQkFBZSxHQUFHLEVBQUUsQ0FBQztRQUNyQixnQkFBVyxHQUFHLEdBQUcsQ0FBQztJQUVzQixDQUFDO0lBRTVEOztPQUVHO0lBQ08sS0FBSyxDQUFDLFlBQVksQ0FBQyxJQUFnQjtRQUMzQyxJQUFJLENBQUM7WUFDSCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUM1QyxPQUFPLE1BQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDNUMsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssRUFBRSxlQUFlLENBQUMsQ0FBQztRQUMzQyxDQUFDO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ08sS0FBSyxDQUFDLGNBQWMsQ0FBQyxFQUFVLEVBQUUsWUFBc0IsRUFBRTtRQUNqRSxJQUFJLENBQUM7WUFDSCxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDO2dCQUMzQyxLQUFLLEVBQUUsRUFBRSxFQUFFLEVBQXlCO2dCQUNwQyxTQUFTO2FBQ1YsQ0FBQyxDQUFDO1lBRUgsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO2dCQUNaLE1BQU0sSUFBSSwwQkFBaUIsQ0FBQyxr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LENBQUMsQ0FBQztZQUNyRCxPQUFPLEtBQUssR0FBRyxDQUFDLENBQUM7UUFDbkIsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssRUFBRSx3QkFBd0IsQ0FBQyxDQUFDO1FBQ3BELENBQUM7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDTyxXQUFXLENBQUMsS0FBVSxFQUFFLFNBQWlCLEVBQUUsT0FBZ0I7UUFDbkUsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxPQUFPLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDcEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLFNBQVMsR0FBRyxXQUFXLEtBQUssS0FBSyxDQUFDLE9BQU8sRUFBRSxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUU1RixJQUFJLEtBQUssWUFBWSwwQkFBaUIsSUFBSSxLQUFLLFlBQVkscUNBQTRCLEVBQUUsQ0FBQztZQUN4RixNQUFNLEtBQUssQ0FBQztRQUNkLENBQUM7UUFFRCxNQUFNLElBQUkscUNBQTRCLENBQUMsZ0JBQWdCLFNBQVMsRUFBRSxDQUFDLENBQUM7SUFDdEUsQ0FBQztDQUNGLENBQUE7QUFySnFCLGtDQUFXO3NCQUFYLFdBQVc7SUFEaEMsSUFBQSxtQkFBVSxHQUFFO3lEQU1nQyxvQkFBVSxvQkFBVixvQkFBVTtHQUxqQyxXQUFXLENBcUpoQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXG9qb3NlcGhcXERvY3VtZW50c1xcU3RyZWxsZXJNaW5kcy1CYWNrZW5kXFxzcmNcXGNvbW1vblxcc2VydmljZXNcXGJhc2Uuc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBMb2dnZXIsIEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24sIE5vdEZvdW5kRXhjZXB0aW9uIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xyXG5pbXBvcnQgeyBSZXBvc2l0b3J5LCBGaW5kT3B0aW9uc1doZXJlLCBGaW5kTWFueU9wdGlvbnMgfSBmcm9tICd0eXBlb3JtJztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgUGFnaW5hdGlvbk9wdGlvbnMge1xyXG4gIHBhZ2U/OiBudW1iZXI7XHJcbiAgbGltaXQ/OiBudW1iZXI7XHJcbiAgc29ydEJ5Pzogc3RyaW5nO1xyXG4gIHNvcnRPcmRlcj86ICdBU0MnIHwgJ0RFU0MnO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFBhZ2luYXRlZFJlc3VsdDxUPiB7XHJcbiAgZGF0YTogVFtdO1xyXG4gIHRvdGFsOiBudW1iZXI7XHJcbiAgcGFnZTogbnVtYmVyO1xyXG4gIGxpbWl0OiBudW1iZXI7XHJcbiAgdG90YWxQYWdlczogbnVtYmVyO1xyXG59XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBCYXNlU2VydmljZTxUPiB7XHJcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIodGhpcy5jb25zdHJ1Y3Rvci5uYW1lKTtcclxuICBwcm90ZWN0ZWQgcmVhZG9ubHkgZGVmYXVsdFBhZ2VTaXplID0gMTA7XHJcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IG1heFBhZ2VTaXplID0gMTAwO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgcmVhZG9ubHkgcmVwb3NpdG9yeTogUmVwb3NpdG9yeTxUPikge31cclxuXHJcbiAgLyoqXHJcbiAgICogQ3JlYXRlIGEgbmV3IGVudGl0eVxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBhc3luYyBjcmVhdGVFbnRpdHkoZGF0YTogUGFydGlhbDxUPik6IFByb21pc2U8VD4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgZW50aXR5ID0gdGhpcy5yZXBvc2l0b3J5LmNyZWF0ZShkYXRhKTtcclxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucmVwb3NpdG9yeS5zYXZlKGVudGl0eSk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICB0aGlzLmhhbmRsZUVycm9yKGVycm9yLCAnY3JlYXRlIGVudGl0eScpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmluZCBlbnRpdHkgYnkgSUQgd2l0aCBvcHRpb25hbCByZWxhdGlvbnNcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgYXN5bmMgZmluZEVudGl0eUJ5SWQoaWQ6IHN0cmluZywgcmVsYXRpb25zOiBzdHJpbmdbXSA9IFtdKTogUHJvbWlzZTxUPiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCBlbnRpdHkgPSBhd2FpdCB0aGlzLnJlcG9zaXRvcnkuZmluZE9uZSh7XHJcbiAgICAgICAgd2hlcmU6IHsgaWQgfSBhcyBGaW5kT3B0aW9uc1doZXJlPFQ+LFxyXG4gICAgICAgIHJlbGF0aW9ucyxcclxuICAgICAgfSk7XHJcbiAgICAgIFxyXG4gICAgICBpZiAoIWVudGl0eSkge1xyXG4gICAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbihgRW50aXR5IHdpdGggSUQgJHtpZH0gbm90IGZvdW5kYCk7XHJcbiAgICAgIH1cclxuICAgICAgXHJcbiAgICAgIHJldHVybiBlbnRpdHk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBOb3RGb3VuZEV4Y2VwdGlvbikgdGhyb3cgZXJyb3I7XHJcbiAgICAgIHRoaXMuaGFuZGxlRXJyb3IoZXJyb3IsICdmaW5kIGVudGl0eSBieSBJRCcsIGBJRDogJHtpZH1gKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZpbmQgZW50aXRpZXMgd2l0aCBwYWdpbmF0aW9uIGFuZCBmaWx0ZXJpbmdcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgYXN5bmMgZmluZEVudGl0aWVzV2l0aFBhZ2luYXRpb24oXHJcbiAgICBvcHRpb25zOiBGaW5kTWFueU9wdGlvbnM8VD4gJiBQYWdpbmF0aW9uT3B0aW9uc1xyXG4gICk6IFByb21pc2U8UGFnaW5hdGVkUmVzdWx0PFQ+PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCB7IFxyXG4gICAgICAgIHBhZ2UgPSAxLCBcclxuICAgICAgICBsaW1pdCA9IHRoaXMuZGVmYXVsdFBhZ2VTaXplLCBcclxuICAgICAgICBzb3J0QnksIFxyXG4gICAgICAgIHNvcnRPcmRlciA9ICdBU0MnLCBcclxuICAgICAgICAuLi5maW5kT3B0aW9ucyBcclxuICAgICAgfSA9IG9wdGlvbnM7XHJcbiAgICAgIFxyXG4gICAgICAvLyBFbnN1cmUgcGFnZSBhbmQgbGltaXQgYXJlIHdpdGhpbiByZWFzb25hYmxlIGJvdW5kc1xyXG4gICAgICBjb25zdCBzYWZlUGFnZSA9IE1hdGgubWF4KDEsIHBhZ2UpO1xyXG4gICAgICBjb25zdCBzYWZlTGltaXQgPSBNYXRoLm1pbihNYXRoLm1heCgxLCBsaW1pdCksIHRoaXMubWF4UGFnZVNpemUpO1xyXG4gICAgICBjb25zdCBza2lwID0gKHNhZmVQYWdlIC0gMSkgKiBzYWZlTGltaXQ7XHJcblxyXG4gICAgICBjb25zdCBbZGF0YSwgdG90YWxdID0gYXdhaXQgdGhpcy5yZXBvc2l0b3J5LmZpbmRBbmRDb3VudCh7XHJcbiAgICAgICAgLi4uZmluZE9wdGlvbnMsXHJcbiAgICAgICAgc2tpcCxcclxuICAgICAgICB0YWtlOiBzYWZlTGltaXQsXHJcbiAgICAgICAgb3JkZXI6IHNvcnRCeSA/IHsgW3NvcnRCeV06IHNvcnRPcmRlciB9IDogdW5kZWZpbmVkLFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgZGF0YSxcclxuICAgICAgICB0b3RhbCxcclxuICAgICAgICBwYWdlOiBzYWZlUGFnZSxcclxuICAgICAgICBsaW1pdDogc2FmZUxpbWl0LFxyXG4gICAgICAgIHRvdGFsUGFnZXM6IE1hdGguY2VpbCh0b3RhbCAvIHNhZmVMaW1pdCksXHJcbiAgICAgIH07XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICB0aGlzLmhhbmRsZUVycm9yKGVycm9yLCAnZmluZCBlbnRpdGllcyB3aXRoIHBhZ2luYXRpb24nKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFVwZGF0ZSBlbnRpdHkgYnkgSURcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgYXN5bmMgdXBkYXRlRW50aXR5KGlkOiBzdHJpbmcsIGRhdGE6IFBhcnRpYWw8VD4pOiBQcm9taXNlPFQ+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGF3YWl0IHRoaXMuZmluZEVudGl0eUJ5SWQoaWQpO1xyXG4gICAgICBhd2FpdCB0aGlzLnJlcG9zaXRvcnkudXBkYXRlKGlkLCBkYXRhKTtcclxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZEVudGl0eUJ5SWQoaWQpO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgTm90Rm91bmRFeGNlcHRpb24pIHRocm93IGVycm9yO1xyXG4gICAgICB0aGlzLmhhbmRsZUVycm9yKGVycm9yLCAndXBkYXRlIGVudGl0eScsIGBJRDogJHtpZH1gKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIERlbGV0ZSBlbnRpdHkgYnkgSUQgKHNvZnQgZGVsZXRlIGlmIGF2YWlsYWJsZSwgd2l0aCBmYWxsYmFjayB0byBoYXJkIGRlbGV0ZSlcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgYXN5bmMgZGVsZXRlRW50aXR5KGlkOiBzdHJpbmcsIGZvcmNlSGFyZERlbGV0ZSA9IGZhbHNlKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBpZiAoZm9yY2VIYXJkRGVsZXRlKSB7XHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5yZXBvc2l0b3J5LmRlbGV0ZShpZCk7XHJcbiAgICAgICAgaWYgKHJlc3VsdC5hZmZlY3RlZCA9PT0gMCkge1xyXG4gICAgICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKGBFbnRpdHkgd2l0aCBJRCAke2lkfSBub3QgZm91bmRgKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gVHJ5IHNvZnQgZGVsZXRlIGZpcnN0LCBmYWxsYmFjayB0byBoYXJkIGRlbGV0ZSBpZiBub3Qgc3VwcG9ydGVkXHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMucmVwb3NpdG9yeS5zb2Z0RGVsZXRlKGlkKTtcclxuICAgICAgICAgIGlmIChyZXN1bHQuYWZmZWN0ZWQgPT09IDApIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKGBFbnRpdHkgd2l0aCBJRCAke2lkfSBub3QgZm91bmRgKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGNhdGNoIChzb2Z0RGVsZXRlRXJyb3IpIHtcclxuICAgICAgICAgIHRoaXMubG9nZ2VyLndhcm4oYFNvZnQgZGVsZXRlIG5vdCBzdXBwb3J0ZWQgZm9yIGVudGl0eSAke2lkfSwgdXNpbmcgaGFyZCBkZWxldGVgKTtcclxuICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMucmVwb3NpdG9yeS5kZWxldGUoaWQpO1xyXG4gICAgICAgICAgaWYgKHJlc3VsdC5hZmZlY3RlZCA9PT0gMCkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oYEVudGl0eSB3aXRoIElEICR7aWR9IG5vdCBmb3VuZGApO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgTm90Rm91bmRFeGNlcHRpb24pIHRocm93IGVycm9yO1xyXG4gICAgICB0aGlzLmhhbmRsZUVycm9yKGVycm9yLCAnZGVsZXRlIGVudGl0eScsIGBJRDogJHtpZH1gKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENoZWNrIGlmIGVudGl0eSBleGlzdHNcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgYXN5bmMgZW50aXR5RXhpc3RzKHdoZXJlOiBGaW5kT3B0aW9uc1doZXJlPFQ+KTogUHJvbWlzZTxib29sZWFuPiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCBjb3VudCA9IGF3YWl0IHRoaXMucmVwb3NpdG9yeS5jb3VudCh7IHdoZXJlIH0pO1xyXG4gICAgICByZXR1cm4gY291bnQgPiAwO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgdGhpcy5oYW5kbGVFcnJvcihlcnJvciwgJ2NoZWNrIGVudGl0eSBleGlzdGVuY2UnKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEhhbmRsZSBzZXJ2aWNlIGVycm9ycyBjb25zaXN0ZW50bHlcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgaGFuZGxlRXJyb3IoZXJyb3I6IGFueSwgb3BlcmF0aW9uOiBzdHJpbmcsIGNvbnRleHQ/OiBzdHJpbmcpOiBuZXZlciB7XHJcbiAgICBjb25zdCBjb250ZXh0SW5mbyA9IGNvbnRleHQgPyBgIGluICR7Y29udGV4dH1gIDogJyc7XHJcbiAgICB0aGlzLmxvZ2dlci5lcnJvcihgRXJyb3IgZHVyaW5nICR7b3BlcmF0aW9ufSR7Y29udGV4dEluZm99OiAke2Vycm9yLm1lc3NhZ2V9YCwgZXJyb3Iuc3RhY2spO1xyXG4gICAgXHJcbiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBOb3RGb3VuZEV4Y2VwdGlvbiB8fCBlcnJvciBpbnN0YW5jZW9mIEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24pIHtcclxuICAgICAgdGhyb3cgZXJyb3I7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKGBFcnJvciBkdXJpbmcgJHtvcGVyYXRpb259YCk7XHJcbiAgfVxyXG59XHJcbiJdLCJ2ZXJzaW9uIjozfQ==