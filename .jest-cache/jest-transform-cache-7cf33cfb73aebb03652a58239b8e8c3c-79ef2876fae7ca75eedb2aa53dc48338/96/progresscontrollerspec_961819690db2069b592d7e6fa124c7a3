51b437c6df9d9ec08e5aedddcb372c85
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const progress_controller_1 = require("./progress.controller");
const progress_service_1 = require("../services/progress.service");
const common_1 = require("@nestjs/common");
describe('ProgressController', () => {
    let controller;
    let service;
    const mockProgressService = {
        updateLessonProgress: jest.fn(),
        getCourseProgress: jest.fn(),
        getUserProgress: jest.fn(),
        syncProgress: jest.fn(),
    };
    beforeEach(async () => {
        const module = await testing_1.Test.createTestingModule({
            controllers: [progress_controller_1.ProgressController],
            providers: [
                {
                    provide: progress_service_1.ProgressService,
                    useValue: mockProgressService,
                },
            ],
        }).compile();
        controller = module.get(progress_controller_1.ProgressController);
        service = module.get(progress_service_1.ProgressService);
    });
    describe('updateLessonProgress', () => {
        const mockRequest = {
            user: { id: 'user1' },
        };
        const mockUpdateProgressDto = {
            progressPercentage: 50,
            metadata: { timeSpent: 1200 },
        };
        it('should update lesson progress successfully', async () => {
            const expectedResult = {
                id: '1',
                progressPercentage: 50,
                isCompleted: false,
            };
            mockProgressService.updateLessonProgress.mockResolvedValue(expectedResult);
            const result = await controller.updateLessonProgress(mockRequest, 'course1', 'lesson1', mockUpdateProgressDto);
            expect(result).toEqual(expectedResult);
            expect(service.updateLessonProgress).toHaveBeenCalledWith('user1', 'course1', 'lesson1', 50, { timeSpent: 1200 });
        });
        it('should handle errors appropriately', async () => {
            mockProgressService.updateLessonProgress.mockRejectedValue(new Error('Database error'));
            await expect(controller.updateLessonProgress(mockRequest, 'course1', 'lesson1', mockUpdateProgressDto)).rejects.toThrow(common_1.HttpException);
        });
    });
    describe('getCourseProgress', () => {
        const mockRequest = {
            user: { id: 'user1' },
        };
        it('should return course progress successfully', async () => {
            const expectedResult = {
                overallProgress: 50,
                completedLessons: 1,
                totalLessons: 2,
                moduleProgress: [],
            };
            mockProgressService.getCourseProgress.mockResolvedValue(expectedResult);
            const result = await controller.getCourseProgress(mockRequest, 'course1');
            expect(result).toEqual(expectedResult);
            expect(service.getCourseProgress).toHaveBeenCalledWith('user1', 'course1');
        });
        it('should handle errors appropriately', async () => {
            mockProgressService.getCourseProgress.mockRejectedValue(new Error('Database error'));
            await expect(controller.getCourseProgress(mockRequest, 'course1')).rejects.toThrow(common_1.HttpException);
        });
    });
    describe('getUserProgress', () => {
        const mockRequest = {
            user: { id: 'user1' },
        };
        it('should return user progress successfully', async () => {
            const expectedResult = [
                {
                    courseId: 'course1',
                    courseTitle: 'Course 1',
                    progress: 50,
                    lastAccessed: new Date(),
                },
            ];
            mockProgressService.getUserProgress.mockResolvedValue(expectedResult);
            const result = await controller.getUserProgress(mockRequest);
            expect(result).toEqual(expectedResult);
            expect(service.getUserProgress).toHaveBeenCalledWith('user1');
        });
        it('should handle errors appropriately', async () => {
            mockProgressService.getUserProgress.mockRejectedValue(new Error('Database error'));
            await expect(controller.getUserProgress(mockRequest)).rejects.toThrow(common_1.HttpException);
        });
    });
    describe('syncProgress', () => {
        const mockRequest = {
            user: { id: 'user1' },
        };
        it('should sync progress successfully', async () => {
            mockProgressService.syncProgress.mockResolvedValue(undefined);
            const result = await controller.syncProgress(mockRequest, 'course1');
            expect(result).toEqual({ message: 'Progress synchronized successfully' });
            expect(service.syncProgress).toHaveBeenCalledWith('user1', 'course1');
        });
        it('should handle errors appropriately', async () => {
            mockProgressService.syncProgress.mockRejectedValue(new Error('Database error'));
            await expect(controller.syncProgress(mockRequest, 'course1')).rejects.toThrow(common_1.HttpException);
        });
    });
    describe('getCourseProgressAdmin', () => {
        it('should return admin course progress successfully', async () => {
            const expectedResult = {
                overallProgress: 50,
                completedLessons: 1,
                totalLessons: 2,
                moduleProgress: [],
            };
            mockProgressService.getCourseProgress.mockResolvedValue(expectedResult);
            const result = await controller.getCourseProgressAdmin('course1');
            expect(result).toEqual(expectedResult);
            expect(service.getCourseProgress).toHaveBeenCalledWith('course1');
        });
        it('should handle errors appropriately', async () => {
            mockProgressService.getCourseProgress.mockRejectedValue(new Error('Database error'));
            await expect(controller.getCourseProgressAdmin('course1')).rejects.toThrow(common_1.HttpException);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxvam9zZXBoXFxEb2N1bWVudHNcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFx1c2Vyc1xcY29udHJvbGxlcnNcXHByb2dyZXNzLmNvbnRyb2xsZXIuc3BlYy50cyIsIm1hcHBpbmdzIjoiOztBQUFBLDZDQUFzRDtBQUN0RCwrREFBMkQ7QUFDM0QsbUVBQStEO0FBQy9ELDJDQUEyRDtBQUUzRCxRQUFRLENBQUMsb0JBQW9CLEVBQUUsR0FBRyxFQUFFO0lBQ2xDLElBQUksVUFBOEIsQ0FBQztJQUNuQyxJQUFJLE9BQXdCLENBQUM7SUFFN0IsTUFBTSxtQkFBbUIsR0FBRztRQUMxQixvQkFBb0IsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQy9CLGlCQUFpQixFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDNUIsZUFBZSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDMUIsWUFBWSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7S0FDeEIsQ0FBQztJQUVGLFVBQVUsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNwQixNQUFNLE1BQU0sR0FBa0IsTUFBTSxjQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDM0QsV0FBVyxFQUFFLENBQUMsd0NBQWtCLENBQUM7WUFDakMsU0FBUyxFQUFFO2dCQUNUO29CQUNFLE9BQU8sRUFBRSxrQ0FBZTtvQkFDeEIsUUFBUSxFQUFFLG1CQUFtQjtpQkFDOUI7YUFDRjtTQUNGLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUViLFVBQVUsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFxQix3Q0FBa0IsQ0FBQyxDQUFDO1FBQ2hFLE9BQU8sR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFrQixrQ0FBZSxDQUFDLENBQUM7SUFDekQsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsc0JBQXNCLEVBQUUsR0FBRyxFQUFFO1FBQ3BDLE1BQU0sV0FBVyxHQUFHO1lBQ2xCLElBQUksRUFBRSxFQUFFLEVBQUUsRUFBRSxPQUFPLEVBQUU7U0FDdEIs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TUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBQ3ZDLE1BQU0sQ0FBQyxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUNwRSxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyxvQ0FBb0MsRUFBRSxLQUFLLElBQUksRUFBRTtZQUNsRCxtQkFBbUIsQ0FBQyxpQkFBaUIsQ0FBQyxpQkFBaUIsQ0FDckQsSUFBSSxLQUFLLENBQUMsZ0JBQWdCLENBQUMsQ0FDNUIsQ0FBQztZQUVGLE1BQU0sTUFBTSxDQUNWLFVBQVUsQ0FBQyxzQkFBc0IsQ0FBQyxTQUFTLENBQUMsQ0FDN0MsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLHNCQUFhLENBQUMsQ0FBQztRQUNuQyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxvam9zZXBoXFxEb2N1bWVudHNcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFx1c2Vyc1xcY29udHJvbGxlcnNcXHByb2dyZXNzLmNvbnRyb2xsZXIuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZXN0LCBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcclxuaW1wb3J0IHsgUHJvZ3Jlc3NDb250cm9sbGVyIH0gZnJvbSAnLi9wcm9ncmVzcy5jb250cm9sbGVyJztcclxuaW1wb3J0IHsgUHJvZ3Jlc3NTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvcHJvZ3Jlc3Muc2VydmljZSc7XHJcbmltcG9ydCB7IEh0dHBFeGNlcHRpb24sIEh0dHBTdGF0dXMgfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XHJcblxyXG5kZXNjcmliZSgnUHJvZ3Jlc3NDb250cm9sbGVyJywgKCkgPT4ge1xyXG4gIGxldCBjb250cm9sbGVyOiBQcm9ncmVzc0NvbnRyb2xsZXI7XHJcbiAgbGV0IHNlcnZpY2U6IFByb2dyZXNzU2VydmljZTtcclxuXHJcbiAgY29uc3QgbW9ja1Byb2dyZXNzU2VydmljZSA9IHtcclxuICAgIHVwZGF0ZUxlc3NvblByb2dyZXNzOiBqZXN0LmZuKCksXHJcbiAgICBnZXRDb3Vyc2VQcm9ncmVzczogamVzdC5mbigpLFxyXG4gICAgZ2V0VXNlclByb2dyZXNzOiBqZXN0LmZuKCksXHJcbiAgICBzeW5jUHJvZ3Jlc3M6IGplc3QuZm4oKSxcclxuICB9O1xyXG5cclxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcclxuICAgIGNvbnN0IG1vZHVsZTogVGVzdGluZ01vZHVsZSA9IGF3YWl0IFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7XHJcbiAgICAgIGNvbnRyb2xsZXJzOiBbUHJvZ3Jlc3NDb250cm9sbGVyXSxcclxuICAgICAgcHJvdmlkZXJzOiBbXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgcHJvdmlkZTogUHJvZ3Jlc3NTZXJ2aWNlLFxyXG4gICAgICAgICAgdXNlVmFsdWU6IG1vY2tQcm9ncmVzc1NlcnZpY2UsXHJcbiAgICAgICAgfSxcclxuICAgICAgXSxcclxuICAgIH0pLmNvbXBpbGUoKTtcclxuXHJcbiAgICBjb250cm9sbGVyID0gbW9kdWxlLmdldDxQcm9ncmVzc0NvbnRyb2xsZXI+KFByb2dyZXNzQ29udHJvbGxlcik7XHJcbiAgICBzZXJ2aWNlID0gbW9kdWxlLmdldDxQcm9ncmVzc1NlcnZpY2U+KFByb2dyZXNzU2VydmljZSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCd1cGRhdGVMZXNzb25Qcm9ncmVzcycsICgpID0+IHtcclxuICAgIGNvbnN0IG1vY2tSZXF1ZXN0ID0ge1xyXG4gICAgICB1c2VyOiB7IGlkOiAndXNlcjEnIH0sXHJcbiAgICB9O1xyXG5cclxuICAgIGNvbnN0IG1vY2tVcGRhdGVQcm9ncmVzc0R0byA9IHtcclxuICAgICAgcHJvZ3Jlc3NQZXJjZW50YWdlOiA1MCxcclxuICAgICAgbWV0YWRhdGE6IHsgdGltZVNwZW50OiAxMjAwIH0sXHJcbiAgICB9O1xyXG5cclxuICAgIGl0KCdzaG91bGQgdXBkYXRlIGxlc3NvbiBwcm9ncmVzcyBzdWNjZXNzZnVsbHknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGV4cGVjdGVkUmVzdWx0ID0ge1xyXG4gICAgICAgIGlkOiAnMScsXHJcbiAgICAgICAgcHJvZ3Jlc3NQZXJjZW50YWdlOiA1MCxcclxuICAgICAgICBpc0NvbXBsZXRlZDogZmFsc2UsXHJcbiAgICAgIH07XHJcblxyXG4gICAgICBtb2NrUHJvZ3Jlc3NTZXJ2aWNlLnVwZGF0ZUxlc3NvblByb2dyZXNzLm1vY2tSZXNvbHZlZFZhbHVlKGV4cGVjdGVkUmVzdWx0KTtcclxuXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGNvbnRyb2xsZXIudXBkYXRlTGVzc29uUHJvZ3Jlc3MoXHJcbiAgICAgICAgbW9ja1JlcXVlc3QsXHJcbiAgICAgICAgJ2NvdXJzZTEnLFxyXG4gICAgICAgICdsZXNzb24xJyxcclxuICAgICAgICBtb2NrVXBkYXRlUHJvZ3Jlc3NEdG8sXHJcbiAgICAgICk7XHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKGV4cGVjdGVkUmVzdWx0KTtcclxuICAgICAgZXhwZWN0KHNlcnZpY2UudXBkYXRlTGVzc29uUHJvZ3Jlc3MpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxyXG4gICAgICAgICd1c2VyMScsXHJcbiAgICAgICAgJ2NvdXJzZTEnLFxyXG4gICAgICAgICdsZXNzb24xJyxcclxuICAgICAgICA1MCxcclxuICAgICAgICB7IHRpbWVTcGVudDogMTIwMCB9LFxyXG4gICAgICApO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgZXJyb3JzIGFwcHJvcHJpYXRlbHknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIG1vY2tQcm9ncmVzc1NlcnZpY2UudXBkYXRlTGVzc29uUHJvZ3Jlc3MubW9ja1JlamVjdGVkVmFsdWUoXHJcbiAgICAgICAgbmV3IEVycm9yKCdEYXRhYmFzZSBlcnJvcicpLFxyXG4gICAgICApO1xyXG5cclxuICAgICAgYXdhaXQgZXhwZWN0KFxyXG4gICAgICAgIGNvbnRyb2xsZXIudXBkYXRlTGVzc29uUHJvZ3Jlc3MoXHJcbiAgICAgICAgICBtb2NrUmVxdWVzdCxcclxuICAgICAgICAgICdjb3Vyc2UxJyxcclxuICAgICAgICAgICdsZXNzb24xJyxcclxuICAgICAgICAgIG1vY2tVcGRhdGVQcm9ncmVzc0R0byxcclxuICAgICAgICApLFxyXG4gICAgICApLnJlamVjdHMudG9UaHJvdyhIdHRwRXhjZXB0aW9uKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnZ2V0Q291cnNlUHJvZ3Jlc3MnLCAoKSA9PiB7XHJcbiAgICBjb25zdCBtb2NrUmVxdWVzdCA9IHtcclxuICAgICAgdXNlcjogeyBpZDogJ3VzZXIxJyB9LFxyXG4gICAgfTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHJldHVybiBjb3Vyc2UgcHJvZ3Jlc3Mgc3VjY2Vzc2Z1bGx5JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBleHBlY3RlZFJlc3VsdCA9IHtcclxuICAgICAgICBvdmVyYWxsUHJvZ3Jlc3M6IDUwLFxyXG4gICAgICAgIGNvbXBsZXRlZExlc3NvbnM6IDEsXHJcbiAgICAgICAgdG90YWxMZXNzb25zOiAyLFxyXG4gICAgICAgIG1vZHVsZVByb2dyZXNzOiBbXSxcclxuICAgICAgfTtcclxuXHJcbiAgICAgIG1vY2tQcm9ncmVzc1NlcnZpY2UuZ2V0Q291cnNlUHJvZ3Jlc3MubW9ja1Jlc29sdmVkVmFsdWUoZXhwZWN0ZWRSZXN1bHQpO1xyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgY29udHJvbGxlci5nZXRDb3Vyc2VQcm9ncmVzcyhtb2NrUmVxdWVzdCwgJ2NvdXJzZTEnKTtcclxuXHJcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwoZXhwZWN0ZWRSZXN1bHQpO1xyXG4gICAgICBleHBlY3Qoc2VydmljZS5nZXRDb3Vyc2VQcm9ncmVzcykudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ3VzZXIxJywgJ2NvdXJzZTEnKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgaGFuZGxlIGVycm9ycyBhcHByb3ByaWF0ZWx5JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBtb2NrUHJvZ3Jlc3NTZXJ2aWNlLmdldENvdXJzZVByb2dyZXNzLm1vY2tSZWplY3RlZFZhbHVlKFxyXG4gICAgICAgIG5ldyBFcnJvcignRGF0YWJhc2UgZXJyb3InKSxcclxuICAgICAgKTtcclxuXHJcbiAgICAgIGF3YWl0IGV4cGVjdChcclxuICAgICAgICBjb250cm9sbGVyLmdldENvdXJzZVByb2dyZXNzKG1vY2tSZXF1ZXN0LCAnY291cnNlMScpLFxyXG4gICAgICApLnJlamVjdHMudG9UaHJvdyhIdHRwRXhjZXB0aW9uKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnZ2V0VXNlclByb2dyZXNzJywgKCkgPT4ge1xyXG4gICAgY29uc3QgbW9ja1JlcXVlc3QgPSB7XHJcbiAgICAgIHVzZXI6IHsgaWQ6ICd1c2VyMScgfSxcclxuICAgIH07XHJcblxyXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gdXNlciBwcm9ncmVzcyBzdWNjZXNzZnVsbHknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGV4cGVjdGVkUmVzdWx0ID0gW1xyXG4gICAgICAgIHtcclxuICAgICAgICAgIGNvdXJzZUlkOiAnY291cnNlMScsXHJcbiAgICAgICAgICBjb3Vyc2VUaXRsZTogJ0NvdXJzZSAxJyxcclxuICAgICAgICAgIHByb2dyZXNzOiA1MCxcclxuICAgICAgICAgIGxhc3RBY2Nlc3NlZDogbmV3IERhdGUoKSxcclxuICAgICAgICB9LFxyXG4gICAgICBdO1xyXG5cclxuICAgICAgbW9ja1Byb2dyZXNzU2VydmljZS5nZXRVc2VyUHJvZ3Jlc3MubW9ja1Jlc29sdmVkVmFsdWUoZXhwZWN0ZWRSZXN1bHQpO1xyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgY29udHJvbGxlci5nZXRVc2VyUHJvZ3Jlc3MobW9ja1JlcXVlc3QpO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChleHBlY3RlZFJlc3VsdCk7XHJcbiAgICAgIGV4cGVjdChzZXJ2aWNlLmdldFVzZXJQcm9ncmVzcykudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ3VzZXIxJyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBlcnJvcnMgYXBwcm9wcmlhdGVseScsIGFzeW5jICgpID0+IHtcclxuICAgICAgbW9ja1Byb2dyZXNzU2VydmljZS5nZXRVc2VyUHJvZ3Jlc3MubW9ja1JlamVjdGVkVmFsdWUoXHJcbiAgICAgICAgbmV3IEVycm9yKCdEYXRhYmFzZSBlcnJvcicpLFxyXG4gICAgICApO1xyXG5cclxuICAgICAgYXdhaXQgZXhwZWN0KGNvbnRyb2xsZXIuZ2V0VXNlclByb2dyZXNzKG1vY2tSZXF1ZXN0KSkucmVqZWN0cy50b1Rocm93KFxyXG4gICAgICAgIEh0dHBFeGNlcHRpb24sXHJcbiAgICAgICk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ3N5bmNQcm9ncmVzcycsICgpID0+IHtcclxuICAgIGNvbnN0IG1vY2tSZXF1ZXN0ID0ge1xyXG4gICAgICB1c2VyOiB7IGlkOiAndXNlcjEnIH0sXHJcbiAgICB9O1xyXG5cclxuICAgIGl0KCdzaG91bGQgc3luYyBwcm9ncmVzcyBzdWNjZXNzZnVsbHknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIG1vY2tQcm9ncmVzc1NlcnZpY2Uuc3luY1Byb2dyZXNzLm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZCk7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjb250cm9sbGVyLnN5bmNQcm9ncmVzcyhtb2NrUmVxdWVzdCwgJ2NvdXJzZTEnKTtcclxuXHJcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwoeyBtZXNzYWdlOiAnUHJvZ3Jlc3Mgc3luY2hyb25pemVkIHN1Y2Nlc3NmdWxseScgfSk7XHJcbiAgICAgIGV4cGVjdChzZXJ2aWNlLnN5bmNQcm9ncmVzcykudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ3VzZXIxJywgJ2NvdXJzZTEnKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgaGFuZGxlIGVycm9ycyBhcHByb3ByaWF0ZWx5JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBtb2NrUHJvZ3Jlc3NTZXJ2aWNlLnN5bmNQcm9ncmVzcy5tb2NrUmVqZWN0ZWRWYWx1ZShcclxuICAgICAgICBuZXcgRXJyb3IoJ0RhdGFiYXNlIGVycm9yJyksXHJcbiAgICAgICk7XHJcblxyXG4gICAgICBhd2FpdCBleHBlY3QoXHJcbiAgICAgICAgY29udHJvbGxlci5zeW5jUHJvZ3Jlc3MobW9ja1JlcXVlc3QsICdjb3Vyc2UxJyksXHJcbiAgICAgICkucmVqZWN0cy50b1Rocm93KEh0dHBFeGNlcHRpb24pO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdnZXRDb3Vyc2VQcm9ncmVzc0FkbWluJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gYWRtaW4gY291cnNlIHByb2dyZXNzIHN1Y2Nlc3NmdWxseScsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgZXhwZWN0ZWRSZXN1bHQgPSB7XHJcbiAgICAgICAgb3ZlcmFsbFByb2dyZXNzOiA1MCxcclxuICAgICAgICBjb21wbGV0ZWRMZXNzb25zOiAxLFxyXG4gICAgICAgIHRvdGFsTGVzc29uczogMixcclxuICAgICAgICBtb2R1bGVQcm9ncmVzczogW10sXHJcbiAgICAgIH07XHJcblxyXG4gICAgICBtb2NrUHJvZ3Jlc3NTZXJ2aWNlLmdldENvdXJzZVByb2dyZXNzLm1vY2tSZXNvbHZlZFZhbHVlKGV4cGVjdGVkUmVzdWx0KTtcclxuXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGNvbnRyb2xsZXIuZ2V0Q291cnNlUHJvZ3Jlc3NBZG1pbignY291cnNlMScpO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChleHBlY3RlZFJlc3VsdCk7XHJcbiAgICAgIGV4cGVjdChzZXJ2aWNlLmdldENvdXJzZVByb2dyZXNzKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnY291cnNlMScpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgZXJyb3JzIGFwcHJvcHJpYXRlbHknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIG1vY2tQcm9ncmVzc1NlcnZpY2UuZ2V0Q291cnNlUHJvZ3Jlc3MubW9ja1JlamVjdGVkVmFsdWUoXHJcbiAgICAgICAgbmV3IEVycm9yKCdEYXRhYmFzZSBlcnJvcicpLFxyXG4gICAgICApO1xyXG5cclxuICAgICAgYXdhaXQgZXhwZWN0KFxyXG4gICAgICAgIGNvbnRyb2xsZXIuZ2V0Q291cnNlUHJvZ3Jlc3NBZG1pbignY291cnNlMScpLFxyXG4gICAgICApLnJlamVjdHMudG9UaHJvdyhIdHRwRXhjZXB0aW9uKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG59KTsgIl0sInZlcnNpb24iOjN9