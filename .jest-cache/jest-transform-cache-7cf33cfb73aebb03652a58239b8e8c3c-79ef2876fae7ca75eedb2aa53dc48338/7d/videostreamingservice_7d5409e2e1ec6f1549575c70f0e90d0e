7dc943a4e61c0a00c625ca8a993397bf
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var VideoStreamingService_1;
var _a, _b, _c, _d, _e, _f, _g;
Object.defineProperty(exports, "__esModule", { value: true });
exports.VideoStreamingService = void 0;
const common_1 = require("@nestjs/common");
const typeorm_1 = require("@nestjs/typeorm");
const typeorm_2 = require("typeorm");
const video_entity_1 = require("../entities/video.entity");
const video_quality_entity_1 = require("../entities/video-quality.entity");
const user_entity_1 = require("../../users/entities/user.entity");
const aws_cloudfront_service_1 = require("./aws-cloudfront.service");
const video_processing_service_1 = require("./video-processing.service");
const video_security_service_1 = require("./video-security.service");
const video_analytics_service_1 = require("./video-analytics.service");
let VideoStreamingService = VideoStreamingService_1 = class VideoStreamingService {
    constructor(videoRepository, qualityRepository, userRepository, cloudFrontService, processingService, securityService, analyticsService) {
        this.videoRepository = videoRepository;
        this.qualityRepository = qualityRepository;
        this.userRepository = userRepository;
        this.cloudFrontService = cloudFrontService;
        this.processingService = processingService;
        this.securityService = securityService;
        this.analyticsService = analyticsService;
        this.logger = new common_1.Logger(VideoStreamingService_1.name);
    }
    async createVideo(createVideoDto, uploadedBy) {
        try {
            this.logger.debug(`Creating video: ${createVideoDto.title}`);
            // Create video entity
            const video = this.videoRepository.create({
                ...createVideoDto,
                uploadedBy,
                status: video_entity_1.VideoStatus.UPLOADING,
                visibility: createVideoDto.visibility || video_entity_1.VideoVisibility.PRIVATE,
                metadata: {
                    originalFormat: this.extractFileExtension(createVideoDto.originalFilename),
                    uploadMethod: 'direct',
                    tags: createVideoDto.tags || [],
                    chapters: createVideoDto.chapters || [],
                    customData: createVideoDto.customData || {},
                },
                securitySettings: {
                    requireAuth: true,
                    allowedDomains: [],
                    geoRestrictions: {},
                    drmEnabled: false,
                    signedUrlExpiry: 3600,
                    downloadEnabled: false,
                    embedEnabled: false,
                    ...createVideoDto.securitySettings,
                },
                processingSettings: {
                    generateThumbnails: true,
                    thumbnailCount: 5,
                    generatePreview: true,
                    adaptiveStreaming: true,
                    qualityLevels: ['720p', '480p', '360p'],
                    ...createVideoDto.processingSettings,
                },
            });
            const savedVideo = await this.videoRepository.save(video);
            // Generate S3 upload URL for direct upload
            const uploadKey = this.cloudFrontService.generateVideoKey(savedVideo.id, undefined, 'original');
            // Update video with S3 information
            await this.videoRepository.update(savedVideo.id, {
                s3Key: uploadKey,
                s3Bucket: this.cloudFrontService['config'].s3Bucket,
                cdnDomain: this.cloudFrontService['config'].distributionDomain,
            });
            this.logger.debug(`Video created successfully: ${savedVideo.id}`);
            return {
                video: savedVideo,
                uploadUrl: `https://${this.cloudFrontService['config'].s3Bucket}.s3.amazonaws.com/${uploadKey}`,
            };
        }
        catch (error) {
            this.logger.error('Failed to create video', error.stack);
            throw error;
        }
    }
    async uploadVideoFile(videoId, file) {
        try {
            this.logger.debug(`Uploading video file for video: ${videoId}`);
            const video = await this.findVideoById(videoId);
            if (video.status !== video_entity_1.VideoStatus.UPLOADING) {
                throw new common_1.BadRequestException('Video is not in uploading state');
            }
            // Upload to CloudFront/S3
            const uploadKey = this.cloudFrontService.generateVideoKey(videoId, undefined, 'original');
            const uploadResult = await this.cloudFrontService.uploadVideo(file.buffer, uploadKey, file.mimetype, {
                'video-id': videoId,
                'original-filename': file.originalname,
            });
            // Update video with upload information
            await this.videoRepository.update(videoId, {
                s3Key: uploadResult.key,
                fileSize: uploadResult.size,
                streamingUrl: uploadResult.cdnUrl,
                metadata: {
                    ...video.metadata,
                    uploadMethod: 'direct',
                    uploadCompletedAt: new Date(),
                },
            });
            // Queue video for processing
            await this.processingService.queueVideoProcessing(videoId, uploadResult.url, video.processingSettings);
            this.logger.debug(`Video file uploaded successfully: ${videoId}`);
        }
        catch (error) {
            this.logger.error(`Failed to upload video file: ${videoId}`, error.stack);
            // Update video status to failed
            await this.videoRepository.update(videoId, {
                status: video_entity_1.VideoStatus.FAILED,
                metadata: {
                    processingErrors: [error.message],
                },
            });
            throw error;
        }
    }
    async getVideoStreamingInfo(videoId, userId, requestInfo) {
        try {
            this.logger.debug(`Getting streaming info for video: ${videoId}`);
            const video = await this.findVideoById(videoId, ['qualityVariants']);
            // Validate access
            const accessResult = await this.securityService.validateVideoAccess({
                videoId,
                userId,
                ...requestInfo,
            });
            if (!accessResult.allowed) {
                throw new common_1.BadRequestException(accessResult.reason);
            }
            // Get quality variants
            const qualities = video.qualityVariants
                .filter(q => q.status === 'completed')
                .map(q => ({
                quality: q.quality,
                url: q.url,
                width: q.width,
                height: q.height,
                bitrate: q.bitrate,
            }));
            // Generate DRM config if needed
            const drmConfig = await this.securityService.generateDRMConfig(video);
            // Generate session ID for analytics
            const sessionId = this.generateSessionId();
            return {
                video,
                streamingUrls: {
                    primary: accessResult.streamingUrl || video.streamingUrl,
                    hls: video.hlsUrl,
                    dash: video.dashUrl,
                    qualities,
                },
                security: {
                    accessToken: accessResult.accessToken,
                    expiresAt: Math.floor(Date.now() / 1000) + 3600,
                    drmConfig,
                },
                analytics: {
                    sessionId,
                    trackingUrl: `/api/video-streaming/analytics/events`,
                },
            };
        }
        catch (error) {
            this.logger.error(`Failed to get streaming info: ${videoId}`, error.stack);
            throw error;
        }
    }
    async findVideoById(videoId, relations = []) {
        const video = await this.videoRepository.findOne({
            where: { id: videoId },
            relations: ['uploadedBy', ...relations],
        });
        if (!video) {
            throw new common_1.NotFoundException('Video not found');
        }
        return video;
    }
    async findVideos(filters = {}, pagination = {}) {
        const { page = 1, limit = 20 } = pagination;
        const skip = (page - 1) * limit;
        const whereClause = {};
        if (filters.status) {
            whereClause.status = filters.status;
        }
        if (filters.visibility) {
            whereClause.visibility = filters.visibility;
        }
        if (filters.uploadedBy) {
            whereClause.uploadedBy = { id: filters.uploadedBy };
        }
        const queryBuilder = this.videoRepository.createQueryBuilder('video')
            .leftJoinAndSelect('video.uploadedBy', 'uploadedBy')
            .leftJoinAndSelect('video.qualityVariants', 'qualityVariants')
            .where(whereClause);
        if (filters.search) {
            queryBuilder.andWhere('(video.title ILIKE :search OR video.description ILIKE :search)', { search: `%${filters.search}%` });
        }
        const [videos, total] = await queryBuilder
            .orderBy('video.createdAt', 'DESC')
            .skip(skip)
            .take(limit)
            .getManyAndCount();
        return { videos, total };
    }
    async updateVideo(videoId, updateData, userId) {
        const video = await this.findVideoById(videoId);
        // Check if user has permission to update
        if (video.uploadedBy.id !== userId) {
            throw new common_1.BadRequestException('You do not have permission to update this video');
        }
        await this.videoRepository.update(videoId, updateData);
        return this.findVideoById(videoId);
    }
    async deleteVideo(videoId, userId) {
        const video = await this.findVideoById(videoId, ['qualityVariants']);
        // Check if user has permission to delete
        if (video.uploadedBy.id !== userId) {
            throw new common_1.BadRequestException('You do not have permission to delete this video');
        }
        try {
            // Delete from CloudFront/S3
            if (video.s3Key) {
                await this.cloudFrontService.deleteVideo(video.s3Key);
            }
            // Delete quality variants from S3
            for (const quality of video.qualityVariants) {
                if (quality.s3Key) {
                    await this.cloudFrontService.deleteVideo(quality.s3Key);
                }
            }
            // Delete from database
            await this.videoRepository.remove(video);
            this.logger.debug(`Video deleted successfully: ${videoId}`);
        }
        catch (error) {
            this.logger.error(`Failed to delete video: ${videoId}`, error.stack);
            throw error;
        }
    }
    async getVideoAnalytics(videoId, userId) {
        const video = await this.findVideoById(videoId);
        // Check if user has permission to view analytics
        if (video.uploadedBy.id !== userId) {
            throw new common_1.BadRequestException('You do not have permission to view analytics for this video');
        }
        const [engagement, performance, geographic, device, quality] = await Promise.all([
            this.analyticsService.getEngagementMetrics(videoId),
            this.analyticsService.getPerformanceMetrics(videoId),
            this.analyticsService.getGeographicMetrics(videoId),
            this.analyticsService.getDeviceMetrics(videoId),
            this.analyticsService.getQualityMetrics(videoId),
        ]);
        return {
            video: {
                id: video.id,
                title: video.title,
                duration: video.duration,
                viewCount: video.viewCount,
                createdAt: video.createdAt,
            },
            engagement,
            performance,
            geographic,
            device,
            quality,
        };
    }
    extractFileExtension(filename) {
        return filename.split('.').pop()?.toLowerCase() || '';
    }
    generateSessionId() {
        return `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }
};
exports.VideoStreamingService = VideoStreamingService;
exports.VideoStreamingService = VideoStreamingService = VideoStreamingService_1 = __decorate([
    (0, common_1.Injectable)(),
    __param(0, (0, typeorm_1.InjectRepository)(video_entity_1.Video)),
    __param(1, (0, typeorm_1.InjectRepository)(video_quality_entity_1.VideoQuality)),
    __param(2, (0, typeorm_1.InjectRepository)(user_entity_1.User)),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _a : Object, typeof (_b = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _b : Object, typeof (_c = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _c : Object, typeof (_d = typeof aws_cloudfront_service_1.AwsCloudFrontService !== "undefined" && aws_cloudfront_service_1.AwsCloudFrontService) === "function" ? _d : Object, typeof (_e = typeof video_processing_service_1.VideoProcessingService !== "undefined" && video_processing_service_1.VideoProcessingService) === "function" ? _e : Object, typeof (_f = typeof video_security_service_1.VideoSecurityService !== "undefined" && video_security_service_1.VideoSecurityService) === "function" ? _f : Object, typeof (_g = typeof video_analytics_service_1.VideoAnalyticsService !== "undefined" && video_analytics_service_1.VideoAnalyticsService) === "function" ? _g : Object])
], VideoStreamingService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxvam9zZXBoXFxEb2N1bWVudHNcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFx2aWRlby1zdHJlYW1pbmdcXHNlcnZpY2VzXFx2aWRlby1zdHJlYW1pbmcuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUE0RjtBQUM1Riw2Q0FBbUQ7QUFDbkQscUNBQXVEO0FBQ3ZELDJEQUErRTtBQUMvRSwyRUFBZ0U7QUFDaEUsa0VBQXdEO0FBRXhELHFFQUFnRTtBQUNoRSx5RUFBb0U7QUFDcEUscUVBQWdFO0FBQ2hFLHVFQUFrRTtBQWtDM0QsSUFBTSxxQkFBcUIsNkJBQTNCLE1BQU0scUJBQXFCO0lBR2hDLFlBRUUsZUFBbUQsRUFFbkQsaUJBQTRELEVBRTVELGNBQWlELEVBQ2hDLGlCQUF1QyxFQUN2QyxpQkFBeUMsRUFDekMsZUFBcUMsRUFDckMsZ0JBQXVDO1FBUnZDLG9CQUFlLEdBQWYsZUFBZSxDQUFtQjtRQUVsQyxzQkFBaUIsR0FBakIsaUJBQWlCLENBQTBCO1FBRTNDLG1CQUFjLEdBQWQsY0FBYyxDQUFrQjtRQUNoQyxzQkFBaUIsR0FBakIsaUJBQWlCLENBQXNCO1FBQ3ZDLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBd0I7UUFDekMsb0JBQWUsR0FBZixlQUFlLENBQXNCO1FBQ3JDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBdUI7UUFaekMsV0FBTSxHQUFHLElBQUksZUFBTSxDQUFDLHVCQUFxQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBYTlELENBQUM7SUFFSixLQUFLLENBQUMsV0FBVyxDQUFDLGNBQThCLEVBQUUsVUFBZ0I7UUFDaEUsSUFBSSxDQUFDO1lBQ0gsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsbUJBQW1CLGNBQWMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1lBRTdELHNCQUFzQjtZQUN0QixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQztnQkFDeEMsR0FBRyxj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SUFEakMsSUFBQSxtQkFBVSxHQUFFO0lBS1IsV0FBQSxJQUFBLDBCQUFnQixFQUFDLG9CQUFLLENBQUMsQ0FBQTtJQUV2QixXQUFBLElBQUEsMEJBQWdCLEVBQUMsbUNBQVksQ0FBQyxDQUFBO0lBRTlCLFdBQUEsSUFBQSwwQkFBZ0IsRUFBQyxrQkFBSSxDQUFDLENBQUE7eURBSFcsb0JBQVUsb0JBQVYsb0JBQVUsb0RBRVIsb0JBQVUsb0JBQVYsb0JBQVUsb0RBRWIsb0JBQVUsb0JBQVYsb0JBQVUsb0RBQ1AsNkNBQW9CLG9CQUFwQiw2Q0FBb0Isb0RBQ3BCLGlEQUFzQixvQkFBdEIsaURBQXNCLG9EQUN4Qiw2Q0FBb0Isb0JBQXBCLDZDQUFvQixvREFDbkIsK0NBQXFCLG9CQUFyQiwrQ0FBcUI7R0FiL0MscUJBQXFCLENBK1ZqQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXG9qb3NlcGhcXERvY3VtZW50c1xcU3RyZWxsZXJNaW5kcy1CYWNrZW5kXFxzcmNcXHZpZGVvLXN0cmVhbWluZ1xcc2VydmljZXNcXHZpZGVvLXN0cmVhbWluZy5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIExvZ2dlciwgTm90Rm91bmRFeGNlcHRpb24sIEJhZFJlcXVlc3RFeGNlcHRpb24gfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XHJcbmltcG9ydCB7IEluamVjdFJlcG9zaXRvcnkgfSBmcm9tICdAbmVzdGpzL3R5cGVvcm0nO1xyXG5pbXBvcnQgeyBSZXBvc2l0b3J5LCBGaW5kT3B0aW9uc1doZXJlIH0gZnJvbSAndHlwZW9ybSc7XHJcbmltcG9ydCB7IFZpZGVvLCBWaWRlb1N0YXR1cywgVmlkZW9WaXNpYmlsaXR5IH0gZnJvbSAnLi4vZW50aXRpZXMvdmlkZW8uZW50aXR5JztcclxuaW1wb3J0IHsgVmlkZW9RdWFsaXR5IH0gZnJvbSAnLi4vZW50aXRpZXMvdmlkZW8tcXVhbGl0eS5lbnRpdHknO1xyXG5pbXBvcnQgeyBVc2VyIH0gZnJvbSAnLi4vLi4vdXNlcnMvZW50aXRpZXMvdXNlci5lbnRpdHknO1xyXG5pbXBvcnQgeyBDcmVhdGVWaWRlb0R0byB9IGZyb20gJy4uL2R0by9jcmVhdGUtdmlkZW8uZHRvJztcclxuaW1wb3J0IHsgQXdzQ2xvdWRGcm9udFNlcnZpY2UgfSBmcm9tICcuL2F3cy1jbG91ZGZyb250LnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBWaWRlb1Byb2Nlc3NpbmdTZXJ2aWNlIH0gZnJvbSAnLi92aWRlby1wcm9jZXNzaW5nLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBWaWRlb1NlY3VyaXR5U2VydmljZSB9IGZyb20gJy4vdmlkZW8tc2VjdXJpdHkuc2VydmljZSc7XHJcbmltcG9ydCB7IFZpZGVvQW5hbHl0aWNzU2VydmljZSB9IGZyb20gJy4vdmlkZW8tYW5hbHl0aWNzLnNlcnZpY2UnO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBWaWRlb1VwbG9hZFJlc3VsdCB7XHJcbiAgdmlkZW86IFZpZGVvO1xyXG4gIHVwbG9hZFVybD86IHN0cmluZztcclxuICB1cGxvYWRGaWVsZHM/OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+O1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFZpZGVvU3RyZWFtaW5nSW5mbyB7XHJcbiAgdmlkZW86IFZpZGVvO1xyXG4gIHN0cmVhbWluZ1VybHM6IHtcclxuICAgIHByaW1hcnk6IHN0cmluZztcclxuICAgIGhscz86IHN0cmluZztcclxuICAgIGRhc2g/OiBzdHJpbmc7XHJcbiAgICBxdWFsaXRpZXM6IEFycmF5PHtcclxuICAgICAgcXVhbGl0eTogc3RyaW5nO1xyXG4gICAgICB1cmw6IHN0cmluZztcclxuICAgICAgd2lkdGg6IG51bWJlcjtcclxuICAgICAgaGVpZ2h0OiBudW1iZXI7XHJcbiAgICAgIGJpdHJhdGU6IG51bWJlcjtcclxuICAgIH0+O1xyXG4gIH07XHJcbiAgc2VjdXJpdHk6IHtcclxuICAgIGFjY2Vzc1Rva2VuOiBzdHJpbmc7XHJcbiAgICBleHBpcmVzQXQ6IG51bWJlcjtcclxuICAgIGRybUNvbmZpZz86IGFueTtcclxuICB9O1xyXG4gIGFuYWx5dGljczoge1xyXG4gICAgc2Vzc2lvbklkOiBzdHJpbmc7XHJcbiAgICB0cmFja2luZ1VybDogc3RyaW5nO1xyXG4gIH07XHJcbn1cclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIFZpZGVvU3RyZWFtaW5nU2VydmljZSB7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKFZpZGVvU3RyZWFtaW5nU2VydmljZS5uYW1lKTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBASW5qZWN0UmVwb3NpdG9yeShWaWRlbylcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgdmlkZW9SZXBvc2l0b3J5OiBSZXBvc2l0b3J5PFZpZGVvPixcclxuICAgIEBJbmplY3RSZXBvc2l0b3J5KFZpZGVvUXVhbGl0eSlcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgcXVhbGl0eVJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8VmlkZW9RdWFsaXR5PixcclxuICAgIEBJbmplY3RSZXBvc2l0b3J5KFVzZXIpXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IHVzZXJSZXBvc2l0b3J5OiBSZXBvc2l0b3J5PFVzZXI+LFxyXG4gICAgcHJpdmF0ZSByZWFkb25seSBjbG91ZEZyb250U2VydmljZTogQXdzQ2xvdWRGcm9udFNlcnZpY2UsXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByb2Nlc3NpbmdTZXJ2aWNlOiBWaWRlb1Byb2Nlc3NpbmdTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSByZWFkb25seSBzZWN1cml0eVNlcnZpY2U6IFZpZGVvU2VjdXJpdHlTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSByZWFkb25seSBhbmFseXRpY3NTZXJ2aWNlOiBWaWRlb0FuYWx5dGljc1NlcnZpY2UsXHJcbiAgKSB7fVxyXG5cclxuICBhc3luYyBjcmVhdGVWaWRlbyhjcmVhdGVWaWRlb0R0bzogQ3JlYXRlVmlkZW9EdG8sIHVwbG9hZGVkQnk6IFVzZXIpOiBQcm9taXNlPFZpZGVvVXBsb2FkUmVzdWx0PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgQ3JlYXRpbmcgdmlkZW86ICR7Y3JlYXRlVmlkZW9EdG8udGl0bGV9YCk7XHJcblxyXG4gICAgICAvLyBDcmVhdGUgdmlkZW8gZW50aXR5XHJcbiAgICAgIGNvbnN0IHZpZGVvID0gdGhpcy52aWRlb1JlcG9zaXRvcnkuY3JlYXRlKHtcclxuICAgICAgICAuLi5jcmVhdGVWaWRlb0R0byxcclxuICAgICAgICB1cGxvYWRlZEJ5LFxyXG4gICAgICAgIHN0YXR1czogVmlkZW9TdGF0dXMuVVBMT0FESU5HLFxyXG4gICAgICAgIHZpc2liaWxpdHk6IGNyZWF0ZVZpZGVvRHRvLnZpc2liaWxpdHkgfHwgVmlkZW9WaXNpYmlsaXR5LlBSSVZBVEUsXHJcbiAgICAgICAgbWV0YWRhdGE6IHtcclxuICAgICAgICAgIG9yaWdpbmFsRm9ybWF0OiB0aGlzLmV4dHJhY3RGaWxlRXh0ZW5zaW9uKGNyZWF0ZVZpZGVvRHRvLm9yaWdpbmFsRmlsZW5hbWUpLFxyXG4gICAgICAgICAgdXBsb2FkTWV0aG9kOiAnZGlyZWN0JyxcclxuICAgICAgICAgIHRhZ3M6IGNyZWF0ZVZpZGVvRHRvLnRhZ3MgfHwgW10sXHJcbiAgICAgICAgICBjaGFwdGVyczogY3JlYXRlVmlkZW9EdG8uY2hhcHRlcnMgfHwgW10sXHJcbiAgICAgICAgICBjdXN0b21EYXRhOiBjcmVhdGVWaWRlb0R0by5jdXN0b21EYXRhIHx8IHt9LFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2VjdXJpdHlTZXR0aW5nczoge1xyXG4gICAgICAgICAgcmVxdWlyZUF1dGg6IHRydWUsXHJcbiAgICAgICAgICBhbGxvd2VkRG9tYWluczogW10sXHJcbiAgICAgICAgICBnZW9SZXN0cmljdGlvbnM6IHt9LFxyXG4gICAgICAgICAgZHJtRW5hYmxlZDogZmFsc2UsXHJcbiAgICAgICAgICBzaWduZWRVcmxFeHBpcnk6IDM2MDAsXHJcbiAgICAgICAgICBkb3dubG9hZEVuYWJsZWQ6IGZhbHNlLFxyXG4gICAgICAgICAgZW1iZWRFbmFibGVkOiBmYWxzZSxcclxuICAgICAgICAgIC4uLmNyZWF0ZVZpZGVvRHRvLnNlY3VyaXR5U2V0dGluZ3MsXHJcbiAgICAgICAgfSxcclxuICAgICAgICBwcm9jZXNzaW5nU2V0dGluZ3M6IHtcclxuICAgICAgICAgIGdlbmVyYXRlVGh1bWJuYWlsczogdHJ1ZSxcclxuICAgICAgICAgIHRodW1ibmFpbENvdW50OiA1LFxyXG4gICAgICAgICAgZ2VuZXJhdGVQcmV2aWV3OiB0cnVlLFxyXG4gICAgICAgICAgYWRhcHRpdmVTdHJlYW1pbmc6IHRydWUsXHJcbiAgICAgICAgICBxdWFsaXR5TGV2ZWxzOiBbJzcyMHAnLCAnNDgwcCcsICczNjBwJ10sXHJcbiAgICAgICAgICAuLi5jcmVhdGVWaWRlb0R0by5wcm9jZXNzaW5nU2V0dGluZ3MsXHJcbiAgICAgICAgfSxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBjb25zdCBzYXZlZFZpZGVvID0gYXdhaXQgdGhpcy52aWRlb1JlcG9zaXRvcnkuc2F2ZSh2aWRlbyk7XHJcblxyXG4gICAgICAvLyBHZW5lcmF0ZSBTMyB1cGxvYWQgVVJMIGZvciBkaXJlY3QgdXBsb2FkXHJcbiAgICAgIGNvbnN0IHVwbG9hZEtleSA9IHRoaXMuY2xvdWRGcm9udFNlcnZpY2UuZ2VuZXJhdGVWaWRlb0tleShzYXZlZFZpZGVvLmlkLCB1bmRlZmluZWQsICdvcmlnaW5hbCcpO1xyXG4gICAgICBcclxuICAgICAgLy8gVXBkYXRlIHZpZGVvIHdpdGggUzMgaW5mb3JtYXRpb25cclxuICAgICAgYXdhaXQgdGhpcy52aWRlb1JlcG9zaXRvcnkudXBkYXRlKHNhdmVkVmlkZW8uaWQsIHtcclxuICAgICAgICBzM0tleTogdXBsb2FkS2V5LFxyXG4gICAgICAgIHMzQnVja2V0OiB0aGlzLmNsb3VkRnJvbnRTZXJ2aWNlWydjb25maWcnXS5zM0J1Y2tldCxcclxuICAgICAgICBjZG5Eb21haW46IHRoaXMuY2xvdWRGcm9udFNlcnZpY2VbJ2NvbmZpZyddLmRpc3RyaWJ1dGlvbkRvbWFpbixcclxuICAgICAgfSk7XHJcblxyXG4gICAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgVmlkZW8gY3JlYXRlZCBzdWNjZXNzZnVsbHk6ICR7c2F2ZWRWaWRlby5pZH1gKTtcclxuXHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgdmlkZW86IHNhdmVkVmlkZW8sXHJcbiAgICAgICAgdXBsb2FkVXJsOiBgaHR0cHM6Ly8ke3RoaXMuY2xvdWRGcm9udFNlcnZpY2VbJ2NvbmZpZyddLnMzQnVja2V0fS5zMy5hbWF6b25hd3MuY29tLyR7dXBsb2FkS2V5fWAsXHJcbiAgICAgIH07XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcignRmFpbGVkIHRvIGNyZWF0ZSB2aWRlbycsIGVycm9yLnN0YWNrKTtcclxuICAgICAgdGhyb3cgZXJyb3I7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhc3luYyB1cGxvYWRWaWRlb0ZpbGUodmlkZW9JZDogc3RyaW5nLCBmaWxlOiBFeHByZXNzLk11bHRlci5GaWxlKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICB0cnkge1xyXG4gICAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgVXBsb2FkaW5nIHZpZGVvIGZpbGUgZm9yIHZpZGVvOiAke3ZpZGVvSWR9YCk7XHJcblxyXG4gICAgICBjb25zdCB2aWRlbyA9IGF3YWl0IHRoaXMuZmluZFZpZGVvQnlJZCh2aWRlb0lkKTtcclxuICAgICAgXHJcbiAgICAgIGlmICh2aWRlby5zdGF0dXMgIT09IFZpZGVvU3RhdHVzLlVQTE9BRElORykge1xyXG4gICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdWaWRlbyBpcyBub3QgaW4gdXBsb2FkaW5nIHN0YXRlJyk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIFVwbG9hZCB0byBDbG91ZEZyb250L1MzXHJcbiAgICAgIGNvbnN0IHVwbG9hZEtleSA9IHRoaXMuY2xvdWRGcm9udFNlcnZpY2UuZ2VuZXJhdGVWaWRlb0tleSh2aWRlb0lkLCB1bmRlZmluZWQsICdvcmlnaW5hbCcpO1xyXG4gICAgICBjb25zdCB1cGxvYWRSZXN1bHQgPSBhd2FpdCB0aGlzLmNsb3VkRnJvbnRTZXJ2aWNlLnVwbG9hZFZpZGVvKFxyXG4gICAgICAgIGZpbGUuYnVmZmVyLFxyXG4gICAgICAgIHVwbG9hZEtleSxcclxuICAgICAgICBmaWxlLm1pbWV0eXBlLFxyXG4gICAgICAgIHtcclxuICAgICAgICAgICd2aWRlby1pZCc6IHZpZGVvSWQsXHJcbiAgICAgICAgICAnb3JpZ2luYWwtZmlsZW5hbWUnOiBmaWxlLm9yaWdpbmFsbmFtZSxcclxuICAgICAgICB9LFxyXG4gICAgICApO1xyXG5cclxuICAgICAgLy8gVXBkYXRlIHZpZGVvIHdpdGggdXBsb2FkIGluZm9ybWF0aW9uXHJcbiAgICAgIGF3YWl0IHRoaXMudmlkZW9SZXBvc2l0b3J5LnVwZGF0ZSh2aWRlb0lkLCB7XHJcbiAgICAgICAgczNLZXk6IHVwbG9hZFJlc3VsdC5rZXksXHJcbiAgICAgICAgZmlsZVNpemU6IHVwbG9hZFJlc3VsdC5zaXplLFxyXG4gICAgICAgIHN0cmVhbWluZ1VybDogdXBsb2FkUmVzdWx0LmNkblVybCxcclxuICAgICAgICBtZXRhZGF0YToge1xyXG4gICAgICAgICAgLi4udmlkZW8ubWV0YWRhdGEsXHJcbiAgICAgICAgICB1cGxvYWRNZXRob2Q6ICdkaXJlY3QnLFxyXG4gICAgICAgICAgdXBsb2FkQ29tcGxldGVkQXQ6IG5ldyBEYXRlKCksXHJcbiAgICAgICAgfSxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICAvLyBRdWV1ZSB2aWRlbyBmb3IgcHJvY2Vzc2luZ1xyXG4gICAgICBhd2FpdCB0aGlzLnByb2Nlc3NpbmdTZXJ2aWNlLnF1ZXVlVmlkZW9Qcm9jZXNzaW5nKFxyXG4gICAgICAgIHZpZGVvSWQsXHJcbiAgICAgICAgdXBsb2FkUmVzdWx0LnVybCxcclxuICAgICAgICB2aWRlby5wcm9jZXNzaW5nU2V0dGluZ3MgYXMgYW55LFxyXG4gICAgICApO1xyXG5cclxuICAgICAgdGhpcy5sb2dnZXIuZGVidWcoYFZpZGVvIGZpbGUgdXBsb2FkZWQgc3VjY2Vzc2Z1bGx5OiAke3ZpZGVvSWR9YCk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihgRmFpbGVkIHRvIHVwbG9hZCB2aWRlbyBmaWxlOiAke3ZpZGVvSWR9YCwgZXJyb3Iuc3RhY2spO1xyXG4gICAgICBcclxuICAgICAgLy8gVXBkYXRlIHZpZGVvIHN0YXR1cyB0byBmYWlsZWRcclxuICAgICAgYXdhaXQgdGhpcy52aWRlb1JlcG9zaXRvcnkudXBkYXRlKHZpZGVvSWQsIHtcclxuICAgICAgICBzdGF0dXM6IFZpZGVvU3RhdHVzLkZBSUxFRCxcclxuICAgICAgICBtZXRhZGF0YToge1xyXG4gICAgICAgICAgcHJvY2Vzc2luZ0Vycm9yczogW2Vycm9yLm1lc3NhZ2VdLFxyXG4gICAgICAgIH0sXHJcbiAgICAgIH0pO1xyXG4gICAgICBcclxuICAgICAgdGhyb3cgZXJyb3I7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhc3luYyBnZXRWaWRlb1N0cmVhbWluZ0luZm8oXHJcbiAgICB2aWRlb0lkOiBzdHJpbmcsXHJcbiAgICB1c2VySWQ/OiBzdHJpbmcsXHJcbiAgICByZXF1ZXN0SW5mbz86IHtcclxuICAgICAgaXBBZGRyZXNzPzogc3RyaW5nO1xyXG4gICAgICB1c2VyQWdlbnQ/OiBzdHJpbmc7XHJcbiAgICAgIHJlZmVycmVyPzogc3RyaW5nO1xyXG4gICAgICBkb21haW4/OiBzdHJpbmc7XHJcbiAgICAgIGNvdW50cnk/OiBzdHJpbmc7XHJcbiAgICB9LFxyXG4gICk6IFByb21pc2U8VmlkZW9TdHJlYW1pbmdJbmZvPiB7XHJcbiAgICB0cnkge1xyXG4gICAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgR2V0dGluZyBzdHJlYW1pbmcgaW5mbyBmb3IgdmlkZW86ICR7dmlkZW9JZH1gKTtcclxuXHJcbiAgICAgIGNvbnN0IHZpZGVvID0gYXdhaXQgdGhpcy5maW5kVmlkZW9CeUlkKHZpZGVvSWQsIFsncXVhbGl0eVZhcmlhbnRzJ10pO1xyXG5cclxuICAgICAgLy8gVmFsaWRhdGUgYWNjZXNzXHJcbiAgICAgIGNvbnN0IGFjY2Vzc1Jlc3VsdCA9IGF3YWl0IHRoaXMuc2VjdXJpdHlTZXJ2aWNlLnZhbGlkYXRlVmlkZW9BY2Nlc3Moe1xyXG4gICAgICAgIHZpZGVvSWQsXHJcbiAgICAgICAgdXNlcklkLFxyXG4gICAgICAgIC4uLnJlcXVlc3RJbmZvLFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGlmICghYWNjZXNzUmVzdWx0LmFsbG93ZWQpIHtcclxuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihhY2Nlc3NSZXN1bHQucmVhc29uKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gR2V0IHF1YWxpdHkgdmFyaWFudHNcclxuICAgICAgY29uc3QgcXVhbGl0aWVzID0gdmlkZW8ucXVhbGl0eVZhcmlhbnRzXHJcbiAgICAgICAgLmZpbHRlcihxID0+IHEuc3RhdHVzID09PSAnY29tcGxldGVkJylcclxuICAgICAgICAubWFwKHEgPT4gKHtcclxuICAgICAgICAgIHF1YWxpdHk6IHEucXVhbGl0eSxcclxuICAgICAgICAgIHVybDogcS51cmwsXHJcbiAgICAgICAgICB3aWR0aDogcS53aWR0aCxcclxuICAgICAgICAgIGhlaWdodDogcS5oZWlnaHQsXHJcbiAgICAgICAgICBiaXRyYXRlOiBxLmJpdHJhdGUsXHJcbiAgICAgICAgfSkpO1xyXG5cclxuICAgICAgLy8gR2VuZXJhdGUgRFJNIGNvbmZpZyBpZiBuZWVkZWRcclxuICAgICAgY29uc3QgZHJtQ29uZmlnID0gYXdhaXQgdGhpcy5zZWN1cml0eVNlcnZpY2UuZ2VuZXJhdGVEUk1Db25maWcodmlkZW8pO1xyXG5cclxuICAgICAgLy8gR2VuZXJhdGUgc2Vzc2lvbiBJRCBmb3IgYW5hbHl0aWNzXHJcbiAgICAgIGNvbnN0IHNlc3Npb25JZCA9IHRoaXMuZ2VuZXJhdGVTZXNzaW9uSWQoKTtcclxuXHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgdmlkZW8sXHJcbiAgICAgICAgc3RyZWFtaW5nVXJsczoge1xyXG4gICAgICAgICAgcHJpbWFyeTogYWNjZXNzUmVzdWx0LnN0cmVhbWluZ1VybCB8fCB2aWRlby5zdHJlYW1pbmdVcmwsXHJcbiAgICAgICAgICBobHM6IHZpZGVvLmhsc1VybCxcclxuICAgICAgICAgIGRhc2g6IHZpZGVvLmRhc2hVcmwsXHJcbiAgICAgICAgICBxdWFsaXRpZXMsXHJcbiAgICAgICAgfSxcclxuICAgICAgICBzZWN1cml0eToge1xyXG4gICAgICAgICAgYWNjZXNzVG9rZW46IGFjY2Vzc1Jlc3VsdC5hY2Nlc3NUb2tlbiEsXHJcbiAgICAgICAgICBleHBpcmVzQXQ6IE1hdGguZmxvb3IoRGF0ZS5ub3coKSAvIDEwMDApICsgMzYwMCxcclxuICAgICAgICAgIGRybUNvbmZpZyxcclxuICAgICAgICB9LFxyXG4gICAgICAgIGFuYWx5dGljczoge1xyXG4gICAgICAgICAgc2Vzc2lvbklkLFxyXG4gICAgICAgICAgdHJhY2tpbmdVcmw6IGAvYXBpL3ZpZGVvLXN0cmVhbWluZy9hbmFseXRpY3MvZXZlbnRzYCxcclxuICAgICAgICB9LFxyXG4gICAgICB9O1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoYEZhaWxlZCB0byBnZXQgc3RyZWFtaW5nIGluZm86ICR7dmlkZW9JZH1gLCBlcnJvci5zdGFjayk7XHJcbiAgICAgIHRocm93IGVycm9yO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgZmluZFZpZGVvQnlJZCh2aWRlb0lkOiBzdHJpbmcsIHJlbGF0aW9uczogc3RyaW5nW10gPSBbXSk6IFByb21pc2U8VmlkZW8+IHtcclxuICAgIGNvbnN0IHZpZGVvID0gYXdhaXQgdGhpcy52aWRlb1JlcG9zaXRvcnkuZmluZE9uZSh7XHJcbiAgICAgIHdoZXJlOiB7IGlkOiB2aWRlb0lkIH0sXHJcbiAgICAgIHJlbGF0aW9uczogWyd1cGxvYWRlZEJ5JywgLi4ucmVsYXRpb25zXSxcclxuICAgIH0pO1xyXG5cclxuICAgIGlmICghdmlkZW8pIHtcclxuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdWaWRlbyBub3QgZm91bmQnKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdmlkZW87XHJcbiAgfVxyXG5cclxuICBhc3luYyBmaW5kVmlkZW9zKFxyXG4gICAgZmlsdGVyczoge1xyXG4gICAgICBzdGF0dXM/OiBWaWRlb1N0YXR1cztcclxuICAgICAgdmlzaWJpbGl0eT86IFZpZGVvVmlzaWJpbGl0eTtcclxuICAgICAgdXBsb2FkZWRCeT86IHN0cmluZztcclxuICAgICAgc2VhcmNoPzogc3RyaW5nO1xyXG4gICAgfSA9IHt9LFxyXG4gICAgcGFnaW5hdGlvbjoge1xyXG4gICAgICBwYWdlPzogbnVtYmVyO1xyXG4gICAgICBsaW1pdD86IG51bWJlcjtcclxuICAgIH0gPSB7fSxcclxuICApOiBQcm9taXNlPHsgdmlkZW9zOiBWaWRlb1tdOyB0b3RhbDogbnVtYmVyIH0+IHtcclxuICAgIGNvbnN0IHsgcGFnZSA9IDEsIGxpbWl0ID0gMjAgfSA9IHBhZ2luYXRpb247XHJcbiAgICBjb25zdCBza2lwID0gKHBhZ2UgLSAxKSAqIGxpbWl0O1xyXG5cclxuICAgIGNvbnN0IHdoZXJlQ2xhdXNlOiBGaW5kT3B0aW9uc1doZXJlPFZpZGVvPiA9IHt9O1xyXG5cclxuICAgIGlmIChmaWx0ZXJzLnN0YXR1cykge1xyXG4gICAgICB3aGVyZUNsYXVzZS5zdGF0dXMgPSBmaWx0ZXJzLnN0YXR1cztcclxuICAgIH1cclxuXHJcbiAgICBpZiAoZmlsdGVycy52aXNpYmlsaXR5KSB7XHJcbiAgICAgIHdoZXJlQ2xhdXNlLnZpc2liaWxpdHkgPSBmaWx0ZXJzLnZpc2liaWxpdHk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGZpbHRlcnMudXBsb2FkZWRCeSkge1xyXG4gICAgICB3aGVyZUNsYXVzZS51cGxvYWRlZEJ5ID0geyBpZDogZmlsdGVycy51cGxvYWRlZEJ5IH07XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgcXVlcnlCdWlsZGVyID0gdGhpcy52aWRlb1JlcG9zaXRvcnkuY3JlYXRlUXVlcnlCdWlsZGVyKCd2aWRlbycpXHJcbiAgICAgIC5sZWZ0Sm9pbkFuZFNlbGVjdCgndmlkZW8udXBsb2FkZWRCeScsICd1cGxvYWRlZEJ5JylcclxuICAgICAgLmxlZnRKb2luQW5kU2VsZWN0KCd2aWRlby5xdWFsaXR5VmFyaWFudHMnLCAncXVhbGl0eVZhcmlhbnRzJylcclxuICAgICAgLndoZXJlKHdoZXJlQ2xhdXNlKTtcclxuXHJcbiAgICBpZiAoZmlsdGVycy5zZWFyY2gpIHtcclxuICAgICAgcXVlcnlCdWlsZGVyLmFuZFdoZXJlKFxyXG4gICAgICAgICcodmlkZW8udGl0bGUgSUxJS0UgOnNlYXJjaCBPUiB2aWRlby5kZXNjcmlwdGlvbiBJTElLRSA6c2VhcmNoKScsXHJcbiAgICAgICAgeyBzZWFyY2g6IGAlJHtmaWx0ZXJzLnNlYXJjaH0lYCB9LFxyXG4gICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IFt2aWRlb3MsIHRvdGFsXSA9IGF3YWl0IHF1ZXJ5QnVpbGRlclxyXG4gICAgICAub3JkZXJCeSgndmlkZW8uY3JlYXRlZEF0JywgJ0RFU0MnKVxyXG4gICAgICAuc2tpcChza2lwKVxyXG4gICAgICAudGFrZShsaW1pdClcclxuICAgICAgLmdldE1hbnlBbmRDb3VudCgpO1xyXG5cclxuICAgIHJldHVybiB7IHZpZGVvcywgdG90YWwgfTtcclxuICB9XHJcblxyXG4gIGFzeW5jIHVwZGF0ZVZpZGVvKFxyXG4gICAgdmlkZW9JZDogc3RyaW5nLFxyXG4gICAgdXBkYXRlRGF0YTogUGFydGlhbDxWaWRlbz4sXHJcbiAgICB1c2VySWQ6IHN0cmluZyxcclxuICApOiBQcm9taXNlPFZpZGVvPiB7XHJcbiAgICBjb25zdCB2aWRlbyA9IGF3YWl0IHRoaXMuZmluZFZpZGVvQnlJZCh2aWRlb0lkKTtcclxuXHJcbiAgICAvLyBDaGVjayBpZiB1c2VyIGhhcyBwZXJtaXNzaW9uIHRvIHVwZGF0ZVxyXG4gICAgaWYgKHZpZGVvLnVwbG9hZGVkQnkuaWQgIT09IHVzZXJJZCkge1xyXG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignWW91IGRvIG5vdCBoYXZlIHBlcm1pc3Npb24gdG8gdXBkYXRlIHRoaXMgdmlkZW8nKTtcclxuICAgIH1cclxuXHJcbiAgICBhd2FpdCB0aGlzLnZpZGVvUmVwb3NpdG9yeS51cGRhdGUodmlkZW9JZCwgdXBkYXRlRGF0YSk7XHJcbiAgICByZXR1cm4gdGhpcy5maW5kVmlkZW9CeUlkKHZpZGVvSWQpO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgZGVsZXRlVmlkZW8odmlkZW9JZDogc3RyaW5nLCB1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgY29uc3QgdmlkZW8gPSBhd2FpdCB0aGlzLmZpbmRWaWRlb0J5SWQodmlkZW9JZCwgWydxdWFsaXR5VmFyaWFudHMnXSk7XHJcblxyXG4gICAgLy8gQ2hlY2sgaWYgdXNlciBoYXMgcGVybWlzc2lvbiB0byBkZWxldGVcclxuICAgIGlmICh2aWRlby51cGxvYWRlZEJ5LmlkICE9PSB1c2VySWQpIHtcclxuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ1lvdSBkbyBub3QgaGF2ZSBwZXJtaXNzaW9uIHRvIGRlbGV0ZSB0aGlzIHZpZGVvJyk7XHJcbiAgICB9XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgLy8gRGVsZXRlIGZyb20gQ2xvdWRGcm9udC9TM1xyXG4gICAgICBpZiAodmlkZW8uczNLZXkpIHtcclxuICAgICAgICBhd2FpdCB0aGlzLmNsb3VkRnJvbnRTZXJ2aWNlLmRlbGV0ZVZpZGVvKHZpZGVvLnMzS2V5KTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gRGVsZXRlIHF1YWxpdHkgdmFyaWFudHMgZnJvbSBTM1xyXG4gICAgICBmb3IgKGNvbnN0IHF1YWxpdHkgb2YgdmlkZW8ucXVhbGl0eVZhcmlhbnRzKSB7XHJcbiAgICAgICAgaWYgKHF1YWxpdHkuczNLZXkpIHtcclxuICAgICAgICAgIGF3YWl0IHRoaXMuY2xvdWRGcm9udFNlcnZpY2UuZGVsZXRlVmlkZW8ocXVhbGl0eS5zM0tleSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBEZWxldGUgZnJvbSBkYXRhYmFzZVxyXG4gICAgICBhd2FpdCB0aGlzLnZpZGVvUmVwb3NpdG9yeS5yZW1vdmUodmlkZW8pO1xyXG5cclxuICAgICAgdGhpcy5sb2dnZXIuZGVidWcoYFZpZGVvIGRlbGV0ZWQgc3VjY2Vzc2Z1bGx5OiAke3ZpZGVvSWR9YCk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihgRmFpbGVkIHRvIGRlbGV0ZSB2aWRlbzogJHt2aWRlb0lkfWAsIGVycm9yLnN0YWNrKTtcclxuICAgICAgdGhyb3cgZXJyb3I7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhc3luYyBnZXRWaWRlb0FuYWx5dGljcyh2aWRlb0lkOiBzdHJpbmcsIHVzZXJJZDogc3RyaW5nKSB7XHJcbiAgICBjb25zdCB2aWRlbyA9IGF3YWl0IHRoaXMuZmluZFZpZGVvQnlJZCh2aWRlb0lkKTtcclxuXHJcbiAgICAvLyBDaGVjayBpZiB1c2VyIGhhcyBwZXJtaXNzaW9uIHRvIHZpZXcgYW5hbHl0aWNzXHJcbiAgICBpZiAodmlkZW8udXBsb2FkZWRCeS5pZCAhPT0gdXNlcklkKSB7XHJcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdZb3UgZG8gbm90IGhhdmUgcGVybWlzc2lvbiB0byB2aWV3IGFuYWx5dGljcyBmb3IgdGhpcyB2aWRlbycpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IFtlbmdhZ2VtZW50LCBwZXJmb3JtYW5jZSwgZ2VvZ3JhcGhpYywgZGV2aWNlLCBxdWFsaXR5XSA9IGF3YWl0IFByb21pc2UuYWxsKFtcclxuICAgICAgdGhpcy5hbmFseXRpY3NTZXJ2aWNlLmdldEVuZ2FnZW1lbnRNZXRyaWNzKHZpZGVvSWQpLFxyXG4gICAgICB0aGlzLmFuYWx5dGljc1NlcnZpY2UuZ2V0UGVyZm9ybWFuY2VNZXRyaWNzKHZpZGVvSWQpLFxyXG4gICAgICB0aGlzLmFuYWx5dGljc1NlcnZpY2UuZ2V0R2VvZ3JhcGhpY01ldHJpY3ModmlkZW9JZCksXHJcbiAgICAgIHRoaXMuYW5hbHl0aWNzU2VydmljZS5nZXREZXZpY2VNZXRyaWNzKHZpZGVvSWQpLFxyXG4gICAgICB0aGlzLmFuYWx5dGljc1NlcnZpY2UuZ2V0UXVhbGl0eU1ldHJpY3ModmlkZW9JZCksXHJcbiAgICBdKTtcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICB2aWRlbzoge1xyXG4gICAgICAgIGlkOiB2aWRlby5pZCxcclxuICAgICAgICB0aXRsZTogdmlkZW8udGl0bGUsXHJcbiAgICAgICAgZHVyYXRpb246IHZpZGVvLmR1cmF0aW9uLFxyXG4gICAgICAgIHZpZXdDb3VudDogdmlkZW8udmlld0NvdW50LFxyXG4gICAgICAgIGNyZWF0ZWRBdDogdmlkZW8uY3JlYXRlZEF0LFxyXG4gICAgICB9LFxyXG4gICAgICBlbmdhZ2VtZW50LFxyXG4gICAgICBwZXJmb3JtYW5jZSxcclxuICAgICAgZ2VvZ3JhcGhpYyxcclxuICAgICAgZGV2aWNlLFxyXG4gICAgICBxdWFsaXR5LFxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZXh0cmFjdEZpbGVFeHRlbnNpb24oZmlsZW5hbWU6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gZmlsZW5hbWUuc3BsaXQoJy4nKS5wb3AoKT8udG9Mb3dlckNhc2UoKSB8fCAnJztcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2VuZXJhdGVTZXNzaW9uSWQoKTogc3RyaW5nIHtcclxuICAgIHJldHVybiBgc2Vzc2lvbl8ke0RhdGUubm93KCl9XyR7TWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsIDkpfWA7XHJcbiAgfVxyXG59XHJcbiJdLCJ2ZXJzaW9uIjozfQ==