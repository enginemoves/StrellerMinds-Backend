0d5e1031bbb130cf4856349e08ff0fdd
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var RealtimeAnalyticsService_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.RealtimeAnalyticsService = void 0;
const common_1 = require("@nestjs/common");
const common_2 = require("@nestjs/common");
const cache_manager_1 = require("@nestjs/cache-manager");
const typeorm_1 = require("typeorm");
let RealtimeAnalyticsService = RealtimeAnalyticsService_1 = class RealtimeAnalyticsService {
    constructor(userInteractionRepository, courseRepository, userRepository, cacheManager) {
        this.userInteractionRepository = userInteractionRepository;
        this.courseRepository = courseRepository;
        this.userRepository = userRepository;
        this.cacheManager = cacheManager;
        this.logger = new common_1.Logger(RealtimeAnalyticsService_1.name);
        this.REALTIME_CACHE_TTL = 10; // seconds
    }
    async getRealtimeDashboardData() {
        const cacheKey = "realtime_dashboard_data";
        const cachedData = await this.cacheManager.get(cacheKey);
        if (cachedData) {
            return cachedData;
        }
        const now = new Date();
        const fiveMinutesAgo = new Date(now.getTime() - 5 * 60 * 1000); // Last 5 minutes
        // Active users (simplified: users with recent interactions)
        const activeInteractions = await this.userInteractionRepository.find({
            where: {
                updatedAt: (0, typeorm_1.MoreThanOrEqual)(fiveMinutesAgo),
            },
            relations: ["user", "course"],
        });
        const activeUsersNow = new Set(activeInteractions.map((i) => i.userId)).size;
        // Courses being viewed
        const coursesBeingViewedMap = new Map();
        activeInteractions.forEach((interaction) => {
            if (interaction.course) {
                const courseEntry = coursesBeingViewedMap.get(interaction.courseId) || {
                    courseId: interaction.courseId,
                    title: interaction.course.title,
                    viewers: 0,
                };
                courseEntry.viewers++;
                coursesBeingViewedMap.set(interaction.courseId, courseEntry);
            }
        });
        const coursesBeingViewed = Array.from(coursesBeingViewedMap.values()).sort((a, b) => b.viewers - a.viewers);
        // Recent enrollments (last 5 minutes)
        const recentEnrollments = await this.userInteractionRepository.find({
            where: {
                createdAt: (0, typeorm_1.MoreThanOrEqual)(fiveMinutesAgo),
                progress: 0, // Assuming new enrollment starts at 0 progress
            },
            relations: ["user", "course"],
            order: { createdAt: "DESC" },
            take: 10,
        });
        const formattedRecentEnrollments = recentEnrollments.map((i) => ({
            userId: i.userId,
            courseId: i.courseId,
            timestamp: i.createdAt,
            userName: i.user?.username || "N/A",
            courseTitle: i.course?.title || "N/A",
        }));
        // Recent completions (last 5 minutes)
        const recentCompletions = await this.userInteractionRepository.find({
            where: {
                updatedAt: (0, typeorm_1.MoreThanOrEqual)(fiveMinutesAgo),
                completed: true,
            },
            relations: ["user", "course"],
            order: { updatedAt: "DESC" },
            take: 10,
        });
        const formattedRecentCompletions = recentCompletions.map((i) => ({
            userId: i.userId,
            courseId: i.courseId,
            timestamp: i.updatedAt,
            userName: i.user?.username || "N/A",
            courseTitle: i.course?.title || "N/A",
        }));
        // Overall activity rate (simplified: total interactions in last minute)
        const oneMinuteAgo = new Date(now.getTime() - 60 * 1000);
        const recentInteractionsCount = await this.userInteractionRepository.count({
            where: {
                updatedAt: (0, typeorm_1.MoreThanOrEqual)(oneMinuteAgo),
            },
        });
        const overallActivityRate = recentInteractionsCount / 60; // Interactions per second
        const data = {
            activeUsersNow,
            coursesBeingViewed,
            recentEnrollments: formattedRecentEnrollments,
            recentCompletions: formattedRecentCompletions,
            overallActivityRate,
        };
        await this.cacheManager.set(cacheKey, data, this.REALTIME_CACHE_TTL);
        return data;
    }
};
exports.RealtimeAnalyticsService = RealtimeAnalyticsService;
exports.RealtimeAnalyticsService = RealtimeAnalyticsService = RealtimeAnalyticsService_1 = __decorate([
    (0, common_1.Injectable)(),
    __param(3, (0, common_2.Inject)(cache_manager_1.CACHE_MANAGER)),
    __metadata("design:paramtypes", [Object, Object, Object, Object])
], RealtimeAnalyticsService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxvam9zZXBoXFxEb2N1bWVudHNcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFxhbmFseXRpY3Mtc3lzdGVtXFxzZXJ2aWNlc1xccmVhbHRpbWUtYW5hbHl0aWNzLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUFtRDtBQU9uRCwyQ0FBdUM7QUFDdkMseURBQXFEO0FBQ3JELHFDQUF5QztBQUdsQyxJQUFNLHdCQUF3QixnQ0FBOUIsTUFBTSx3QkFBd0I7SUFJbkMsWUFDbUIseUJBQTRELEVBQzVELGdCQUFvQyxFQUNwQyxjQUFnQyxFQUMxQixZQUEyQjtRQUhqQyw4QkFBeUIsR0FBekIseUJBQXlCLENBQW1DO1FBQzVELHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBb0I7UUFDcEMsbUJBQWMsR0FBZCxjQUFjLENBQWtCO1FBQ2xCLGlCQUFZLEdBQVosWUFBWSxDQUFPO1FBUG5DLFdBQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQywwQkFBd0IsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUNsRCx1QkFBa0IsR0FBRyxFQUFFLENBQUMsQ0FBQyxVQUFVO0lBT2pELENBQUM7SUFFSixLQUFLLENBQUMsd0JBQXdCO1FBQzVCLE1BQU0sUUFBUSxHQUFHLHlCQUF5QixDQUFBO1FBQzFDLE1BQU0sVUFBVSxHQUFHLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQXdCLFFBQVEsQ0FBQyxDQUFBO1FBQy9FLElBQUksVUFBVSxFQUFFLENBQUM7WUFDZixPQUFPLFVBQVUsQ0FBQTtRQUNuQixDQUFDO1FBRUQsTUFBTSxHQUFHLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQTtRQUN0QixNQUFNLGNBQWMsR0FBRyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQSxDQUFDLGlCQUFpQjtRQUVoRiw0REFBNEQ7UUFDNUQsTUFBTSxrQkFBa0IsR0FBRyxNQUFNLElB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VXNlcnNcXG9qb3NlcGhcXERvY3VtZW50c1xcU3RyZWxsZXJNaW5kcy1CYWNrZW5kXFxzcmNcXGFuYWx5dGljcy1zeXN0ZW1cXHNlcnZpY2VzXFxyZWFsdGltZS1hbmFseXRpY3Muc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBMb2dnZXIgfSBmcm9tIFwiQG5lc3Rqcy9jb21tb25cIlxyXG5pbXBvcnQgdHlwZSB7IFJlcG9zaXRvcnkgfSBmcm9tIFwidHlwZW9ybVwiXHJcbmltcG9ydCB0eXBlIHsgVXNlckNvdXJzZUludGVyYWN0aW9uIH0gZnJvbSBcIi4uLy4uL3VzZXJzL2VudGl0aWVzL3VzZXItY291cnNlLWludGVyYWN0aW9uLmVudGl0eVwiXHJcbmltcG9ydCB0eXBlIHsgQ291cnNlIH0gZnJvbSBcIi4uLy4uL2NvdXJzZXMvZW50aXRpZXMvY291cnNlLmVudGl0eVwiXHJcbmltcG9ydCB0eXBlIHsgVXNlciB9IGZyb20gXCIuLi8uLi91c2Vycy9lbnRpdGllcy91c2VyLmVudGl0eVwiXHJcbmltcG9ydCB0eXBlIHsgUmVhbHRpbWVEYXNoYm9hcmREYXRhIH0gZnJvbSBcIi4uL2ludGVyZmFjZXMvYW5hbHl0aWNzLmludGVyZmFjZVwiXHJcbmltcG9ydCB0eXBlIHsgQ2FjaGUgfSBmcm9tIFwiY2FjaGUtbWFuYWdlclwiXHJcbmltcG9ydCB7IEluamVjdCB9IGZyb20gXCJAbmVzdGpzL2NvbW1vblwiXHJcbmltcG9ydCB7IENBQ0hFX01BTkFHRVIgfSBmcm9tIFwiQG5lc3Rqcy9jYWNoZS1tYW5hZ2VyXCJcclxuaW1wb3J0IHsgTW9yZVRoYW5PckVxdWFsIH0gZnJvbSBcInR5cGVvcm1cIlxyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgUmVhbHRpbWVBbmFseXRpY3NTZXJ2aWNlIHtcclxuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIoUmVhbHRpbWVBbmFseXRpY3NTZXJ2aWNlLm5hbWUpXHJcbiAgcHJpdmF0ZSByZWFkb25seSBSRUFMVElNRV9DQUNIRV9UVEwgPSAxMDsgLy8gc2Vjb25kc1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgdXNlckludGVyYWN0aW9uUmVwb3NpdG9yeTogUmVwb3NpdG9yeTxVc2VyQ291cnNlSW50ZXJhY3Rpb24+LFxyXG4gICAgcHJpdmF0ZSByZWFkb25seSBjb3Vyc2VSZXBvc2l0b3J5OiBSZXBvc2l0b3J5PENvdXJzZT4sXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IHVzZXJSZXBvc2l0b3J5OiBSZXBvc2l0b3J5PFVzZXI+LFxyXG4gICAgQEluamVjdChDQUNIRV9NQU5BR0VSKSBwcml2YXRlIGNhY2hlTWFuYWdlcjogQ2FjaGUsXHJcbiAgKSB7fVxyXG5cclxuICBhc3luYyBnZXRSZWFsdGltZURhc2hib2FyZERhdGEoKTogUHJvbWlzZTxSZWFsdGltZURhc2hib2FyZERhdGE+IHtcclxuICAgIGNvbnN0IGNhY2hlS2V5ID0gXCJyZWFsdGltZV9kYXNoYm9hcmRfZGF0YVwiXHJcbiAgICBjb25zdCBjYWNoZWREYXRhID0gYXdhaXQgdGhpcy5jYWNoZU1hbmFnZXIuZ2V0PFJlYWx0aW1lRGFzaGJvYXJkRGF0YT4oY2FjaGVLZXkpXHJcbiAgICBpZiAoY2FjaGVkRGF0YSkge1xyXG4gICAgICByZXR1cm4gY2FjaGVkRGF0YVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKClcclxuICAgIGNvbnN0IGZpdmVNaW51dGVzQWdvID0gbmV3IERhdGUobm93LmdldFRpbWUoKSAtIDUgKiA2MCAqIDEwMDApIC8vIExhc3QgNSBtaW51dGVzXHJcblxyXG4gICAgLy8gQWN0aXZlIHVzZXJzIChzaW1wbGlmaWVkOiB1c2VycyB3aXRoIHJlY2VudCBpbnRlcmFjdGlvbnMpXHJcbiAgICBjb25zdCBhY3RpdmVJbnRlcmFjdGlvbnMgPSBhd2FpdCB0aGlzLnVzZXJJbnRlcmFjdGlvblJlcG9zaXRvcnkuZmluZCh7XHJcbiAgICAgIHdoZXJlOiB7XHJcbiAgICAgICAgdXBkYXRlZEF0OiBNb3JlVGhhbk9yRXF1YWwoZml2ZU1pbnV0ZXNBZ28pLFxyXG4gICAgICB9LFxyXG4gICAgICByZWxhdGlvbnM6IFtcInVzZXJcIiwgXCJjb3Vyc2VcIl0sXHJcbiAgICB9KVxyXG4gICAgY29uc3QgYWN0aXZlVXNlcnNOb3cgPSBuZXcgU2V0KGFjdGl2ZUludGVyYWN0aW9ucy5tYXAoKGkpID0+IGkudXNlcklkKSkuc2l6ZVxyXG5cclxuICAgIC8vIENvdXJzZXMgYmVpbmcgdmlld2VkXHJcbiAgICBjb25zdCBjb3Vyc2VzQmVpbmdWaWV3ZWRNYXAgPSBuZXcgTWFwPHN0cmluZywgeyBjb3Vyc2VJZDogc3RyaW5nOyB0aXRsZTogc3RyaW5nOyB2aWV3ZXJzOiBudW1iZXIgfT4oKVxyXG4gICAgYWN0aXZlSW50ZXJhY3Rpb25zLmZvckVhY2goKGludGVyYWN0aW9uKSA9PiB7XHJcbiAgICAgIGlmIChpbnRlcmFjdGlvbi5jb3Vyc2UpIHtcclxuICAgICAgICBjb25zdCBjb3Vyc2VFbnRyeSA9IGNvdXJzZXNCZWluZ1ZpZXdlZE1hcC5nZXQoaW50ZXJhY3Rpb24uY291cnNlSWQpIHx8IHtcclxuICAgICAgICAgIGNvdXJzZUlkOiBpbnRlcmFjdGlvbi5jb3Vyc2VJZCxcclxuICAgICAgICAgIHRpdGxlOiBpbnRlcmFjdGlvbi5jb3Vyc2UudGl0bGUsXHJcbiAgICAgICAgICB2aWV3ZXJzOiAwLFxyXG4gICAgICAgIH1cclxuICAgICAgICBjb3Vyc2VFbnRyeS52aWV3ZXJzKytcclxuICAgICAgICBjb3Vyc2VzQmVpbmdWaWV3ZWRNYXAuc2V0KGludGVyYWN0aW9uLmNvdXJzZUlkLCBjb3Vyc2VFbnRyeSlcclxuICAgICAgfVxyXG4gICAgfSlcclxuICAgIGNvbnN0IGNvdXJzZXNCZWluZ1ZpZXdlZCA9IEFycmF5LmZyb20oY291cnNlc0JlaW5nVmlld2VkTWFwLnZhbHVlcygpKS5zb3J0KChhLCBiKSA9PiBiLnZpZXdlcnMgLSBhLnZpZXdlcnMpXHJcblxyXG4gICAgLy8gUmVjZW50IGVucm9sbG1lbnRzIChsYXN0IDUgbWludXRlcylcclxuICAgIGNvbnN0IHJlY2VudEVucm9sbG1lbnRzID0gYXdhaXQgdGhpcy51c2VySW50ZXJhY3Rpb25SZXBvc2l0b3J5LmZpbmQoe1xyXG4gICAgICB3aGVyZToge1xyXG4gICAgICAgIGNyZWF0ZWRBdDogTW9yZVRoYW5PckVxdWFsKGZpdmVNaW51dGVzQWdvKSxcclxuICAgICAgICBwcm9ncmVzczogMCwgLy8gQXNzdW1pbmcgbmV3IGVucm9sbG1lbnQgc3RhcnRzIGF0IDAgcHJvZ3Jlc3NcclxuICAgICAgfSxcclxuICAgICAgcmVsYXRpb25zOiBbXCJ1c2VyXCIsIFwiY291cnNlXCJdLFxyXG4gICAgICBvcmRlcjogeyBjcmVhdGVkQXQ6IFwiREVTQ1wiIH0sXHJcbiAgICAgIHRha2U6IDEwLFxyXG4gICAgfSlcclxuICAgIGNvbnN0IGZvcm1hdHRlZFJlY2VudEVucm9sbG1lbnRzID0gcmVjZW50RW5yb2xsbWVudHMubWFwKChpKSA9PiAoe1xyXG4gICAgICB1c2VySWQ6IGkudXNlcklkLFxyXG4gICAgICBjb3Vyc2VJZDogaS5jb3Vyc2VJZCxcclxuICAgICAgdGltZXN0YW1wOiBpLmNyZWF0ZWRBdCxcclxuICAgICAgdXNlck5hbWU6IGkudXNlcj8udXNlcm5hbWUgfHwgXCJOL0FcIixcclxuICAgICAgY291cnNlVGl0bGU6IGkuY291cnNlPy50aXRsZSB8fCBcIk4vQVwiLFxyXG4gICAgfSkpXHJcblxyXG4gICAgLy8gUmVjZW50IGNvbXBsZXRpb25zIChsYXN0IDUgbWludXRlcylcclxuICAgIGNvbnN0IHJlY2VudENvbXBsZXRpb25zID0gYXdhaXQgdGhpcy51c2VySW50ZXJhY3Rpb25SZXBvc2l0b3J5LmZpbmQoe1xyXG4gICAgICB3aGVyZToge1xyXG4gICAgICAgIHVwZGF0ZWRBdDogTW9yZVRoYW5PckVxdWFsKGZpdmVNaW51dGVzQWdvKSxcclxuICAgICAgICBjb21wbGV0ZWQ6IHRydWUsXHJcbiAgICAgIH0sXHJcbiAgICAgIHJlbGF0aW9uczogW1widXNlclwiLCBcImNvdXJzZVwiXSxcclxuICAgICAgb3JkZXI6IHsgdXBkYXRlZEF0OiBcIkRFU0NcIiB9LFxyXG4gICAgICB0YWtlOiAxMCxcclxuICAgIH0pXHJcbiAgICBjb25zdCBmb3JtYXR0ZWRSZWNlbnRDb21wbGV0aW9ucyA9IHJlY2VudENvbXBsZXRpb25zLm1hcCgoaSkgPT4gKHtcclxuICAgICAgdXNlcklkOiBpLnVzZXJJZCxcclxuICAgICAgY291cnNlSWQ6IGkuY291cnNlSWQsXHJcbiAgICAgIHRpbWVzdGFtcDogaS51cGRhdGVkQXQsXHJcbiAgICAgIHVzZXJOYW1lOiBpLnVzZXI/LnVzZXJuYW1lIHx8IFwiTi9BXCIsXHJcbiAgICAgIGNvdXJzZVRpdGxlOiBpLmNvdXJzZT8udGl0bGUgfHwgXCJOL0FcIixcclxuICAgIH0pKVxyXG5cclxuICAgIC8vIE92ZXJhbGwgYWN0aXZpdHkgcmF0ZSAoc2ltcGxpZmllZDogdG90YWwgaW50ZXJhY3Rpb25zIGluIGxhc3QgbWludXRlKVxyXG4gICAgY29uc3Qgb25lTWludXRlQWdvID0gbmV3IERhdGUobm93LmdldFRpbWUoKSAtIDYwICogMTAwMClcclxuICAgIGNvbnN0IHJlY2VudEludGVyYWN0aW9uc0NvdW50ID0gYXdhaXQgdGhpcy51c2VySW50ZXJhY3Rpb25SZXBvc2l0b3J5LmNvdW50KHtcclxuICAgICAgd2hlcmU6IHtcclxuICAgICAgICB1cGRhdGVkQXQ6IE1vcmVUaGFuT3JFcXVhbChvbmVNaW51dGVBZ28pLFxyXG4gICAgICB9LFxyXG4gICAgfSlcclxuICAgIGNvbnN0IG92ZXJhbGxBY3Rpdml0eVJhdGUgPSByZWNlbnRJbnRlcmFjdGlvbnNDb3VudCAvIDYwIC8vIEludGVyYWN0aW9ucyBwZXIgc2Vjb25kXHJcblxyXG4gICAgY29uc3QgZGF0YTogUmVhbHRpbWVEYXNoYm9hcmREYXRhID0ge1xyXG4gICAgICBhY3RpdmVVc2Vyc05vdyxcclxuICAgICAgY291cnNlc0JlaW5nVmlld2VkLFxyXG4gICAgICByZWNlbnRFbnJvbGxtZW50czogZm9ybWF0dGVkUmVjZW50RW5yb2xsbWVudHMsXHJcbiAgICAgIHJlY2VudENvbXBsZXRpb25zOiBmb3JtYXR0ZWRSZWNlbnRDb21wbGV0aW9ucyxcclxuICAgICAgb3ZlcmFsbEFjdGl2aXR5UmF0ZSxcclxuICAgIH1cclxuXHJcbiAgICBhd2FpdCB0aGlzLmNhY2hlTWFuYWdlci5zZXQoY2FjaGVLZXksIGRhdGEsIHRoaXMuUkVBTFRJTUVfQ0FDSEVfVFRMKVxyXG4gICAgcmV0dXJuIGRhdGFcclxuICB9XHJcbn1cclxuIl0sInZlcnNpb24iOjN9