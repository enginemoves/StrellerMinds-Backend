1eda092693ee310b4c8794cf2624e39e
"use strict";
// // import { Injectable, Logger } from '@nestjs/common';
// // import { InjectRepository } from '@nestjs/typeorm';
// // import { Repository } from 'typeorm';
// // import { User } from '../entities/user.entity';
// // import { ConfigService } from '@nestjs/config';
// // import { randomBytes } from 'crypto';
// // import { EmailService } from 'src/email/email.service';
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AccountDeletionConfirmationService = void 0;
// // /**
// //  * Service to handle account deletion confirmation workflow
// //  */
// // @Injectable()
// // export class AccountDeletionConfirmationService {
// //   private readonly logger = new Logger(AccountDeletionConfirmationService.name);
// //   private readonly tokenExpirationTime: number; // in hours
// //   private readonly confirmationTokens: Map<
// //     string,
// //     { token: string; expires: Date }
// //   > = new Map();
// //   constructor(
// //     @InjectRepository(User)
// //     private readonly userRepository: Repository<User>,
// //     private readonly configService: ConfigService,
// //     private readonly emailService: EmailService,
// //   ) {
// //     this.tokenExpirationTime = this.configService.get<number>(
// //       'DELETION_TOKEN_EXPIRY_HOURS',
// //       24,
// //     );
// //   }
// //   /**
// //    * Start the deletion confirmation workflow
// //    * @param userId User ID requesting deletion
// //    */
// //   async startDeletionConfirmationWorkflow(userId: string): Promise<void> {
// //     const user = await this.userRepository.findOne({
// //       where: { id: userId },
// //     });
// //     if (!user) {
// //       this.logger.warn(
// //         `Attempted to start deletion workflow for non-existent user: ${userId}`,
// //       );
// //       return;
// //     }
// //     // Generate a secure random token
// //     const token = this.generateSecureToken();
// //     // Set expiration time
// //     const expiryTime = new Date();
// //     expiryTime.setHours(expiryTime.getHours() + this.tokenExpirationTime);
// //     // Store token with expiration
// //     this.confirmationTokens.set(userId, {
// //       token,
// //       expires: expiryTime,
// //     });
// //     // Send confirmation email
// //     await this.sendDeletionConfirmationEmail(user.email, token, expiryTime);
// //     this.logger.log(
// //       `Deletion confirmation workflow started for user ${userId}`,
// //     );
// //   }
// //   /**
// //    * Validate a deletion confirmation token
// //    * @param userId User ID
// //    * @param token Confirmation token to validate
// //    */
// //   async validateDeletionConfirmation(
// //     userId: string,
// //     token: string,
// //   ): Promise<boolean> {
// //     const storedToken = this.confirmationTokens.get(userId);
// //     // Check if token exists and is valid
// //     if (!storedToken) {
// //       this.logger.warn(`No deletion token found for user ${userId}`);
// //       return false;
// //     }
// //     // Check if token has expired
// //     if (new Date() > storedToken.expires) {
// //       this.logger.warn(`Deletion token for user ${userId} has expired`);
// //       this.confirmationTokens.delete(userId); // Clean up expired token
// //       return false;
// //     }
// //     // Check if token matches
// //     const isValid = storedToken.token === token;
// //     if (isValid) {
// //       // Remove the token after successful validation
// //       this.confirmationTokens.delete(userId);
// //       this.logger.log(`Deletion confirmation validated for user ${userId}`);
// //     } else {
// //       this.logger.warn(`Invalid deletion token provided for user ${userId}`);
// //     }
// //     return isValid;
// //   }
// //   /**
// //    * Generate a secure random token
// //    */
// //   private generateSecureToken(): string {
// //     return randomBytes(32).toString('hex');
// //   }
// //   /**
// //    * Send confirmation email with deletion token
// //    * @param email User's email address
// //    * @param token Confirmation token
// //    * @param expiryTime Token expiration time
// //    */
// //   private async sendDeletionConfirmationEmail(
// //     email: string,
// //     token: string,
// //     expiryTime: Date,
// //   ): Promise<void> {
// //     const subject = 'Confirm Your Account Deletion Request';
// //     const body = `
// //       <h2>Account Deletion Confirmation</h2>
// //       <p>We received a request to delete your account. If you didn't make this request, please ignore this email or contact support immediately.</p>
// //       <p>To confirm your account deletion, please click the link below:</p>
// //       <p><a href="${this.configService.get('FRONTEND_URL')}/account/confirm-deletion?token=${token}">Confirm Account Deletion</a></p>
// //       <p>This link will expire on ${expiryTime.toLocaleString()}.</p>
// //       <p>Please note that account deletion is permanent and cannot be undone. All your personal data will be removed according to our privacy policy.</p>
// //       <p>If you have any questions, please contact our support team.</p>
// //     `;
// //     try {
// //       // await this.emailService.sendEmail(email, subject, body);
// //       await this.emailService.sendEmail({
// //         to: email,
// //         subject,
// //         html:body
// //       });
// //       this.logger.log(`Deletion confirmation email sent to ${email}`);
// //     } catch (error) {
// //       this.logger.error(
// //         `Failed to send deletion confirmation email to ${email}`,
// //         error.stack,
// //       );
// //       throw error;
// //     }
// //   }
// // }
// import { Injectable, Logger } from '@nestjs/common';
// import { InjectRepository } from '@nestjs/typeorm';
// import { Repository } from 'typeorm';
// import { User } from '../entities/user.entity';
// import { ConfigService } from '@nestjs/config';
// import { randomBytes } from 'crypto';
// import { EmailService } from 'src/email/email.service';
// import { AccountStatus } from '../enums/accountStatus.enum';
// /**
//  * Service to handle account deletion confirmation workflow
//  */
// @Injectable()
// export class AccountDeletionConfirmationService {
//   private readonly logger = new Logger(AccountDeletionConfirmationService.name);
//   private readonly tokenExpirationTime: number; // in hours
//   private readonly confirmationTokens: Map<
//     string,
//     { token: string; expires: Date }
//   > = new Map();
//   constructor(
//     @InjectRepository(User)
//     private readonly userRepository: Repository<User>,
//     private readonly configService: ConfigService,
//     private readonly emailService: EmailService,
//   ) {
//     this.tokenExpirationTime = this.configService.get<number>(
//       'DELETION_TOKEN_EXPIRY_HOURS',
//       24,
//     );
//   }
//   /**
//    * Start the deletion confirmation workflow
//    * @param userId User ID requesting deletion
//    */
//   async startDeletionConfirmationWorkflow(userId: string): Promise<void> {
//     const user = await this.userRepository.findOne({
//       where: { id: userId },
//     });
//     if (!user) {
//       this.logger.warn(
//         `Attempted to start deletion workflow for non-existent user: ${userId}`,
//       );
//       return;
//     }
//     const token = this.generateSecureToken();
//     const expiryTime = new Date();
//     expiryTime.setHours(expiryTime.getHours() + this.tokenExpirationTime);
//     this.confirmationTokens.set(userId, {
//       token,
//       expires: expiryTime,
//     });
//     await this.sendDeletionConfirmationEmail(user.email, token, expiryTime);
//     this.logger.log(
//       `Deletion confirmation workflow started for user ${userId}`,
//     );
//   }
//   /**
//    * Validate a deletion confirmation token and scrub user
//    * @param userId User ID
//    * @param token Confirmation token to validate
//    */
//   async validateAndDeleteAccount(
//     userId: string,
//     token: string,
//   ): Promise<boolean> {
//     const storedToken = this.confirmationTokens.get(userId);
//     if (!storedToken) {
//       this.logger.warn(`No deletion token found for user ${userId}`);
//       return false;
//     }
//     if (new Date() > storedToken.expires) {
//       this.logger.warn(`Deletion token for user ${userId} has expired`);
//       this.confirmationTokens.delete(userId);
//       return false;
//     }
//     if (storedToken.token !== token) {
//       this.logger.warn(`Invalid deletion token provided for user ${userId}`);
//       return false;
//     }
//     const user = await this.userRepository.findOne({
//       where: { id: userId },
//     });
//     if (!user) {
//       this.logger.warn(
//         `User not found during deletion confirmation: ${userId}`,
//       );
//       return false;
//     }
//     // Scrub sensitive data
//     user.firstName = 'Deleted';
//     user.lastName = 'User';
//     user.email = `${user.id}@deleted.example.com`; // anonymize email
//     user.bio = null;
//     user.profileImageUrl = null;
//     user.status = AccountStatus.DELETED;
//     user.deactivatedAt = new Date();
//     user.deletionRequestedAt = new Date();
//     user.deletedAt = new Date();
//     await this.userRepository.save(user);
//     // Clean up token
//     this.confirmationTokens.delete(userId);
//     this.logger.log(`User ${userId} account deletion confirmed and scrubbed`);
//     return true;
//   }
//   /**
//    * Generate a secure random token
//    */
//   private generateSecureToken(): string {
//     return randomBytes(32).toString('hex');
//   }
//   /**
//    * Send confirmation email with deletion token
//    */
//   private async sendDeletionConfirmationEmail(
//     email: string,
//     token: string,
//     expiryTime: Date,
//   ): Promise<void> {
//     const subject = 'Confirm Your Account Deletion Request';
//     const body = `
//       <h2>Account Deletion Confirmation</h2>
//       <p>We received a request to delete your account. If you didn't make this request, please ignore this email or contact support immediately.</p>
//       <p>To confirm your account deletion, please click the link below:</p>
//       <p><a href="${this.configService.get('FRONTEND_URL')}/account/confirm-deletion?token=${token}">Confirm Account Deletion</a></p>
//       <p>This link will expire on ${expiryTime.toLocaleString()}.</p>
//       <p>Please note that account deletion is permanent and cannot be undone. All your personal data will be removed according to our privacy policy.</p>
//       <p>If you have any questions, please contact our support team.</p>
//     `;
//     try {
//       // await this.emailService.sendEmail({
//       //   to: user.email,
//       //   subject: 'Confirm Your Account Deletion',
//       //   templateName: 'account-deletion-confirmation', 
//       //   context: {
//       //     name: user.firstName,
//       //     confirmationUrl,
//       //     companyName: 'YourCompanyName', // customize if needed
//       //     unsubscribeUrl,
//       //     year: new Date().getFullYear(),
//       //   },
//       //   html: body,
//       await this.emailService.sendEmail({
//       to: email,
//       subject: 'Confirm Your Account Deletion',
//       templateName: 'account-deletion-confirmation',
//       context: {
//         name: user.firstName,
//         confirmationUrl,
//         companyName: 'YourCompanyName',
//         unsubscribeUrl,
//         year: new Date().getFullYear(),
//       },
//     });
//       });
//       this.logger.log(`Deletion confirmation email sent to ${email}`);
//     } catch (error) {
//       this.logger.error(
//         `Failed to send deletion confirmation email to ${email}`,
//         error.stack,
//       );
//       throw error;
//     }
//   }
// }
const common_1 = require("@nestjs/common");
const email_service_1 = require("src/email/email.service");
let AccountDeletionConfirmationService = class AccountDeletionConfirmationService {
    constructor(emailService) {
        this.emailService = emailService;
    }
    async sendAccountDeletionEmail({ email, firstName, confirmationUrl, unsubscribeUrl, }) {
        await this.emailService.sendEmail({
            to: email,
            subject: 'Confirm Your Account Deletion',
            templateName: 'account-deletion-confirmation',
            context: {
                name: firstName,
                confirmationUrl,
                companyName: 'YourCompanyName', // You can make this dynamic too
                unsubscribeUrl,
                year: new Date().getFullYear(),
            },
        });
    }
    async validateAndDeleteAccount(token) {
        // Your validation and deletion logic here
        return true; // or false
    }
};
exports.AccountDeletionConfirmationService = AccountDeletionConfirmationService;
exports.AccountDeletionConfirmationService = AccountDeletionConfirmationService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof email_service_1.EmailService !== "undefined" && email_service_1.EmailService) === "function" ? _a : Object])
], AccountDeletionConfirmationService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxvam9zZXBoXFxEb2N1bWVudHNcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFx1c2Vyc1xcc2VydmljZXNcXGFjY291bnQuZGVsZXRpb24uY29uZmlybWF0aW9uLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6IjtBQUFBLDBEQUEwRDtBQUMxRCx5REFBeUQ7QUFDekQsMkNBQTJDO0FBQzNDLHFEQUFxRDtBQUNyRCxxREFBcUQ7QUFDckQsMkNBQTJDO0FBQzNDLDZEQUE2RDs7Ozs7Ozs7Ozs7OztBQUs3RCxTQUFTO0FBQ1QsaUVBQWlFO0FBQ2pFLFNBQVM7QUFDVCxtQkFBbUI7QUFDbkIsdURBQXVEO0FBQ3ZELHNGQUFzRjtBQUN0RixpRUFBaUU7QUFDakUsaURBQWlEO0FBQ2pELGlCQUFpQjtBQUNqQiwwQ0FBMEM7QUFDMUMsc0JBQXNCO0FBRXRCLG9CQUFvQjtBQUNwQixpQ0FBaUM7QUFDakMsNERBQTREO0FBQzVELHdEQUF3RDtBQUN4RCxzREFBc0Q7QUFDdEQsV0FBVztBQUNYLG9FQUFvRTtBQUNwRSwwQ0FBMEM7QUFDMUMsZUFBZTtBQUNmLFlBQVk7QUFDWixTQUFTO0FBRVQsV0FBVztBQUNYLG1EQUFtRDtBQUNuRCxvREFBb0Q7QUFDcEQsV0FBVztBQUNYLGdGQUFnRjtBQUNoRiwwREFBMEQ7QUFDMUQsa0NBQWtDO0FBQ2xDLGFBQWE7QUFFYixzQkFBc0I7QUFDdEIsNkJBQTZCO0FBQzdCLHNGQUFzRjtBQUN0RixjQUFjO0FBQ2QsbUJBQW1CO0FBQ25CLFdBQVc7QUFFWCwyQ0FBMkM7QUFDM0MsbURBQW1EO0FBRW5ELGdDQUFnQztBQUNoQyx3Q0FBd0M7QUFDeEMsZ0ZBQWdGO0FBRWhGLHdDQUF3QztBQUN4QywrQ0FBK0M7QUFDL0Msa0JBQWtCO0FBQ2xCLGdDQUFnQztBQUNoQyxhQUFhO0FBRWIsb0NBQW9DO0FBQ3BDLGtGQUFrRjtBQUVsRiwwQkFBMEI7QUFDMUIsd0VBQXdFO0FBQ3hFLFlBQVk7QUFDWixTQUFTO0FBRVQsV0FBVztBQUNYLGlEQUFpRDtB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dXJjZXMiOlsiQzpcXFVzZXJzXFxvam9zZXBoXFxEb2N1bWVudHNcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFx1c2Vyc1xcc2VydmljZXNcXGFjY291bnQuZGVsZXRpb24uY29uZmlybWF0aW9uLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gLy8gaW1wb3J0IHsgSW5qZWN0YWJsZSwgTG9nZ2VyIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xyXG4vLyAvLyBpbXBvcnQgeyBJbmplY3RSZXBvc2l0b3J5IH0gZnJvbSAnQG5lc3Rqcy90eXBlb3JtJztcclxuLy8gLy8gaW1wb3J0IHsgUmVwb3NpdG9yeSB9IGZyb20gJ3R5cGVvcm0nO1xyXG4vLyAvLyBpbXBvcnQgeyBVc2VyIH0gZnJvbSAnLi4vZW50aXRpZXMvdXNlci5lbnRpdHknO1xyXG4vLyAvLyBpbXBvcnQgeyBDb25maWdTZXJ2aWNlIH0gZnJvbSAnQG5lc3Rqcy9jb25maWcnO1xyXG4vLyAvLyBpbXBvcnQgeyByYW5kb21CeXRlcyB9IGZyb20gJ2NyeXB0byc7XHJcbi8vIC8vIGltcG9ydCB7IEVtYWlsU2VydmljZSB9IGZyb20gJ3NyYy9lbWFpbC9lbWFpbC5zZXJ2aWNlJztcclxuXHJcblxyXG5cclxuXHJcbi8vIC8vIC8qKlxyXG4vLyAvLyAgKiBTZXJ2aWNlIHRvIGhhbmRsZSBhY2NvdW50IGRlbGV0aW9uIGNvbmZpcm1hdGlvbiB3b3JrZmxvd1xyXG4vLyAvLyAgKi9cclxuLy8gLy8gQEluamVjdGFibGUoKVxyXG4vLyAvLyBleHBvcnQgY2xhc3MgQWNjb3VudERlbGV0aW9uQ29uZmlybWF0aW9uU2VydmljZSB7XHJcbi8vIC8vICAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKEFjY291bnREZWxldGlvbkNvbmZpcm1hdGlvblNlcnZpY2UubmFtZSk7XHJcbi8vIC8vICAgcHJpdmF0ZSByZWFkb25seSB0b2tlbkV4cGlyYXRpb25UaW1lOiBudW1iZXI7IC8vIGluIGhvdXJzXHJcbi8vIC8vICAgcHJpdmF0ZSByZWFkb25seSBjb25maXJtYXRpb25Ub2tlbnM6IE1hcDxcclxuLy8gLy8gICAgIHN0cmluZyxcclxuLy8gLy8gICAgIHsgdG9rZW46IHN0cmluZzsgZXhwaXJlczogRGF0ZSB9XHJcbi8vIC8vICAgPiA9IG5ldyBNYXAoKTtcclxuXHJcbi8vIC8vICAgY29uc3RydWN0b3IoXHJcbi8vIC8vICAgICBASW5qZWN0UmVwb3NpdG9yeShVc2VyKVxyXG4vLyAvLyAgICAgcHJpdmF0ZSByZWFkb25seSB1c2VyUmVwb3NpdG9yeTogUmVwb3NpdG9yeTxVc2VyPixcclxuLy8gLy8gICAgIHByaXZhdGUgcmVhZG9ubHkgY29uZmlnU2VydmljZTogQ29uZmlnU2VydmljZSxcclxuLy8gLy8gICAgIHByaXZhdGUgcmVhZG9ubHkgZW1haWxTZXJ2aWNlOiBFbWFpbFNlcnZpY2UsXHJcbi8vIC8vICAgKSB7XHJcbi8vIC8vICAgICB0aGlzLnRva2VuRXhwaXJhdGlvblRpbWUgPSB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PG51bWJlcj4oXHJcbi8vIC8vICAgICAgICdERUxFVElPTl9UT0tFTl9FWFBJUllfSE9VUlMnLFxyXG4vLyAvLyAgICAgICAyNCxcclxuLy8gLy8gICAgICk7XHJcbi8vIC8vICAgfVxyXG5cclxuLy8gLy8gICAvKipcclxuLy8gLy8gICAgKiBTdGFydCB0aGUgZGVsZXRpb24gY29uZmlybWF0aW9uIHdvcmtmbG93XHJcbi8vIC8vICAgICogQHBhcmFtIHVzZXJJZCBVc2VyIElEIHJlcXVlc3RpbmcgZGVsZXRpb25cclxuLy8gLy8gICAgKi9cclxuLy8gLy8gICBhc3luYyBzdGFydERlbGV0aW9uQ29uZmlybWF0aW9uV29ya2Zsb3codXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcclxuLy8gLy8gICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnVzZXJSZXBvc2l0b3J5LmZpbmRPbmUoe1xyXG4vLyAvLyAgICAgICB3aGVyZTogeyBpZDogdXNlcklkIH0sXHJcbi8vIC8vICAgICB9KTtcclxuXHJcbi8vIC8vICAgICBpZiAoIXVzZXIpIHtcclxuLy8gLy8gICAgICAgdGhpcy5sb2dnZXIud2FybihcclxuLy8gLy8gICAgICAgICBgQXR0ZW1wdGVkIHRvIHN0YXJ0IGRlbGV0aW9uIHdvcmtmbG93IGZvciBub24tZXhpc3RlbnQgdXNlcjogJHt1c2VySWR9YCxcclxuLy8gLy8gICAgICAgKTtcclxuLy8gLy8gICAgICAgcmV0dXJuO1xyXG4vLyAvLyAgICAgfVxyXG5cclxuLy8gLy8gICAgIC8vIEdlbmVyYXRlIGEgc2VjdXJlIHJhbmRvbSB0b2tlblxyXG4vLyAvLyAgICAgY29uc3QgdG9rZW4gPSB0aGlzLmdlbmVyYXRlU2VjdXJlVG9rZW4oKTtcclxuXHJcbi8vIC8vICAgICAvLyBTZXQgZXhwaXJhdGlvbiB0aW1lXHJcbi8vIC8vICAgICBjb25zdCBleHBpcnlUaW1lID0gbmV3IERhdGUoKTtcclxuLy8gLy8gICAgIGV4cGlyeVRpbWUuc2V0SG91cnMoZXhwaXJ5VGltZS5nZXRIb3VycygpICsgdGhpcy50b2tlbkV4cGlyYXRpb25UaW1lKTtcclxuXHJcbi8vIC8vICAgICAvLyBTdG9yZSB0b2tlbiB3aXRoIGV4cGlyYXRpb25cclxuLy8gLy8gICAgIHRoaXMuY29uZmlybWF0aW9uVG9rZW5zLnNldCh1c2VySWQsIHtcclxuLy8gLy8gICAgICAgdG9rZW4sXHJcbi8vIC8vICAgICAgIGV4cGlyZXM6IGV4cGlyeVRpbWUsXHJcbi8vIC8vICAgICB9KTtcclxuXHJcbi8vIC8vICAgICAvLyBTZW5kIGNvbmZpcm1hdGlvbiBlbWFpbFxyXG4vLyAvLyAgICAgYXdhaXQgdGhpcy5zZW5kRGVsZXRpb25Db25maXJtYXRpb25FbWFpbCh1c2VyLmVtYWlsLCB0b2tlbiwgZXhwaXJ5VGltZSk7XHJcblxyXG4vLyAvLyAgICAgdGhpcy5sb2dnZXIubG9nKFxyXG4vLyAvLyAgICAgICBgRGVsZXRpb24gY29uZmlybWF0aW9uIHdvcmtmbG93IHN0YXJ0ZWQgZm9yIHVzZXIgJHt1c2VySWR9YCxcclxuLy8gLy8gICAgICk7XHJcbi8vIC8vICAgfVxyXG5cclxuLy8gLy8gICAvKipcclxuLy8gLy8gICAgKiBWYWxpZGF0ZSBhIGRlbGV0aW9uIGNvbmZpcm1hdGlvbiB0b2tlblxyXG4vLyAvLyAgICAqIEBwYXJhbSB1c2VySWQgVXNlciBJRFxyXG4vLyAvLyAgICAqIEBwYXJhbSB0b2tlbiBDb25maXJtYXRpb24gdG9rZW4gdG8gdmFsaWRhdGVcclxuLy8gLy8gICAgKi9cclxuLy8gLy8gICBhc3luYyB2YWxpZGF0ZURlbGV0aW9uQ29uZmlybWF0aW9uKFxyXG4vLyAvLyAgICAgdXNlcklkOiBzdHJpbmcsXHJcbi8vIC8vICAgICB0b2tlbjogc3RyaW5nLFxyXG4vLyAvLyAgICk6IFByb21pc2U8Ym9vbGVhbj4ge1xyXG4vLyAvLyAgICAgY29uc3Qgc3RvcmVkVG9rZW4gPSB0aGlzLmNvbmZpcm1hdGlvblRva2Vucy5nZXQodXNlcklkKTtcclxuXHJcbi8vIC8vICAgICAvLyBDaGVjayBpZiB0b2tlbiBleGlzdHMgYW5kIGlzIHZhbGlkXHJcbi8vIC8vICAgICBpZiAoIXN0b3JlZFRva2VuKSB7XHJcbi8vIC8vICAgICAgIHRoaXMubG9nZ2VyLndhcm4oYE5vIGRlbGV0aW9uIHRva2VuIGZvdW5kIGZvciB1c2VyICR7dXNlcklkfWApO1xyXG4vLyAvLyAgICAgICByZXR1cm4gZmFsc2U7XHJcbi8vIC8vICAgICB9XHJcblxyXG4vLyAvLyAgICAgLy8gQ2hlY2sgaWYgdG9rZW4gaGFzIGV4cGlyZWRcclxuLy8gLy8gICAgIGlmIChuZXcgRGF0ZSgpID4gc3RvcmVkVG9rZW4uZXhwaXJlcykge1xyXG4vLyAvLyAgICAgICB0aGlzLmxvZ2dlci53YXJuKGBEZWxldGlvbiB0b2tlbiBmb3IgdXNlciAke3VzZXJJZH0gaGFzIGV4cGlyZWRgKTtcclxuLy8gLy8gICAgICAgdGhpcy5jb25maXJtYXRpb25Ub2tlbnMuZGVsZXRlKHVzZXJJZCk7IC8vIENsZWFuIHVwIGV4cGlyZWQgdG9rZW5cclxuLy8gLy8gICAgICAgcmV0dXJuIGZhbHNlO1xyXG4vLyAvLyAgICAgfVxyXG5cclxuLy8gLy8gICAgIC8vIENoZWNrIGlmIHRva2VuIG1hdGNoZXNcclxuLy8gLy8gICAgIGNvbnN0IGlzVmFsaWQgPSBzdG9yZWRUb2tlbi50b2tlbiA9PT0gdG9rZW47XHJcblxyXG4vLyAvLyAgICAgaWYgKGlzVmFsaWQpIHtcclxuLy8gLy8gICAgICAgLy8gUmVtb3ZlIHRoZSB0b2tlbiBhZnRlciBzdWNjZXNzZnVsIHZhbGlkYXRpb25cclxuLy8gLy8gICAgICAgdGhpcy5jb25maXJtYXRpb25Ub2tlbnMuZGVsZXRlKHVzZXJJZCk7XHJcbi8vIC8vICAgICAgIHRoaXMubG9nZ2VyLmxvZyhgRGVsZXRpb24gY29uZmlybWF0aW9uIHZhbGlkYXRlZCBmb3IgdXNlciAke3VzZXJJZH1gKTtcclxuLy8gLy8gICAgIH0gZWxzZSB7XHJcbi8vIC8vICAgICAgIHRoaXMubG9nZ2VyLndhcm4oYEludmFsaWQgZGVsZXRpb24gdG9rZW4gcHJvdmlkZWQgZm9yIHVzZXIgJHt1c2VySWR9YCk7XHJcbi8vIC8vICAgICB9XHJcblxyXG4vLyAvLyAgICAgcmV0dXJuIGlzVmFsaWQ7XHJcbi8vIC8vICAgfVxyXG5cclxuLy8gLy8gICAvKipcclxuLy8gLy8gICAgKiBHZW5lcmF0ZSBhIHNlY3VyZSByYW5kb20gdG9rZW5cclxuLy8gLy8gICAgKi9cclxuLy8gLy8gICBwcml2YXRlIGdlbmVyYXRlU2VjdXJlVG9rZW4oKTogc3RyaW5nIHtcclxuLy8gLy8gICAgIHJldHVybiByYW5kb21CeXRlcygzMikudG9TdHJpbmcoJ2hleCcpO1xyXG4vLyAvLyAgIH1cclxuXHJcbi8vIC8vICAgLyoqXHJcbi8vIC8vICAgICogU2VuZCBjb25maXJtYXRpb24gZW1haWwgd2l0aCBkZWxldGlvbiB0b2tlblxyXG4vLyAvLyAgICAqIEBwYXJhbSBlbWFpbCBVc2VyJ3MgZW1haWwgYWRkcmVzc1xyXG4vLyAvLyAgICAqIEBwYXJhbSB0b2tlbiBDb25maXJtYXRpb24gdG9rZW5cclxuLy8gLy8gICAgKiBAcGFyYW0gZXhwaXJ5VGltZSBUb2tlbiBleHBpcmF0aW9uIHRpbWVcclxuLy8gLy8gICAgKi9cclxuLy8gLy8gICBwcml2YXRlIGFzeW5jIHNlbmREZWxldGlvbkNvbmZpcm1hdGlvbkVtYWlsKFxyXG4vLyAvLyAgICAgZW1haWw6IHN0cmluZyxcclxuLy8gLy8gICAgIHRva2VuOiBzdHJpbmcsXHJcbi8vIC8vICAgICBleHBpcnlUaW1lOiBEYXRlLFxyXG4vLyAvLyAgICk6IFByb21pc2U8dm9pZD4ge1xyXG4vLyAvLyAgICAgY29uc3Qgc3ViamVjdCA9ICdDb25maXJtIFlvdXIgQWNjb3VudCBEZWxldGlvbiBSZXF1ZXN0JztcclxuXHJcbi8vIC8vICAgICBjb25zdCBib2R5ID0gYFxyXG4vLyAvLyAgICAgICA8aDI+QWNjb3VudCBEZWxldGlvbiBDb25maXJtYXRpb248L2gyPlxyXG4vLyAvLyAgICAgICA8cD5XZSByZWNlaXZlZCBhIHJlcXVlc3QgdG8gZGVsZXRlIHlvdXIgYWNjb3VudC4gSWYgeW91IGRpZG4ndCBtYWtlIHRoaXMgcmVxdWVzdCwgcGxlYXNlIGlnbm9yZSB0aGlzIGVtYWlsIG9yIGNvbnRhY3Qgc3VwcG9ydCBpbW1lZGlhdGVseS48L3A+XHJcbi8vIC8vICAgICAgIDxwPlRvIGNvbmZpcm0geW91ciBhY2NvdW50IGRlbGV0aW9uLCBwbGVhc2UgY2xpY2sgdGhlIGxpbmsgYmVsb3c6PC9wPlxyXG4vLyAvLyAgICAgICA8cD48YSBocmVmPVwiJHt0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0KCdGUk9OVEVORF9VUkwnKX0vYWNjb3VudC9jb25maXJtLWRlbGV0aW9uP3Rva2VuPSR7dG9rZW59XCI+Q29uZmlybSBBY2NvdW50IERlbGV0aW9uPC9hPjwvcD5cclxuLy8gLy8gICAgICAgPHA+VGhpcyBsaW5rIHdpbGwgZXhwaXJlIG9uICR7ZXhwaXJ5VGltZS50b0xvY2FsZVN0cmluZygpfS48L3A+XHJcbi8vIC8vICAgICAgIDxwPlBsZWFzZSBub3RlIHRoYXQgYWNjb3VudCBkZWxldGlvbiBpcyBwZXJtYW5lbnQgYW5kIGNhbm5vdCBiZSB1bmRvbmUuIEFsbCB5b3VyIHBlcnNvbmFsIGRhdGEgd2lsbCBiZSByZW1vdmVkIGFjY29yZGluZyB0byBvdXIgcHJpdmFjeSBwb2xpY3kuPC9wPlxyXG4vLyAvLyAgICAgICA8cD5JZiB5b3UgaGF2ZSBhbnkgcXVlc3Rpb25zLCBwbGVhc2UgY29udGFjdCBvdXIgc3VwcG9ydCB0ZWFtLjwvcD5cclxuLy8gLy8gICAgIGA7XHJcblxyXG4vLyAvLyAgICAgdHJ5IHtcclxuLy8gLy8gICAgICAgLy8gYXdhaXQgdGhpcy5lbWFpbFNlcnZpY2Uuc2VuZEVtYWlsKGVtYWlsLCBzdWJqZWN0LCBib2R5KTtcclxuLy8gLy8gICAgICAgYXdhaXQgdGhpcy5lbWFpbFNlcnZpY2Uuc2VuZEVtYWlsKHtcclxuLy8gLy8gICAgICAgICB0bzogZW1haWwsXHJcbi8vIC8vICAgICAgICAgc3ViamVjdCxcclxuLy8gLy8gICAgICAgICBodG1sOmJvZHlcclxuLy8gLy8gICAgICAgfSk7XHJcblxyXG4vLyAvLyAgICAgICB0aGlzLmxvZ2dlci5sb2coYERlbGV0aW9uIGNvbmZpcm1hdGlvbiBlbWFpbCBzZW50IHRvICR7ZW1haWx9YCk7XHJcbi8vIC8vICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4vLyAvLyAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihcclxuLy8gLy8gICAgICAgICBgRmFpbGVkIHRvIHNlbmQgZGVsZXRpb24gY29uZmlybWF0aW9uIGVtYWlsIHRvICR7ZW1haWx9YCxcclxuLy8gLy8gICAgICAgICBlcnJvci5zdGFjayxcclxuLy8gLy8gICAgICAgKTtcclxuLy8gLy8gICAgICAgdGhyb3cgZXJyb3I7XHJcbi8vIC8vICAgICB9XHJcbi8vIC8vICAgfVxyXG4vLyAvLyB9XHJcblxyXG4vLyBpbXBvcnQgeyBJbmplY3RhYmxlLCBMb2dnZXIgfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XHJcbi8vIGltcG9ydCB7IEluamVjdFJlcG9zaXRvcnkgfSBmcm9tICdAbmVzdGpzL3R5cGVvcm0nO1xyXG4vLyBpbXBvcnQgeyBSZXBvc2l0b3J5IH0gZnJvbSAndHlwZW9ybSc7XHJcbi8vIGltcG9ydCB7IFVzZXIgfSBmcm9tICcuLi9lbnRpdGllcy91c2VyLmVudGl0eSc7XHJcbi8vIGltcG9ydCB7IENvbmZpZ1NlcnZpY2UgfSBmcm9tICdAbmVzdGpzL2NvbmZpZyc7XHJcbi8vIGltcG9ydCB7IHJhbmRvbUJ5dGVzIH0gZnJvbSAnY3J5cHRvJztcclxuLy8gaW1wb3J0IHsgRW1haWxTZXJ2aWNlIH0gZnJvbSAnc3JjL2VtYWlsL2VtYWlsLnNlcnZpY2UnO1xyXG4vLyBpbXBvcnQgeyBBY2NvdW50U3RhdHVzIH0gZnJvbSAnLi4vZW51bXMvYWNjb3VudFN0YXR1cy5lbnVtJztcclxuXHJcbi8vIC8qKlxyXG4vLyAgKiBTZXJ2aWNlIHRvIGhhbmRsZSBhY2NvdW50IGRlbGV0aW9uIGNvbmZpcm1hdGlvbiB3b3JrZmxvd1xyXG4vLyAgKi9cclxuLy8gQEluamVjdGFibGUoKVxyXG4vLyBleHBvcnQgY2xhc3MgQWNjb3VudERlbGV0aW9uQ29uZmlybWF0aW9uU2VydmljZSB7XHJcbi8vICAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKEFjY291bnREZWxldGlvbkNvbmZpcm1hdGlvblNlcnZpY2UubmFtZSk7XHJcbi8vICAgcHJpdmF0ZSByZWFkb25seSB0b2tlbkV4cGlyYXRpb25UaW1lOiBudW1iZXI7IC8vIGluIGhvdXJzXHJcbi8vICAgcHJpdmF0ZSByZWFkb25seSBjb25maXJtYXRpb25Ub2tlbnM6IE1hcDxcclxuLy8gICAgIHN0cmluZyxcclxuLy8gICAgIHsgdG9rZW46IHN0cmluZzsgZXhwaXJlczogRGF0ZSB9XHJcbi8vICAgPiA9IG5ldyBNYXAoKTtcclxuXHJcbi8vICAgY29uc3RydWN0b3IoXHJcbi8vICAgICBASW5qZWN0UmVwb3NpdG9yeShVc2VyKVxyXG4vLyAgICAgcHJpdmF0ZSByZWFkb25seSB1c2VyUmVwb3NpdG9yeTogUmVwb3NpdG9yeTxVc2VyPixcclxuLy8gICAgIHByaXZhdGUgcmVhZG9ubHkgY29uZmlnU2VydmljZTogQ29uZmlnU2VydmljZSxcclxuLy8gICAgIHByaXZhdGUgcmVhZG9ubHkgZW1haWxTZXJ2aWNlOiBFbWFpbFNlcnZpY2UsXHJcbi8vICAgKSB7XHJcbi8vICAgICB0aGlzLnRva2VuRXhwaXJhdGlvblRpbWUgPSB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PG51bWJlcj4oXHJcbi8vICAgICAgICdERUxFVElPTl9UT0tFTl9FWFBJUllfSE9VUlMnLFxyXG4vLyAgICAgICAyNCxcclxuLy8gICAgICk7XHJcbi8vICAgfVxyXG5cclxuLy8gICAvKipcclxuLy8gICAgKiBTdGFydCB0aGUgZGVsZXRpb24gY29uZmlybWF0aW9uIHdvcmtmbG93XHJcbi8vICAgICogQHBhcmFtIHVzZXJJZCBVc2VyIElEIHJlcXVlc3RpbmcgZGVsZXRpb25cclxuLy8gICAgKi9cclxuLy8gICBhc3luYyBzdGFydERlbGV0aW9uQ29uZmlybWF0aW9uV29ya2Zsb3codXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcclxuLy8gICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnVzZXJSZXBvc2l0b3J5LmZpbmRPbmUoe1xyXG4vLyAgICAgICB3aGVyZTogeyBpZDogdXNlcklkIH0sXHJcbi8vICAgICB9KTtcclxuXHJcbi8vICAgICBpZiAoIXVzZXIpIHtcclxuLy8gICAgICAgdGhpcy5sb2dnZXIud2FybihcclxuLy8gICAgICAgICBgQXR0ZW1wdGVkIHRvIHN0YXJ0IGRlbGV0aW9uIHdvcmtmbG93IGZvciBub24tZXhpc3RlbnQgdXNlcjogJHt1c2VySWR9YCxcclxuLy8gICAgICAgKTtcclxuLy8gICAgICAgcmV0dXJuO1xyXG4vLyAgICAgfVxyXG5cclxuLy8gICAgIGNvbnN0IHRva2VuID0gdGhpcy5nZW5lcmF0ZVNlY3VyZVRva2VuKCk7XHJcblxyXG4vLyAgICAgY29uc3QgZXhwaXJ5VGltZSA9IG5ldyBEYXRlKCk7XHJcbi8vICAgICBleHBpcnlUaW1lLnNldEhvdXJzKGV4cGlyeVRpbWUuZ2V0SG91cnMoKSArIHRoaXMudG9rZW5FeHBpcmF0aW9uVGltZSk7XHJcblxyXG4vLyAgICAgdGhpcy5jb25maXJtYXRpb25Ub2tlbnMuc2V0KHVzZXJJZCwge1xyXG4vLyAgICAgICB0b2tlbixcclxuLy8gICAgICAgZXhwaXJlczogZXhwaXJ5VGltZSxcclxuLy8gICAgIH0pO1xyXG5cclxuLy8gICAgIGF3YWl0IHRoaXMuc2VuZERlbGV0aW9uQ29uZmlybWF0aW9uRW1haWwodXNlci5lbWFpbCwgdG9rZW4sIGV4cGlyeVRpbWUpO1xyXG5cclxuLy8gICAgIHRoaXMubG9nZ2VyLmxvZyhcclxuLy8gICAgICAgYERlbGV0aW9uIGNvbmZpcm1hdGlvbiB3b3JrZmxvdyBzdGFydGVkIGZvciB1c2VyICR7dXNlcklkfWAsXHJcbi8vICAgICApO1xyXG4vLyAgIH1cclxuXHJcbi8vICAgLyoqXHJcbi8vICAgICogVmFsaWRhdGUgYSBkZWxldGlvbiBjb25maXJtYXRpb24gdG9rZW4gYW5kIHNjcnViIHVzZXJcclxuLy8gICAgKiBAcGFyYW0gdXNlcklkIFVzZXIgSURcclxuLy8gICAgKiBAcGFyYW0gdG9rZW4gQ29uZmlybWF0aW9uIHRva2VuIHRvIHZhbGlkYXRlXHJcbi8vICAgICovXHJcbi8vICAgYXN5bmMgdmFsaWRhdGVBbmREZWxldGVBY2NvdW50KFxyXG4vLyAgICAgdXNlcklkOiBzdHJpbmcsXHJcbi8vICAgICB0b2tlbjogc3RyaW5nLFxyXG4vLyAgICk6IFByb21pc2U8Ym9vbGVhbj4ge1xyXG4vLyAgICAgY29uc3Qgc3RvcmVkVG9rZW4gPSB0aGlzLmNvbmZpcm1hdGlvblRva2Vucy5nZXQodXNlcklkKTtcclxuXHJcbi8vICAgICBpZiAoIXN0b3JlZFRva2VuKSB7XHJcbi8vICAgICAgIHRoaXMubG9nZ2VyLndhcm4oYE5vIGRlbGV0aW9uIHRva2VuIGZvdW5kIGZvciB1c2VyICR7dXNlcklkfWApO1xyXG4vLyAgICAgICByZXR1cm4gZmFsc2U7XHJcbi8vICAgICB9XHJcblxyXG4vLyAgICAgaWYgKG5ldyBEYXRlKCkgPiBzdG9yZWRUb2tlbi5leHBpcmVzKSB7XHJcbi8vICAgICAgIHRoaXMubG9nZ2VyLndhcm4oYERlbGV0aW9uIHRva2VuIGZvciB1c2VyICR7dXNlcklkfSBoYXMgZXhwaXJlZGApO1xyXG4vLyAgICAgICB0aGlzLmNvbmZpcm1hdGlvblRva2Vucy5kZWxldGUodXNlcklkKTtcclxuLy8gICAgICAgcmV0dXJuIGZhbHNlO1xyXG4vLyAgICAgfVxyXG5cclxuLy8gICAgIGlmIChzdG9yZWRUb2tlbi50b2tlbiAhPT0gdG9rZW4pIHtcclxuLy8gICAgICAgdGhpcy5sb2dnZXIud2FybihgSW52YWxpZCBkZWxldGlvbiB0b2tlbiBwcm92aWRlZCBmb3IgdXNlciAke3VzZXJJZH1gKTtcclxuLy8gICAgICAgcmV0dXJuIGZhbHNlO1xyXG4vLyAgICAgfVxyXG5cclxuLy8gICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnVzZXJSZXBvc2l0b3J5LmZpbmRPbmUoe1xyXG4vLyAgICAgICB3aGVyZTogeyBpZDogdXNlcklkIH0sXHJcbi8vICAgICB9KTtcclxuXHJcbi8vICAgICBpZiAoIXVzZXIpIHtcclxuLy8gICAgICAgdGhpcy5sb2dnZXIud2FybihcclxuLy8gICAgICAgICBgVXNlciBub3QgZm91bmQgZHVyaW5nIGRlbGV0aW9uIGNvbmZpcm1hdGlvbjogJHt1c2VySWR9YCxcclxuLy8gICAgICAgKTtcclxuLy8gICAgICAgcmV0dXJuIGZhbHNlO1xyXG4vLyAgICAgfVxyXG5cclxuLy8gICAgIC8vIFNjcnViIHNlbnNpdGl2ZSBkYXRhXHJcbi8vICAgICB1c2VyLmZpcnN0TmFtZSA9ICdEZWxldGVkJztcclxuLy8gICAgIHVzZXIubGFzdE5hbWUgPSAnVXNlcic7XHJcbi8vICAgICB1c2VyLmVtYWlsID0gYCR7dXNlci5pZH1AZGVsZXRlZC5leGFtcGxlLmNvbWA7IC8vIGFub255bWl6ZSBlbWFpbFxyXG4vLyAgICAgdXNlci5iaW8gPSBudWxsO1xyXG4vLyAgICAgdXNlci5wcm9maWxlSW1hZ2VVcmwgPSBudWxsO1xyXG4vLyAgICAgdXNlci5zdGF0dXMgPSBBY2NvdW50U3RhdHVzLkRFTEVURUQ7XHJcbi8vICAgICB1c2VyLmRlYWN0aXZhdGVkQXQgPSBuZXcgRGF0ZSgpO1xyXG4vLyAgICAgdXNlci5kZWxldGlvblJlcXVlc3RlZEF0ID0gbmV3IERhdGUoKTtcclxuLy8gICAgIHVzZXIuZGVsZXRlZEF0ID0gbmV3IERhdGUoKTtcclxuXHJcbi8vICAgICBhd2FpdCB0aGlzLnVzZXJSZXBvc2l0b3J5LnNhdmUodXNlcik7XHJcblxyXG4vLyAgICAgLy8gQ2xlYW4gdXAgdG9rZW5cclxuLy8gICAgIHRoaXMuY29uZmlybWF0aW9uVG9rZW5zLmRlbGV0ZSh1c2VySWQpO1xyXG5cclxuLy8gICAgIHRoaXMubG9nZ2VyLmxvZyhgVXNlciAke3VzZXJJZH0gYWNjb3VudCBkZWxldGlvbiBjb25maXJtZWQgYW5kIHNjcnViYmVkYCk7XHJcbi8vICAgICByZXR1cm4gdHJ1ZTtcclxuLy8gICB9XHJcblxyXG4vLyAgIC8qKlxyXG4vLyAgICAqIEdlbmVyYXRlIGEgc2VjdXJlIHJhbmRvbSB0b2tlblxyXG4vLyAgICAqL1xyXG4vLyAgIHByaXZhdGUgZ2VuZXJhdGVTZWN1cmVUb2tlbigpOiBzdHJpbmcge1xyXG4vLyAgICAgcmV0dXJuIHJhbmRvbUJ5dGVzKDMyKS50b1N0cmluZygnaGV4Jyk7XHJcbi8vICAgfVxyXG5cclxuLy8gICAvKipcclxuLy8gICAgKiBTZW5kIGNvbmZpcm1hdGlvbiBlbWFpbCB3aXRoIGRlbGV0aW9uIHRva2VuXHJcbi8vICAgICovXHJcbi8vICAgcHJpdmF0ZSBhc3luYyBzZW5kRGVsZXRpb25Db25maXJtYXRpb25FbWFpbChcclxuLy8gICAgIGVtYWlsOiBzdHJpbmcsXHJcbi8vICAgICB0b2tlbjogc3RyaW5nLFxyXG4vLyAgICAgZXhwaXJ5VGltZTogRGF0ZSxcclxuLy8gICApOiBQcm9taXNlPHZvaWQ+IHtcclxuLy8gICAgIGNvbnN0IHN1YmplY3QgPSAnQ29uZmlybSBZb3VyIEFjY291bnQgRGVsZXRpb24gUmVxdWVzdCc7XHJcbi8vICAgICBjb25zdCBib2R5ID0gYFxyXG4vLyAgICAgICA8aDI+QWNjb3VudCBEZWxldGlvbiBDb25maXJtYXRpb248L2gyPlxyXG4vLyAgICAgICA8cD5XZSByZWNlaXZlZCBhIHJlcXVlc3QgdG8gZGVsZXRlIHlvdXIgYWNjb3VudC4gSWYgeW91IGRpZG4ndCBtYWtlIHRoaXMgcmVxdWVzdCwgcGxlYXNlIGlnbm9yZSB0aGlzIGVtYWlsIG9yIGNvbnRhY3Qgc3VwcG9ydCBpbW1lZGlhdGVseS48L3A+XHJcbi8vICAgICAgIDxwPlRvIGNvbmZpcm0geW91ciBhY2NvdW50IGRlbGV0aW9uLCBwbGVhc2UgY2xpY2sgdGhlIGxpbmsgYmVsb3c6PC9wPlxyXG4vLyAgICAgICA8cD48YSBocmVmPVwiJHt0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0KCdGUk9OVEVORF9VUkwnKX0vYWNjb3VudC9jb25maXJtLWRlbGV0aW9uP3Rva2VuPSR7dG9rZW59XCI+Q29uZmlybSBBY2NvdW50IERlbGV0aW9uPC9hPjwvcD5cclxuLy8gICAgICAgPHA+VGhpcyBsaW5rIHdpbGwgZXhwaXJlIG9uICR7ZXhwaXJ5VGltZS50b0xvY2FsZVN0cmluZygpfS48L3A+XHJcbi8vICAgICAgIDxwPlBsZWFzZSBub3RlIHRoYXQgYWNjb3VudCBkZWxldGlvbiBpcyBwZXJtYW5lbnQgYW5kIGNhbm5vdCBiZSB1bmRvbmUuIEFsbCB5b3VyIHBlcnNvbmFsIGRhdGEgd2lsbCBiZSByZW1vdmVkIGFjY29yZGluZyB0byBvdXIgcHJpdmFjeSBwb2xpY3kuPC9wPlxyXG4vLyAgICAgICA8cD5JZiB5b3UgaGF2ZSBhbnkgcXVlc3Rpb25zLCBwbGVhc2UgY29udGFjdCBvdXIgc3VwcG9ydCB0ZWFtLjwvcD5cclxuLy8gICAgIGA7XHJcblxyXG4vLyAgICAgdHJ5IHtcclxuICAgICBcclxuLy8gICAgICAgLy8gYXdhaXQgdGhpcy5lbWFpbFNlcnZpY2Uuc2VuZEVtYWlsKHtcclxuLy8gICAgICAgLy8gICB0bzogdXNlci5lbWFpbCxcclxuLy8gICAgICAgLy8gICBzdWJqZWN0OiAnQ29uZmlybSBZb3VyIEFjY291bnQgRGVsZXRpb24nLFxyXG4vLyAgICAgICAvLyAgIHRlbXBsYXRlTmFtZTogJ2FjY291bnQtZGVsZXRpb24tY29uZmlybWF0aW9uJywgXHJcbi8vICAgICAgIC8vICAgY29udGV4dDoge1xyXG4vLyAgICAgICAvLyAgICAgbmFtZTogdXNlci5maXJzdE5hbWUsXHJcbi8vICAgICAgIC8vICAgICBjb25maXJtYXRpb25VcmwsXHJcbi8vICAgICAgIC8vICAgICBjb21wYW55TmFtZTogJ1lvdXJDb21wYW55TmFtZScsIC8vIGN1c3RvbWl6ZSBpZiBuZWVkZWRcclxuLy8gICAgICAgLy8gICAgIHVuc3Vic2NyaWJlVXJsLFxyXG4vLyAgICAgICAvLyAgICAgeWVhcjogbmV3IERhdGUoKS5nZXRGdWxsWWVhcigpLFxyXG4vLyAgICAgICAvLyAgIH0sXHJcbi8vICAgICAgIC8vICAgaHRtbDogYm9keSxcclxuXHJcbi8vICAgICAgIGF3YWl0IHRoaXMuZW1haWxTZXJ2aWNlLnNlbmRFbWFpbCh7XHJcbi8vICAgICAgIHRvOiBlbWFpbCxcclxuLy8gICAgICAgc3ViamVjdDogJ0NvbmZpcm0gWW91ciBBY2NvdW50IERlbGV0aW9uJyxcclxuLy8gICAgICAgdGVtcGxhdGVOYW1lOiAnYWNjb3VudC1kZWxldGlvbi1jb25maXJtYXRpb24nLFxyXG4vLyAgICAgICBjb250ZXh0OiB7XHJcbi8vICAgICAgICAgbmFtZTogdXNlci5maXJzdE5hbWUsXHJcbi8vICAgICAgICAgY29uZmlybWF0aW9uVXJsLFxyXG4vLyAgICAgICAgIGNvbXBhbnlOYW1lOiAnWW91ckNvbXBhbnlOYW1lJyxcclxuLy8gICAgICAgICB1bnN1YnNjcmliZVVybCxcclxuLy8gICAgICAgICB5ZWFyOiBuZXcgRGF0ZSgpLmdldEZ1bGxZZWFyKCksXHJcbi8vICAgICAgIH0sXHJcbi8vICAgICB9KTtcclxuLy8gICAgICAgfSk7XHJcblxyXG4vLyAgICAgICB0aGlzLmxvZ2dlci5sb2coYERlbGV0aW9uIGNvbmZpcm1hdGlvbiBlbWFpbCBzZW50IHRvICR7ZW1haWx9YCk7XHJcbi8vICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4vLyAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihcclxuLy8gICAgICAgICBgRmFpbGVkIHRvIHNlbmQgZGVsZXRpb24gY29uZmlybWF0aW9uIGVtYWlsIHRvICR7ZW1haWx9YCxcclxuLy8gICAgICAgICBlcnJvci5zdGFjayxcclxuLy8gICAgICAgKTtcclxuLy8gICAgICAgdGhyb3cgZXJyb3I7XHJcbi8vICAgICB9XHJcbi8vICAgfVxyXG4vLyB9XHJcblxyXG5cclxuXHJcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XHJcbmltcG9ydCB7IEVtYWlsU2VydmljZSB9IGZyb20gJ3NyYy9lbWFpbC9lbWFpbC5zZXJ2aWNlJztcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEFjY291bnREZWxldGlvbkNvbmZpcm1hdGlvblNlcnZpY2Uge1xyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgZW1haWxTZXJ2aWNlOiBFbWFpbFNlcnZpY2UpIHt9XHJcblxyXG4gIGFzeW5jIHNlbmRBY2NvdW50RGVsZXRpb25FbWFpbCh7XHJcbiAgICBlbWFpbCxcclxuICAgIGZpcnN0TmFtZSxcclxuICAgIGNvbmZpcm1hdGlvblVybCxcclxuICAgIHVuc3Vic2NyaWJlVXJsLFxyXG4gIH06IHtcclxuICAgIGVtYWlsOiBzdHJpbmc7XHJcbiAgICBmaXJzdE5hbWU6IHN0cmluZztcclxuICAgIGNvbmZpcm1hdGlvblVybDogc3RyaW5nO1xyXG4gICAgdW5zdWJzY3JpYmVVcmw6IHN0cmluZztcclxuICB9KSB7XHJcbiAgICBhd2FpdCB0aGlzLmVtYWlsU2VydmljZS5zZW5kRW1haWwoe1xyXG4gICAgICB0bzogZW1haWwsXHJcbiAgICAgIHN1YmplY3Q6ICdDb25maXJtIFlvdXIgQWNjb3VudCBEZWxldGlvbicsXHJcbiAgICAgIHRlbXBsYXRlTmFtZTogJ2FjY291bnQtZGVsZXRpb24tY29uZmlybWF0aW9uJyxcclxuICAgICAgY29udGV4dDoge1xyXG4gICAgICAgIG5hbWU6IGZpcnN0TmFtZSxcclxuICAgICAgICBjb25maXJtYXRpb25VcmwsXHJcbiAgICAgICAgY29tcGFueU5hbWU6ICdZb3VyQ29tcGFueU5hbWUnLCAvLyBZb3UgY2FuIG1ha2UgdGhpcyBkeW5hbWljIHRvb1xyXG4gICAgICAgIHVuc3Vic2NyaWJlVXJsLFxyXG4gICAgICAgIHllYXI6IG5ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKSxcclxuICAgICAgfSxcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgIGFzeW5jIHZhbGlkYXRlQW5kRGVsZXRlQWNjb3VudCh0b2tlbjogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XHJcbiAgICAvLyBZb3VyIHZhbGlkYXRpb24gYW5kIGRlbGV0aW9uIGxvZ2ljIGhlcmVcclxuICAgIHJldHVybiB0cnVlOyAvLyBvciBmYWxzZVxyXG4gIH1cclxufVxyXG5cclxuIl0sInZlcnNpb24iOjN9