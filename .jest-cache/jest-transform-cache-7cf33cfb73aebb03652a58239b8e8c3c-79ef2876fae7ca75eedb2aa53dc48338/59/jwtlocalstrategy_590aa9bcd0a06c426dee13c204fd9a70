6db4bd8af20e0fb5ff32b643d634e7c6
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var _a, _b, _c, _d, _e, _f, _g;
Object.defineProperty(exports, "__esModule", { value: true });
exports.JwtLocalStrategy = void 0;
const common_1 = require("@nestjs/common");
const jwt_1 = require("@nestjs/jwt");
const bcrypt = __importStar(require("bcryptjs"));
const uuid_1 = require("uuid");
const typeorm_1 = require("@nestjs/typeorm");
const typeorm_2 = require("typeorm");
const config_1 = require("@nestjs/config");
const email_service_1 = require("../../email/email.service");
const password_validation_service_1 = require("../password-validation.service");
const auth_token_entity_1 = require("../entities/auth-token.entity");
const refresh_token_entity_1 = require("../entities/refresh-token.entity");
const users_service_1 = require("src/users/services/users.service");
let JwtLocalStrategy = class JwtLocalStrategy {
    constructor(usersService, jwtService, emailService, passwordValidationService, authTokenRepository, refreshTokenRepository, configService) {
        this.usersService = usersService;
        this.jwtService = jwtService;
        this.emailService = emailService;
        this.passwordValidationService = passwordValidationService;
        this.authTokenRepository = authTokenRepository;
        this.refreshTokenRepository = refreshTokenRepository;
        this.configService = configService;
    }
    validate(credentials) {
        throw new Error('Method not implemented.');
    }
    async validateUser(email, password) {
        const user = await this.usersService.findByEmail(email);
        if (!user)
            throw new common_1.UnauthorizedException('Invalid credentials');
        const isPasswordValid = await bcrypt.compare(password, user.password);
        if (!isPasswordValid)
            throw new common_1.UnauthorizedException('Invalid credentials');
        if (!user.isEmailVerified) {
            throw new common_1.UnauthorizedException('Please verify your email first');
        }
        try {
            await this.emailService.sendEmail({
                to: user.email,
                subject: 'Welcome to Our Platform',
                templateName: 'welcome',
                context: {
                    name: user.firstName,
                    year: new Date().getFullYear(),
                },
            });
        }
        catch (error) {
            console.error('Error sending welcome email:', error);
        }
        return user;
    }
    async validatePassword(password) {
        const validationResult = this.passwordValidationService.validatePassword(password);
        if (!validationResult.isValid) {
            throw new common_1.BadRequestException({
                message: 'Password does not meet requirements',
                errors: validationResult.errors,
            });
        }
        return true;
    }
    async register(credentials) {
        const { email, password, ...userData } = credentials;
        await this.validatePassword(password);
        const existingUser = await this.usersService.findByEmail(email);
        if (existingUser)
            throw new common_1.BadRequestException('User already exists');
        const hashedPassword = await bcrypt.hash(password, 10);
        const user = await this.usersService.create({
            email,
            password: hashedPassword,
            ...userData,
        });
        return this.login(user);
    }
    async generateTokens(user) {
        const payload = {
            sub: user.id,
            email: user.email,
            roles: user.role,
        };
        const [accessToken, refreshToken] = await Promise.all([
            this.jwtService.signAsync(payload, {
                secret: this.configService.get('JWT_SECRET'),
                expiresIn: '1h',
            }),
            this.jwtService.signAsync(payload, {
                secret: this.configService.get('REFRESH_TOKEN_SECRET'),
                expiresIn: '7d',
            }),
        ]);
        const hashedRefreshToken = await bcrypt.hash(refreshToken, 10);
        await this.usersService.updateRefreshToken(user.id, hashedRefreshToken);
        return {
            accessToken,
            refreshToken,
            expiresIn: 3600,
        };
    }
    async login(user) {
        const tokens = await this.generateTokens(user);
        return {
            access_token: tokens.accessToken,
            refresh_token: tokens.refreshToken,
            expires_in: tokens.expiresIn,
            user: {
                id: user.id,
                email: user.email,
                roles: user.roles,
            },
        };
    }
    async refreshToken(userId, refreshToken) {
        try {
            await this.jwtService.verify(refreshToken, {
                secret: this.configService.get('REFRESH_TOKEN_SECRET'),
            });
            const tokenEntity = await this.refreshTokenRepository.findOne({
                where: {
                    userId,
                    isRevoked: false,
                    expiresAt: (0, typeorm_2.MoreThan)(new Date()),
                },
            });
            if (!tokenEntity)
                throw new common_1.UnauthorizedException('Invalid or expired refresh token');
            const isTokenValid = await bcrypt.compare(refreshToken, tokenEntity.token);
            if (!isTokenValid)
                throw new common_1.UnauthorizedException('Invalid refresh token');
            await this.refreshTokenRepository.update(tokenEntity.id, { isRevoked: true });
            const user = await this.usersService.findOne(userId);
            return this.generateTokens(user);
        }
        catch (error) {
            throw new common_1.UnauthorizedException('Invalid refresh token');
        }
    }
    async revokeUserRefreshTokens(userId) {
        try {
            await this.refreshTokenRepository.update({ userId, isRevoked: false }, { isRevoked: true });
        }
        catch (error) {
            throw new common_1.InternalServerErrorException('Error revoking refresh tokens');
        }
    }
    async logout(userId) {
        await this.usersService.updateRefreshToken(userId, null);
        return { message: 'Logged out successfully' };
    }
    async validateToken(token) {
        try {
            const payload = await this.jwtService.verifyAsync(token, {
                secret: this.configService.get('JWT_SECRET'),
            });
            return payload;
        }
        catch {
            throw new common_1.UnauthorizedException('Invalid token');
        }
    }
    async forgotPassword(email) {
        const user = await this.usersService.findOne(email);
        if (!user)
            throw new common_1.NotFoundException('User with this email does not exist.');
        const token = (0, uuid_1.v4)();
        const expiresAt = addMinutes(new Date(), 15);
        const resetToken = this.authTokenRepository.create({
            user,
            token,
            expiresAt,
            purpose: 'reset_password',
            isRevoked: false,
        });
        await this.authTokenRepository.save(resetToken);
        await this.emailService.sendEmail({
            to: user.email,
            subject: 'Password Reset Request',
            templateName: 'reset-password',
            context: {
                name: user.firstName,
                token,
            },
        });
        return { message: 'Password reset email sent' };
    }
    async validateResetToken(token) {
        const authToken = await this.authTokenRepository.findOne({
            where: { token, purpose: 'reset_password', isRevoked: false },
            relations: ['user'],
        });
        if (!authToken || authToken.expiresAt < new Date()) {
            throw new common_1.BadRequestException('Invalid or expired password reset token.');
        }
        return authToken.user;
    }
    async resetPassword(token, newPassword) {
        const authToken = await this.authTokenRepository.findOne({
            where: { token, purpose: 'reset_password', isRevoked: false },
            relations: ['user'],
        });
        if (!authToken || authToken.expiresAt < new Date()) {
            throw new common_1.BadRequestException('Invalid or expired password reset token.');
        }
        const user = authToken.user;
        const hashedPassword = await bcrypt.hash(newPassword, 10);
        authToken.isRevoked = true;
        await this.authTokenRepository.save(authToken);
        return { message: 'Password successfully reset' };
    }
    async requestPasswordReset(email) {
        // Implement your password reset logic here, e.g., generate token, send email, etc.
        // For now, just return a placeholder response.
        return { message: `Password reset link sent to ${email}` };
    }
    async changePassword(userId, currentPassword, newPassword) {
        const user = await this.usersService.findOne(userId);
        if (!user)
            throw new common_1.UnauthorizedException('User not found');
        const isCurrentPasswordValid = await bcrypt.compare(currentPassword, user.password);
        if (!isCurrentPasswordValid)
            throw new common_1.BadRequestException('Current password is incorrect');
        await this.validatePassword(newPassword);
        const hashedPassword = await bcrypt.hash(newPassword, 10);
        await this.revokeUserRefreshTokens(userId);
        return true;
    }
};
exports.JwtLocalStrategy = JwtLocalStrategy;
exports.JwtLocalStrategy = JwtLocalStrategy = __decorate([
    (0, common_1.Injectable)(),
    __param(4, (0, typeorm_1.InjectRepository)(auth_token_entity_1.AuthToken)),
    __param(5, (0, typeorm_1.InjectRepository)(refresh_token_entity_1.RefreshToken)),
    __metadata("design:paramtypes", [typeof (_a = typeof users_service_1.UsersService !== "undefined" && users_service_1.UsersService) === "function" ? _a : Object, typeof (_b = typeof jwt_1.JwtService !== "undefined" && jwt_1.JwtService) === "function" ? _b : Object, typeof (_c = typeof email_service_1.EmailService !== "undefined" && email_service_1.EmailService) === "function" ? _c : Object, typeof (_d = typeof password_validation_service_1.PasswordValidationService !== "undefined" && password_validation_service_1.PasswordValidationService) === "function" ? _d : Object, typeof (_e = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _e : Object, typeof (_f = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _f : Object, typeof (_g = typeof config_1.ConfigService !== "undefined" && config_1.ConfigService) === "function" ? _g : Object])
], JwtLocalStrategy);
function addMinutes(date, minutes) {
    return new Date(date.getTime() + minutes * 60000);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxvam9zZXBoXFxEb2N1bWVudHNcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFxhdXRoXFxzdHJhdGVnaWVzXFxqd3QtbG9jYWwuc3RyYXRlZ3kudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQU13QjtBQUN4QixxQ0FBeUM7QUFDekMsaURBQW1DO0FBRW5DLCtCQUFvQztBQUNwQyw2Q0FBbUQ7QUFDbkQscUNBQStDO0FBQy9DLDJDQUErQztBQUcvQyw2REFBeUQ7QUFDekQsZ0ZBQTJFO0FBQzNFLHFFQUEwRDtBQUMxRCwyRUFBZ0U7QUFDaEUsb0VBQWdFO0FBSXpELElBQU0sZ0JBQWdCLEdBQXRCLE1BQU0sZ0JBQWdCO0lBQzNCLFlBQ21CLFlBQTBCLEVBQzFCLFVBQXNCLEVBQ3RCLFlBQTBCLEVBQzFCLHlCQUFvRCxFQUVwRCxtQkFBMEMsRUFFMUMsc0JBQWdELEVBQ2hELGFBQTRCO1FBUjVCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLGVBQVUsR0FBVixVQUFVLENBQVk7UUFDdEIsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDMUIsOEJBQXlCLEdBQXpCLHlCQUF5QixDQUEyQjtRQUVwRCx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXVCO1FBRTFDLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FBMEI7UUFDaEQsa0JBQWEsR0FBYixhQUFhLENBQWU7SUFDNUMsQ0FBQztJQUVKLFFBQVEsQ0FBQyxXQUFnQjtRQUN2QixNQUFNLElBQUksS0FBSyxDQUFDLHlCQUF5QixDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUVELEtBQUssQ0FBQyxZQUFZLENBQUMsS0FBYSxFQUFFLFFBQWdCO1FBQ2hELE1BQU0sSUFBSSxHQUFHLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDeEQsSUFBSSxDQUFDLElBQUk7WUFBRSxNQUFNLElBQUksOEJBQXFCLENB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QkFBZ0IsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUV6QyxNQUFNLGNBQWMsR0FBRyxNQUFNLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRTFELE1BQU0sSUFBSSxDQUFDLHVCQUF1QixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRTNDLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztDQUNGLENBQUE7QUE5UFksNENBQWdCOzJCQUFoQixnQkFBZ0I7SUFENUIsSUFBQSxtQkFBVSxHQUFFO0lBT1IsV0FBQSxJQUFBLDBCQUFnQixFQUFDLDZCQUFTLENBQUMsQ0FBQTtJQUUzQixXQUFBLElBQUEsMEJBQWdCLEVBQUMsbUNBQVksQ0FBQyxDQUFBO3lEQU5BLDRCQUFZLG9CQUFaLDRCQUFZLG9EQUNkLGdCQUFVLG9CQUFWLGdCQUFVLG9EQUNSLDRCQUFZLG9CQUFaLDRCQUFZLG9EQUNDLHVEQUF5QixvQkFBekIsdURBQXlCLG9EQUUvQixvQkFBVSxvQkFBVixvQkFBVSxvREFFUCxvQkFBVSxvQkFBVixvQkFBVSxvREFDbkIsc0JBQWEsb0JBQWIsc0JBQWE7R0FWcEMsZ0JBQWdCLENBOFA1QjtBQUNELFNBQVMsVUFBVSxDQUFDLElBQVUsRUFBRSxPQUFlO0lBQzdDLE9BQU8sSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxHQUFHLE9BQU8sR0FBRyxLQUFLLENBQUMsQ0FBQztBQUNwRCxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcb2pvc2VwaFxcRG9jdW1lbnRzXFxTdHJlbGxlck1pbmRzLUJhY2tlbmRcXHNyY1xcYXV0aFxcc3RyYXRlZ2llc1xcand0LWxvY2FsLnN0cmF0ZWd5LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XHJcbiAgQmFkUmVxdWVzdEV4Y2VwdGlvbixcclxuICBJbmplY3RhYmxlLFxyXG4gIFVuYXV0aG9yaXplZEV4Y2VwdGlvbixcclxuICBOb3RGb3VuZEV4Y2VwdGlvbixcclxuICBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uLFxyXG59IGZyb20gJ0BuZXN0anMvY29tbW9uJztcclxuaW1wb3J0IHsgSnd0U2VydmljZSB9IGZyb20gJ0BuZXN0anMvand0JztcclxuaW1wb3J0ICogYXMgYmNyeXB0IGZyb20gJ2JjcnlwdGpzJztcclxuaW1wb3J0ICogYXMgY3J5cHRvIGZyb20gJ2NyeXB0byc7XHJcbmltcG9ydCB7IHY0IGFzIHV1aWR2NCB9IGZyb20gJ3V1aWQnO1xyXG5pbXBvcnQgeyBJbmplY3RSZXBvc2l0b3J5IH0gZnJvbSAnQG5lc3Rqcy90eXBlb3JtJztcclxuaW1wb3J0IHsgUmVwb3NpdG9yeSwgTW9yZVRoYW4gfSBmcm9tICd0eXBlb3JtJztcclxuaW1wb3J0IHsgQ29uZmlnU2VydmljZSB9IGZyb20gJ0BuZXN0anMvY29uZmlnJztcclxuXHJcbmltcG9ydCB7IEF1dGhSZXNwb25zZUR0byB9IGZyb20gJy4uL2R0by9hdXRoLXJlc3BvbnNlLmR0byc7XHJcbmltcG9ydCB7IEVtYWlsU2VydmljZSB9IGZyb20gJy4uLy4uL2VtYWlsL2VtYWlsLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBQYXNzd29yZFZhbGlkYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi4vcGFzc3dvcmQtdmFsaWRhdGlvbi5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQXV0aFRva2VuIH0gZnJvbSAnLi4vZW50aXRpZXMvYXV0aC10b2tlbi5lbnRpdHknO1xyXG5pbXBvcnQgeyBSZWZyZXNoVG9rZW4gfSBmcm9tICcuLi9lbnRpdGllcy9yZWZyZXNoLXRva2VuLmVudGl0eSc7XHJcbmltcG9ydCB7IFVzZXJzU2VydmljZSB9IGZyb20gJ3NyYy91c2Vycy9zZXJ2aWNlcy91c2Vycy5zZXJ2aWNlJztcclxuaW1wb3J0IHsgSUF1dGhTdHJhdGVneSB9IGZyb20gJy4vYXV0aC1zdHJhdGVneS5pbnRlcmZhY2UnO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgSnd0TG9jYWxTdHJhdGVneSBpbXBsZW1lbnRzIElBdXRoU3RyYXRlZ3kge1xyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSByZWFkb25seSB1c2Vyc1NlcnZpY2U6IFVzZXJzU2VydmljZSxcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgand0U2VydmljZTogSnd0U2VydmljZSxcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgZW1haWxTZXJ2aWNlOiBFbWFpbFNlcnZpY2UsXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IHBhc3N3b3JkVmFsaWRhdGlvblNlcnZpY2U6IFBhc3N3b3JkVmFsaWRhdGlvblNlcnZpY2UsXHJcbiAgICBASW5qZWN0UmVwb3NpdG9yeShBdXRoVG9rZW4pXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IGF1dGhUb2tlblJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8QXV0aFRva2VuPixcclxuICAgIEBJbmplY3RSZXBvc2l0b3J5KFJlZnJlc2hUb2tlbilcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgcmVmcmVzaFRva2VuUmVwb3NpdG9yeTogUmVwb3NpdG9yeTxSZWZyZXNoVG9rZW4+LFxyXG4gICAgcHJpdmF0ZSByZWFkb25seSBjb25maWdTZXJ2aWNlOiBDb25maWdTZXJ2aWNlLFxyXG4gICkge31cclxuICBuYW1lOiBzdHJpbmc7XHJcbiAgdmFsaWRhdGUoY3JlZGVudGlhbHM6IGFueSk6IFByb21pc2U8YW55PiB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ01ldGhvZCBub3QgaW1wbGVtZW50ZWQuJyk7XHJcbiAgfVxyXG5cclxuICBhc3luYyB2YWxpZGF0ZVVzZXIoZW1haWw6IHN0cmluZywgcGFzc3dvcmQ6IHN0cmluZyk6IFByb21pc2U8YW55PiB7XHJcbiAgICBjb25zdCB1c2VyID0gYXdhaXQgdGhpcy51c2Vyc1NlcnZpY2UuZmluZEJ5RW1haWwoZW1haWwpO1xyXG4gICAgaWYgKCF1c2VyKSB0aHJvdyBuZXcgVW5hdXRob3JpemVkRXhjZXB0aW9uKCdJbnZhbGlkIGNyZWRlbnRpYWxzJyk7XHJcblxyXG4gICAgY29uc3QgaXNQYXNzd29yZFZhbGlkID0gYXdhaXQgYmNyeXB0LmNvbXBhcmUocGFzc3dvcmQsIHVzZXIucGFzc3dvcmQpO1xyXG4gICAgaWYgKCFpc1Bhc3N3b3JkVmFsaWQpIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFeGNlcHRpb24oJ0ludmFsaWQgY3JlZGVudGlhbHMnKTtcclxuXHJcbiAgICBpZiAoIXVzZXIuaXNFbWFpbFZlcmlmaWVkKSB7XHJcbiAgICAgIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFeGNlcHRpb24oJ1BsZWFzZSB2ZXJpZnkgeW91ciBlbWFpbCBmaXJzdCcpO1xyXG4gICAgfVxyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgIGF3YWl0IHRoaXMuZW1haWxTZXJ2aWNlLnNlbmRFbWFpbCh7XHJcbiAgICAgICAgdG86IHVzZXIuZW1haWwsXHJcbiAgICAgICAgc3ViamVjdDogJ1dlbGNvbWUgdG8gT3VyIFBsYXRmb3JtJyxcclxuICAgICAgICB0ZW1wbGF0ZU5hbWU6ICd3ZWxjb21lJyxcclxuICAgICAgICBjb250ZXh0OiB7XHJcbiAgICAgICAgICBuYW1lOiB1c2VyLmZpcnN0TmFtZSxcclxuICAgICAgICAgIHllYXI6IG5ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKSxcclxuICAgICAgICB9LFxyXG4gICAgICB9KTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHNlbmRpbmcgd2VsY29tZSBlbWFpbDonLCBlcnJvcik7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHVzZXI7XHJcbiAgfVxyXG5cclxuICBhc3luYyB2YWxpZGF0ZVBhc3N3b3JkKHBhc3N3b3JkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcclxuICAgIGNvbnN0IHZhbGlkYXRpb25SZXN1bHQgPSB0aGlzLnBhc3N3b3JkVmFsaWRhdGlvblNlcnZpY2UudmFsaWRhdGVQYXNzd29yZChwYXNzd29yZCk7XHJcbiAgICBpZiAoIXZhbGlkYXRpb25SZXN1bHQuaXNWYWxpZCkge1xyXG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbih7XHJcbiAgICAgICAgbWVzc2FnZTogJ1Bhc3N3b3JkIGRvZXMgbm90IG1lZXQgcmVxdWlyZW1lbnRzJyxcclxuICAgICAgICBlcnJvcnM6IHZhbGlkYXRpb25SZXN1bHQuZXJyb3JzLFxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgcmVnaXN0ZXIoY3JlZGVudGlhbHM6IGFueSk6IFByb21pc2U8QXV0aFJlc3BvbnNlRHRvPiB7XHJcbiAgICBjb25zdCB7IGVtYWlsLCBwYXNzd29yZCwgLi4udXNlckRhdGEgfSA9IGNyZWRlbnRpYWxzO1xyXG4gICAgYXdhaXQgdGhpcy52YWxpZGF0ZVBhc3N3b3JkKHBhc3N3b3JkKTtcclxuXHJcbiAgICBjb25zdCBleGlzdGluZ1VzZXIgPSBhd2FpdCB0aGlzLnVzZXJzU2VydmljZS5maW5kQnlFbWFpbChlbWFpbCk7XHJcbiAgICBpZiAoZXhpc3RpbmdVc2VyKSB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignVXNlciBhbHJlYWR5IGV4aXN0cycpO1xyXG5cclxuICAgIGNvbnN0IGhhc2hlZFBhc3N3b3JkID0gYXdhaXQgYmNyeXB0Lmhhc2gocGFzc3dvcmQsIDEwKTtcclxuXHJcbiAgICBjb25zdCB1c2VyID0gYXdhaXQgdGhpcy51c2Vyc1NlcnZpY2UuY3JlYXRlKHtcclxuICAgICAgZW1haWwsXHJcbiAgICAgIHBhc3N3b3JkOiBoYXNoZWRQYXNzd29yZCxcclxuICAgICAgLi4udXNlckRhdGEsXHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gdGhpcy5sb2dpbih1c2VyKTtcclxuICB9XHJcblxyXG4gIGFzeW5jIGdlbmVyYXRlVG9rZW5zKHVzZXI6IGFueSkge1xyXG4gICAgY29uc3QgcGF5bG9hZCA9IHtcclxuICAgICAgc3ViOiB1c2VyLmlkLFxyXG4gICAgICBlbWFpbDogdXNlci5lbWFpbCxcclxuICAgICAgcm9sZXM6IHVzZXIucm9sZSxcclxuICAgIH07XHJcblxyXG4gICAgY29uc3QgW2FjY2Vzc1Rva2VuLCByZWZyZXNoVG9rZW5dID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xyXG4gICAgICB0aGlzLmp3dFNlcnZpY2Uuc2lnbkFzeW5jKHBheWxvYWQsIHtcclxuICAgICAgICBzZWNyZXQ6IHRoaXMuY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPignSldUX1NFQ1JFVCcpLFxyXG4gICAgICAgIGV4cGlyZXNJbjogJzFoJyxcclxuICAgICAgfSksXHJcbiAgICAgIHRoaXMuand0U2VydmljZS5zaWduQXN5bmMocGF5bG9hZCwge1xyXG4gICAgICAgIHNlY3JldDogdGhpcy5jb25maWdTZXJ2aWNlLmdldDxzdHJpbmc+KCdSRUZSRVNIX1RPS0VOX1NFQ1JFVCcpLFxyXG4gICAgICAgIGV4cGlyZXNJbjogJzdkJyxcclxuICAgICAgfSksXHJcbiAgICBdKTtcclxuXHJcbiAgICBjb25zdCBoYXNoZWRSZWZyZXNoVG9rZW4gPSBhd2FpdCBiY3J5cHQuaGFzaChyZWZyZXNoVG9rZW4sIDEwKTtcclxuICAgIGF3YWl0IHRoaXMudXNlcnNTZXJ2aWNlLnVwZGF0ZVJlZnJlc2hUb2tlbih1c2VyLmlkLCBoYXNoZWRSZWZyZXNoVG9rZW4pO1xyXG5cclxuICAgIHJldHVybiB7XHJcbiAgICAgIGFjY2Vzc1Rva2VuLFxyXG4gICAgICByZWZyZXNoVG9rZW4sXHJcbiAgICAgIGV4cGlyZXNJbjogMzYwMCxcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBhc3luYyBsb2dpbih1c2VyOiBhbnkpOiBQcm9taXNlPEF1dGhSZXNwb25zZUR0bz4ge1xyXG4gICAgY29uc3QgdG9rZW5zID0gYXdhaXQgdGhpcy5nZW5lcmF0ZVRva2Vucyh1c2VyKTtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIGFjY2Vzc190b2tlbjogdG9rZW5zLmFjY2Vzc1Rva2VuLFxyXG4gICAgICByZWZyZXNoX3Rva2VuOiB0b2tlbnMucmVmcmVzaFRva2VuLFxyXG4gICAgICBleHBpcmVzX2luOiB0b2tlbnMuZXhwaXJlc0luLFxyXG4gICAgICB1c2VyOiB7XHJcbiAgICAgICAgaWQ6IHVzZXIuaWQsXHJcbiAgICAgICAgZW1haWw6IHVzZXIuZW1haWwsXHJcbiAgICAgICAgcm9sZXM6IHVzZXIucm9sZXMsXHJcbiAgICAgIH0sXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgcmVmcmVzaFRva2VuKHVzZXJJZDogc3RyaW5nLCByZWZyZXNoVG9rZW46IHN0cmluZykge1xyXG4gICAgdHJ5IHtcclxuICAgICAgYXdhaXQgdGhpcy5qd3RTZXJ2aWNlLnZlcmlmeShyZWZyZXNoVG9rZW4sIHtcclxuICAgICAgICBzZWNyZXQ6IHRoaXMuY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPignUkVGUkVTSF9UT0tFTl9TRUNSRVQnKSxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBjb25zdCB0b2tlbkVudGl0eSA9IGF3YWl0IHRoaXMucmVmcmVzaFRva2VuUmVwb3NpdG9yeS5maW5kT25lKHtcclxuICAgICAgICB3aGVyZToge1xyXG4gICAgICAgICAgdXNlcklkLFxyXG4gICAgICAgICAgaXNSZXZva2VkOiBmYWxzZSxcclxuICAgICAgICAgIGV4cGlyZXNBdDogTW9yZVRoYW4obmV3IERhdGUoKSksXHJcbiAgICAgICAgfSxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBpZiAoIXRva2VuRW50aXR5KSB0aHJvdyBuZXcgVW5hdXRob3JpemVkRXhjZXB0aW9uKCdJbnZhbGlkIG9yIGV4cGlyZWQgcmVmcmVzaCB0b2tlbicpO1xyXG5cclxuICAgICAgY29uc3QgaXNUb2tlblZhbGlkID0gYXdhaXQgYmNyeXB0LmNvbXBhcmUocmVmcmVzaFRva2VuLCB0b2tlbkVudGl0eS50b2tlbik7XHJcbiAgICAgIGlmICghaXNUb2tlblZhbGlkKSB0aHJvdyBuZXcgVW5hdXRob3JpemVkRXhjZXB0aW9uKCdJbnZhbGlkIHJlZnJlc2ggdG9rZW4nKTtcclxuXHJcbiAgICAgIGF3YWl0IHRoaXMucmVmcmVzaFRva2VuUmVwb3NpdG9yeS51cGRhdGUodG9rZW5FbnRpdHkuaWQsIHsgaXNSZXZva2VkOiB0cnVlIH0pO1xyXG5cclxuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMudXNlcnNTZXJ2aWNlLmZpbmRPbmUodXNlcklkKTtcclxuICAgICAgcmV0dXJuIHRoaXMuZ2VuZXJhdGVUb2tlbnModXNlcik7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICB0aHJvdyBuZXcgVW5hdXRob3JpemVkRXhjZXB0aW9uKCdJbnZhbGlkIHJlZnJlc2ggdG9rZW4nKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIHJldm9rZVVzZXJSZWZyZXNoVG9rZW5zKHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBhd2FpdCB0aGlzLnJlZnJlc2hUb2tlblJlcG9zaXRvcnkudXBkYXRlKFxyXG4gICAgICAgIHsgdXNlcklkLCBpc1Jldm9rZWQ6IGZhbHNlIH0sXHJcbiAgICAgICAgeyBpc1Jldm9rZWQ6IHRydWUgfSxcclxuICAgICAgKTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKCdFcnJvciByZXZva2luZyByZWZyZXNoIHRva2VucycpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgbG9nb3V0KHVzZXJJZDogc3RyaW5nKSB7XHJcbiAgICBhd2FpdCB0aGlzLnVzZXJzU2VydmljZS51cGRhdGVSZWZyZXNoVG9rZW4odXNlcklkLCBudWxsKTtcclxuICAgIHJldHVybiB7IG1lc3NhZ2U6ICdMb2dnZWQgb3V0IHN1Y2Nlc3NmdWxseScgfTtcclxuICB9XHJcblxyXG4gIGFzeW5jIHZhbGlkYXRlVG9rZW4odG9rZW46IHN0cmluZykge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgcGF5bG9hZCA9IGF3YWl0IHRoaXMuand0U2VydmljZS52ZXJpZnlBc3luYyh0b2tlbiwge1xyXG4gICAgICAgIHNlY3JldDogdGhpcy5jb25maWdTZXJ2aWNlLmdldDxzdHJpbmc+KCdKV1RfU0VDUkVUJyksXHJcbiAgICAgIH0pO1xyXG4gICAgICByZXR1cm4gcGF5bG9hZDtcclxuICAgIH0gY2F0Y2gge1xyXG4gICAgICB0aHJvdyBuZXcgVW5hdXRob3JpemVkRXhjZXB0aW9uKCdJbnZhbGlkIHRva2VuJyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhc3luYyBmb3Jnb3RQYXNzd29yZChlbWFpbDogc3RyaW5nKSB7XHJcbiAgICBjb25zdCB1c2VyID0gYXdhaXQgdGhpcy51c2Vyc1NlcnZpY2UuZmluZE9uZShlbWFpbCk7XHJcbiAgICBpZiAoIXVzZXIpIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignVXNlciB3aXRoIHRoaXMgZW1haWwgZG9lcyBub3QgZXhpc3QuJyk7XHJcblxyXG4gICAgY29uc3QgdG9rZW4gPSB1dWlkdjQoKTtcclxuICAgIGNvbnN0IGV4cGlyZXNBdCA9IGFkZE1pbnV0ZXMobmV3IERhdGUoKSwgMTUpO1xyXG5cclxuICAgIGNvbnN0IHJlc2V0VG9rZW4gPSB0aGlzLmF1dGhUb2tlblJlcG9zaXRvcnkuY3JlYXRlKHtcclxuICAgICAgdXNlcixcclxuICAgICAgdG9rZW4sXHJcbiAgICAgIGV4cGlyZXNBdCxcclxuICAgICAgcHVycG9zZTogJ3Jlc2V0X3Bhc3N3b3JkJyxcclxuICAgICAgaXNSZXZva2VkOiBmYWxzZSxcclxuICAgIH0pO1xyXG5cclxuICAgIGF3YWl0IHRoaXMuYXV0aFRva2VuUmVwb3NpdG9yeS5zYXZlKHJlc2V0VG9rZW4pO1xyXG5cclxuICAgIGF3YWl0IHRoaXMuZW1haWxTZXJ2aWNlLnNlbmRFbWFpbCh7XHJcbiAgICAgIHRvOiB1c2VyLmVtYWlsLFxyXG4gICAgICBzdWJqZWN0OiAnUGFzc3dvcmQgUmVzZXQgUmVxdWVzdCcsXHJcbiAgICAgIHRlbXBsYXRlTmFtZTogJ3Jlc2V0LXBhc3N3b3JkJyxcclxuICAgICAgY29udGV4dDoge1xyXG4gICAgICAgIG5hbWU6IHVzZXIuZmlyc3ROYW1lLFxyXG4gICAgICAgIHRva2VuLFxyXG4gICAgICB9LFxyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIHsgbWVzc2FnZTogJ1Bhc3N3b3JkIHJlc2V0IGVtYWlsIHNlbnQnIH07XHJcbiAgfVxyXG5cclxuICBhc3luYyB2YWxpZGF0ZVJlc2V0VG9rZW4odG9rZW46IHN0cmluZykge1xyXG4gICAgY29uc3QgYXV0aFRva2VuID0gYXdhaXQgdGhpcy5hdXRoVG9rZW5SZXBvc2l0b3J5LmZpbmRPbmUoe1xyXG4gICAgICB3aGVyZTogeyB0b2tlbiwgcHVycG9zZTogJ3Jlc2V0X3Bhc3N3b3JkJywgaXNSZXZva2VkOiBmYWxzZSB9LFxyXG4gICAgICByZWxhdGlvbnM6IFsndXNlciddLFxyXG4gICAgfSk7XHJcblxyXG4gICAgaWYgKCFhdXRoVG9rZW4gfHwgYXV0aFRva2VuLmV4cGlyZXNBdCA8IG5ldyBEYXRlKCkpIHtcclxuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ0ludmFsaWQgb3IgZXhwaXJlZCBwYXNzd29yZCByZXNldCB0b2tlbi4nKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gYXV0aFRva2VuLnVzZXI7XHJcbiAgfVxyXG5cclxuICBhc3luYyByZXNldFBhc3N3b3JkKHRva2VuOiBzdHJpbmcsIG5ld1Bhc3N3b3JkOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IGF1dGhUb2tlbiA9IGF3YWl0IHRoaXMuYXV0aFRva2VuUmVwb3NpdG9yeS5maW5kT25lKHtcclxuICAgICAgd2hlcmU6IHsgdG9rZW4sIHB1cnBvc2U6ICdyZXNldF9wYXNzd29yZCcsIGlzUmV2b2tlZDogZmFsc2UgfSxcclxuICAgICAgcmVsYXRpb25zOiBbJ3VzZXInXSxcclxuICAgIH0pO1xyXG5cclxuICAgIGlmICghYXV0aFRva2VuIHx8IGF1dGhUb2tlbi5leHBpcmVzQXQgPCBuZXcgRGF0ZSgpKSB7XHJcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdJbnZhbGlkIG9yIGV4cGlyZWQgcGFzc3dvcmQgcmVzZXQgdG9rZW4uJyk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgdXNlciA9IGF1dGhUb2tlbi51c2VyO1xyXG4gICAgY29uc3QgaGFzaGVkUGFzc3dvcmQgPSBhd2FpdCBiY3J5cHQuaGFzaChuZXdQYXNzd29yZCwgMTApO1xyXG5cclxuICAgIGF1dGhUb2tlbi5pc1Jldm9rZWQgPSB0cnVlO1xyXG4gICAgYXdhaXQgdGhpcy5hdXRoVG9rZW5SZXBvc2l0b3J5LnNhdmUoYXV0aFRva2VuKTtcclxuXHJcbiAgICByZXR1cm4geyBtZXNzYWdlOiAnUGFzc3dvcmQgc3VjY2Vzc2Z1bGx5IHJlc2V0JyB9O1xyXG4gIH1cclxuXHJcblxyXG4gIGFzeW5jIHJlcXVlc3RQYXNzd29yZFJlc2V0KGVtYWlsOiBzdHJpbmcpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgLy8gSW1wbGVtZW50IHlvdXIgcGFzc3dvcmQgcmVzZXQgbG9naWMgaGVyZSwgZS5nLiwgZ2VuZXJhdGUgdG9rZW4sIHNlbmQgZW1haWwsIGV0Yy5cclxuICAgIC8vIEZvciBub3csIGp1c3QgcmV0dXJuIGEgcGxhY2Vob2xkZXIgcmVzcG9uc2UuXHJcbiAgICByZXR1cm4geyBtZXNzYWdlOiBgUGFzc3dvcmQgcmVzZXQgbGluayBzZW50IHRvICR7ZW1haWx9YCB9O1xyXG4gIH1cclxuICBhc3luYyBjaGFuZ2VQYXNzd29yZCh1c2VySWQ6IHN0cmluZywgY3VycmVudFBhc3N3b3JkOiBzdHJpbmcsIG5ld1Bhc3N3b3JkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcclxuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnVzZXJzU2VydmljZS5maW5kT25lKHVzZXJJZCk7XHJcbiAgICBpZiAoIXVzZXIpIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFeGNlcHRpb24oJ1VzZXIgbm90IGZvdW5kJyk7XHJcblxyXG4gICAgY29uc3QgaXNDdXJyZW50UGFzc3dvcmRWYWxpZCA9IGF3YWl0IGJjcnlwdC5jb21wYXJlKGN1cnJlbnRQYXNzd29yZCwgdXNlci5wYXNzd29yZCk7XHJcbiAgICBpZiAoIWlzQ3VycmVudFBhc3N3b3JkVmFsaWQpIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdDdXJyZW50IHBhc3N3b3JkIGlzIGluY29ycmVjdCcpO1xyXG5cclxuICAgIGF3YWl0IHRoaXMudmFsaWRhdGVQYXNzd29yZChuZXdQYXNzd29yZCk7XHJcblxyXG4gICAgY29uc3QgaGFzaGVkUGFzc3dvcmQgPSBhd2FpdCBiY3J5cHQuaGFzaChuZXdQYXNzd29yZCwgMTApO1xyXG5cclxuICAgIGF3YWl0IHRoaXMucmV2b2tlVXNlclJlZnJlc2hUb2tlbnModXNlcklkKTtcclxuXHJcbiAgICByZXR1cm4gdHJ1ZTtcclxuICB9XHJcbn1cclxuZnVuY3Rpb24gYWRkTWludXRlcyhkYXRlOiBEYXRlLCBtaW51dGVzOiBudW1iZXIpOiBEYXRlIHtcclxuICByZXR1cm4gbmV3IERhdGUoZGF0ZS5nZXRUaW1lKCkgKyBtaW51dGVzICogNjAwMDApO1xyXG59XHJcblxyXG4iXSwidmVyc2lvbiI6M30=