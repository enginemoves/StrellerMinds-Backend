deb8d53bd34289c1b18d9e7a6b771549
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var DataGovernanceService_1;
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.DataGovernanceService = void 0;
const common_1 = require("@nestjs/common");
const schedule_1 = require("@nestjs/schedule");
const data_governance_policy_entity_1 = require("../entities/data-governance-policy.entity");
let DataGovernanceService = DataGovernanceService_1 = class DataGovernanceService {
    constructor(policyRepository, lineageRepository) {
        this.policyRepository = policyRepository;
        this.lineageRepository = lineageRepository;
        this.logger = new common_1.Logger(DataGovernanceService_1.name);
    }
    async createPolicy(policyData) {
        const policy = this.policyRepository.create(policyData);
        return this.policyRepository.save(policy);
    }
    async updatePolicy(id, updates) {
        await this.policyRepository.update(id, updates);
        const policy = await this.policyRepository.findOne({ where: { id } });
        if (!policy) {
            throw new Error(`Policy with id ${id} not found`);
        }
        return policy;
    }
    async activatePolicy(id) {
        await this.policyRepository.update(id, {
            status: data_governance_policy_entity_1.PolicyStatus.ACTIVE,
            effectiveDate: new Date(),
        });
    }
    async deactivatePolicy(id) {
        await this.policyRepository.update(id, { status: data_governance_policy_entity_1.PolicyStatus.INACTIVE });
    }
    async getPolicies(filters) {
        const query = this.policyRepository.createQueryBuilder("policy");
        if (filters.policyType) {
            query.andWhere("policy.policyType = :policyType", { policyType: filters.policyType });
        }
        if (filters.status) {
            query.andWhere("policy.status = :status", { status: filters.status });
        }
        if (filters.entityType) {
            query.andWhere("policy.entityType = :entityType", { entityType: filters.entityType });
        }
        return query.orderBy("policy.createdAt", "DESC").getMany();
    }
    async checkPolicyCompliance(entityType, data) {
        const policies = await this.getPolicies({
            entityType,
            status: data_governance_policy_entity_1.PolicyStatus.ACTIVE,
        });
        const violations = [];
        for (const policy of policies) {
            const policyViolations = await this.validatePolicy(policy, data);
            violations.push(...policyViolations);
        }
        return {
            compliant: violations.length === 0,
            violations,
        };
    }
    async validatePolicy(policy, data) {
        const violations = [];
        switch (policy.policyType) {
            case "data_retention":
                const retentionViolations = this.checkRetentionPolicy(policy, data);
                violations.push(...retentionViolations.map((v) => ({
                    policyId: policy.id,
                    policyName: policy.name,
                    violation: v,
                    severity: "medium",
                })));
                break;
            case "data_access":
                const accessViolations = this.checkAccessPolicy(policy, data);
                violations.push(...accessViolations.map((v) => ({
                    policyId: policy.id,
                    policyName: policy.name,
                    violation: v,
                    severity: "high",
                })));
                break;
            case "data_classification":
                const classificationViolations = this.checkClassificationPolicy(policy, data);
                violations.push(...classificationViolations.map((v) => ({
                    policyId: policy.id,
                    policyName: policy.name,
                    violation: v,
                    severity: "medium",
                })));
                break;
            case "data_privacy":
                const privacyViolations = this.checkPrivacyPolicy(policy, data);
                violations.push(...privacyViolations.map((v) => ({
                    policyId: policy.id,
                    policyName: policy.name,
                    violation: v,
                    severity: "critical",
                })));
                break;
        }
        return violations;
    }
    checkRetentionPolicy(policy, data) {
        const violations = [];
        const retentionDays = policy.rules.retentionDays;
        const dateField = policy.rules.dateField || "createdAt";
        if (retentionDays) {
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - retentionDays);
            const expiredRecords = data.filter((item) => {
                const recordDate = new Date(item[dateField]);
                return recordDate < cutoffDate;
            });
            if (expiredRecords.length > 0) {
                violations.push(`${expiredRecords.length} records exceed retention period of ${retentionDays} days`);
            }
        }
        return violations;
    }
    checkAccessPolicy(policy, data) {
        const violations = [];
        const allowedRoles = policy.rules.allowedRoles || [];
        const sensitiveFields = policy.rules.sensitiveFields || [];
        // This would typically check against actual access logs
        // For now, we'll check if sensitive fields are properly protected
        for (const item of data) {
            for (const field of sensitiveFields) {
                if (item[field] && !item[`${field}_encrypted`]) {
                    violations.push(`Sensitive field ${field} is not encrypted`);
                    break;
                }
            }
        }
        return violations;
    }
    checkClassificationPolicy(policy, data) {
        const violations = [];
        const requiredClassification = policy.rules.requiredClassification;
        const classificationField = policy.rules.classificationField || "dataClassification";
        if (requiredClassification) {
            const unclassifiedRecords = data.filter((item) => !item[classificationField] || !requiredClassification.includes(item[classificationField]));
            if (unclassifiedRecords.length > 0) {
                violations.push(`${unclassifiedRecords.length} records lack proper data classification`);
            }
        }
        return violations;
    }
    checkPrivacyPolicy(policy, data) {
        const violations = [];
        const piiFields = policy.rules.piiFields || [];
        const consentRequired = policy.rules.consentRequired || false;
        for (const item of data) {
            // Check for PII without proper handling
            for (const field of piiFields) {
                if (item[field] && !item[`${field}_anonymized`] && !item[`${field}_encrypted`]) {
                    violations.push(`PII field ${field} is not properly protected`);
                    break;
                }
            }
            // Check for consent
            if (consentRequired && !item.consentGiven) {
                violations.push("Record processed without required consent");
                break;
            }
        }
        return violations;
    }
    async recordLineage(lineageData) {
        const lineage = this.lineageRepository.create(lineageData);
        return this.lineageRepository.save(lineage);
    }
    async getLineage(entityName) {
        const upstream = await this.lineageRepository.find({
            where: { targetEntity: entityName, isActive: true },
            order: { createdAt: "DESC" },
        });
        const downstream = await this.lineageRepository.find({
            where: { sourceEntity: entityName, isActive: true },
            order: { createdAt: "DESC" },
        });
        return { upstream, downstream };
    }
    async generateGovernanceReport() {
        const totalPolicies = await this.policyRepository.count();
        const activePolicies = await this.policyRepository.count({
            where: { status: data_governance_policy_entity_1.PolicyStatus.ACTIVE },
        });
        const totalLineage = await this.lineageRepository.count({ where: { isActive: true } });
        const uniqueEntities = await this.lineageRepository
            .createQueryBuilder("lineage")
            .select("DISTINCT lineage.sourceEntity")
            .addSelect("DISTINCT lineage.targetEntity")
            .where("lineage.isActive = :isActive", { isActive: true })
            .getRawMany();
        const recommendations = [];
        if (activePolicies < totalPolicies * 0.8) {
            recommendations.push("Consider activating more governance policies");
        }
        if (totalLineage < uniqueEntities.length * 2) {
            recommendations.push("Improve data lineage documentation");
        }
        return {
            policyCompliance: {
                total: totalPolicies,
                compliant: activePolicies,
                nonCompliant: totalPolicies - activePolicies,
                rate: totalPolicies > 0 ? (activePolicies / totalPolicies) * 100 : 100,
            },
            dataLineage: {
                entities: uniqueEntities.length,
                relationships: totalLineage,
                orphaned: 0, // Would need more complex query
            },
            recommendations,
        };
    }
    async reviewPolicies() {
        this.logger.log("Starting daily policy review");
        const policies = await this.policyRepository.find({
            where: { status: data_governance_policy_entity_1.PolicyStatus.ACTIVE },
        });
        for (const policy of policies) {
            // Check if policy needs review
            if (policy.reviewDate && policy.reviewDate <= new Date()) {
                this.logger.log(`Policy ${policy.name} is due for review`);
                // Could send notifications or create tasks here
            }
            // Check if policy has expired
            if (policy.expirationDate && policy.expirationDate <= new Date()) {
                await this.policyRepository.update(policy.id, {
                    status: data_governance_policy_entity_1.PolicyStatus.INACTIVE,
                });
                this.logger.log(`Policy ${policy.name} has been deactivated due to expiration`);
            }
        }
    }
};
exports.DataGovernanceService = DataGovernanceService;
__decorate([
    (0, schedule_1.Cron)(schedule_1.CronExpression.EVERY_DAY_AT_MIDNIGHT),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", typeof (_a = typeof Promise !== "undefined" && Promise) === "function" ? _a : Object)
], DataGovernanceService.prototype, "reviewPolicies", null);
exports.DataGovernanceService = DataGovernanceService = DataGovernanceService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [Object, Object])
], DataGovernanceService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxvam9zZXBoXFxEb2N1bWVudHNcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFxkYXRhLXF1YWxpdHlcXHNlcnZpY2VzXFxkYXRhLWdvdmVybmFuY2Uuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUFtRDtBQUVuRCwrQ0FBdUQ7QUFFdkQsNkZBQW1HO0FBbUI1RixJQUFNLHFCQUFxQiw2QkFBM0IsTUFBTSxxQkFBcUI7SUFHaEMsWUFDbUIsZ0JBQWtELEVBQ2xELGlCQUEwQztRQUQxQyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtDO1FBQ2xELHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBeUI7UUFKNUMsV0FBTSxHQUFHLElBQUksZUFBTSxDQUFDLHVCQUFxQixDQUFDLElBQUksQ0FBQyxDQUFBO0lBSzdELENBQUM7SUFFSixLQUFLLENBQUMsWUFBWSxDQUFDLFVBQXlDO1FBQzFELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUE7UUFDdkQsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO0lBQzNDLENBQUM7SUFFRCxLQUFLLENBQUMsWUFBWSxDQUFDLEVBQVUsRUFBRSxPQUFzQztRQUNuRSxNQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLE9BQU8sQ0FBQyxDQUFBO1FBQy9DLE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQTtRQUNyRSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDWixNQUFNLElBQUksS0FBSyxDQUFDLGtCQUFrQixFQUFFLFlBQVksQ0FBQyxDQUFBO1FBQ25ELENBQUM7UUFDRCxPQUFPLE1BQU0sQ0FBQTtJQUNmLENBQUM7SUFFRCxLQUFL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SSxvQkFBb0IsQ0FBQyxDQUFBO2dCQUMxRCxnREFBZ0Q7WUFDbEQsQ0FBQztZQUVELDhCQUE4QjtZQUM5QixJQUFJLE1BQU0sQ0FBQyxjQUFjLElBQUksTUFBTSxDQUFDLGNBQWMsSUFBSSxJQUFJLElBQUksRUFBRSxFQUFFLENBQUM7Z0JBQ2pFLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFO29CQUM1QyxNQUFNLEVBQUUsNENBQVksQ0FBQyxRQUFRO2lCQUM5QixDQUFDLENBQUE7Z0JBQ0YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsVUFBVSxNQUFNLENBQUMsSUFBSSx5Q0FBeUMsQ0FBQyxDQUFBO1lBQ2pGLENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQztDQUNGLENBQUE7QUExVVksc0RBQXFCO0FBbVQxQjtJQURMLElBQUEsZUFBSSxFQUFDLHlCQUFjLENBQUMscUJBQXFCLENBQUM7Ozt3REFDbkIsT0FBTyxvQkFBUCxPQUFPOzJEQXNCOUI7Z0NBelVVLHFCQUFxQjtJQURqQyxJQUFBLG1CQUFVLEdBQUU7O0dBQ0EscUJBQXFCLENBMFVqQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXG9qb3NlcGhcXERvY3VtZW50c1xcU3RyZWxsZXJNaW5kcy1CYWNrZW5kXFxzcmNcXGRhdGEtcXVhbGl0eVxcc2VydmljZXNcXGRhdGEtZ292ZXJuYW5jZS5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIExvZ2dlciB9IGZyb20gXCJAbmVzdGpzL2NvbW1vblwiXHJcbmltcG9ydCB0eXBlIHsgUmVwb3NpdG9yeSB9IGZyb20gXCJ0eXBlb3JtXCJcclxuaW1wb3J0IHsgQ3JvbiwgQ3JvbkV4cHJlc3Npb24gfSBmcm9tIFwiQG5lc3Rqcy9zY2hlZHVsZVwiXHJcblxyXG5pbXBvcnQgeyB0eXBlIERhdGFHb3Zlcm5hbmNlUG9saWN5LCBQb2xpY3lTdGF0dXMgfSBmcm9tIFwiLi4vZW50aXRpZXMvZGF0YS1nb3Zlcm5hbmNlLXBvbGljeS5lbnRpdHlcIlxyXG5pbXBvcnQgdHlwZSB7IERhdGFMaW5lYWdlIH0gZnJvbSBcIi4uL2VudGl0aWVzL2RhdGEtbGluZWFnZS5lbnRpdHlcIlxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBHb3Zlcm5hbmNlUmVwb3J0IHtcclxuICBwb2xpY3lDb21wbGlhbmNlOiB7XHJcbiAgICB0b3RhbDogbnVtYmVyXHJcbiAgICBjb21wbGlhbnQ6IG51bWJlclxyXG4gICAgbm9uQ29tcGxpYW50OiBudW1iZXJcclxuICAgIHJhdGU6IG51bWJlclxyXG4gIH1cclxuICBkYXRhTGluZWFnZToge1xyXG4gICAgZW50aXRpZXM6IG51bWJlclxyXG4gICAgcmVsYXRpb25zaGlwczogbnVtYmVyXHJcbiAgICBvcnBoYW5lZDogbnVtYmVyXHJcbiAgfVxyXG4gIHJlY29tbWVuZGF0aW9uczogc3RyaW5nW11cclxufVxyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgRGF0YUdvdmVybmFuY2VTZXJ2aWNlIHtcclxuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIoRGF0YUdvdmVybmFuY2VTZXJ2aWNlLm5hbWUpXHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSByZWFkb25seSBwb2xpY3lSZXBvc2l0b3J5OiBSZXBvc2l0b3J5PERhdGFHb3Zlcm5hbmNlUG9saWN5PixcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgbGluZWFnZVJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8RGF0YUxpbmVhZ2U+LFxyXG4gICkge31cclxuXHJcbiAgYXN5bmMgY3JlYXRlUG9saWN5KHBvbGljeURhdGE6IFBhcnRpYWw8RGF0YUdvdmVybmFuY2VQb2xpY3k+KTogUHJvbWlzZTxEYXRhR292ZXJuYW5jZVBvbGljeT4ge1xyXG4gICAgY29uc3QgcG9saWN5ID0gdGhpcy5wb2xpY3lSZXBvc2l0b3J5LmNyZWF0ZShwb2xpY3lEYXRhKVxyXG4gICAgcmV0dXJuIHRoaXMucG9saWN5UmVwb3NpdG9yeS5zYXZlKHBvbGljeSlcclxuICB9XHJcblxyXG4gIGFzeW5jIHVwZGF0ZVBvbGljeShpZDogc3RyaW5nLCB1cGRhdGVzOiBQYXJ0aWFsPERhdGFHb3Zlcm5hbmNlUG9saWN5Pik6IFByb21pc2U8RGF0YUdvdmVybmFuY2VQb2xpY3k+IHtcclxuICAgIGF3YWl0IHRoaXMucG9saWN5UmVwb3NpdG9yeS51cGRhdGUoaWQsIHVwZGF0ZXMpXHJcbiAgICBjb25zdCBwb2xpY3kgPSBhd2FpdCB0aGlzLnBvbGljeVJlcG9zaXRvcnkuZmluZE9uZSh7IHdoZXJlOiB7IGlkIH0gfSlcclxuICAgIGlmICghcG9saWN5KSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihgUG9saWN5IHdpdGggaWQgJHtpZH0gbm90IGZvdW5kYClcclxuICAgIH1cclxuICAgIHJldHVybiBwb2xpY3lcclxuICB9XHJcblxyXG4gIGFzeW5jIGFjdGl2YXRlUG9saWN5KGlkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGF3YWl0IHRoaXMucG9saWN5UmVwb3NpdG9yeS51cGRhdGUoaWQsIHtcclxuICAgICAgc3RhdHVzOiBQb2xpY3lTdGF0dXMuQUNUSVZFLFxyXG4gICAgICBlZmZlY3RpdmVEYXRlOiBuZXcgRGF0ZSgpLFxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIGFzeW5jIGRlYWN0aXZhdGVQb2xpY3koaWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgYXdhaXQgdGhpcy5wb2xpY3lSZXBvc2l0b3J5LnVwZGF0ZShpZCwgeyBzdGF0dXM6IFBvbGljeVN0YXR1cy5JTkFDVElWRSB9KVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0UG9saWNpZXMoZmlsdGVyczoge1xyXG4gICAgcG9saWN5VHlwZT86IHN0cmluZ1xyXG4gICAgc3RhdHVzPzogUG9saWN5U3RhdHVzXHJcbiAgICBlbnRpdHlUeXBlPzogc3RyaW5nXHJcbiAgfSk6IFByb21pc2U8RGF0YUdvdmVybmFuY2VQb2xpY3lbXT4ge1xyXG4gICAgY29uc3QgcXVlcnkgPSB0aGlzLnBvbGljeVJlcG9zaXRvcnkuY3JlYXRlUXVlcnlCdWlsZGVyKFwicG9saWN5XCIpXHJcblxyXG4gICAgaWYgKGZpbHRlcnMucG9saWN5VHlwZSkge1xyXG4gICAgICBxdWVyeS5hbmRXaGVyZShcInBvbGljeS5wb2xpY3lUeXBlID0gOnBvbGljeVR5cGVcIiwgeyBwb2xpY3lUeXBlOiBmaWx0ZXJzLnBvbGljeVR5cGUgfSlcclxuICAgIH1cclxuXHJcbiAgICBpZiAoZmlsdGVycy5zdGF0dXMpIHtcclxuICAgICAgcXVlcnkuYW5kV2hlcmUoXCJwb2xpY3kuc3RhdHVzID0gOnN0YXR1c1wiLCB7IHN0YXR1czogZmlsdGVycy5zdGF0dXMgfSlcclxuICAgIH1cclxuXHJcbiAgICBpZiAoZmlsdGVycy5lbnRpdHlUeXBlKSB7XHJcbiAgICAgIHF1ZXJ5LmFuZFdoZXJlKFwicG9saWN5LmVudGl0eVR5cGUgPSA6ZW50aXR5VHlwZVwiLCB7IGVudGl0eVR5cGU6IGZpbHRlcnMuZW50aXR5VHlwZSB9KVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBxdWVyeS5vcmRlckJ5KFwicG9saWN5LmNyZWF0ZWRBdFwiLCBcIkRFU0NcIikuZ2V0TWFueSgpXHJcbiAgfVxyXG5cclxuICBhc3luYyBjaGVja1BvbGljeUNvbXBsaWFuY2UoXHJcbiAgICBlbnRpdHlUeXBlOiBzdHJpbmcsXHJcbiAgICBkYXRhOiBhbnlbXSxcclxuICApOiBQcm9taXNlPHtcclxuICAgIGNvbXBsaWFudDogYm9vbGVhblxyXG4gICAgdmlvbGF0aW9uczogQXJyYXk8e1xyXG4gICAgICBwb2xpY3lJZDogc3RyaW5nXHJcbiAgICAgIHBvbGljeU5hbWU6IHN0cmluZ1xyXG4gICAgICB2aW9sYXRpb246IHN0cmluZ1xyXG4gICAgICBzZXZlcml0eTogc3RyaW5nXHJcbiAgICB9PlxyXG4gIH0+IHtcclxuICAgIGNvbnN0IHBvbGljaWVzID0gYXdhaXQgdGhpcy5nZXRQb2xpY2llcyh7XHJcbiAgICAgIGVudGl0eVR5cGUsXHJcbiAgICAgIHN0YXR1czogUG9saWN5U3RhdHVzLkFDVElWRSxcclxuICAgIH0pXHJcblxyXG4gICAgY29uc3QgdmlvbGF0aW9uczogQXJyYXk8e1xyXG4gICAgICBwb2xpY3lJZDogc3RyaW5nXHJcbiAgICAgIHBvbGljeU5hbWU6IHN0cmluZ1xyXG4gICAgICB2aW9sYXRpb246IHN0cmluZ1xyXG4gICAgICBzZXZlcml0eTogc3RyaW5nXHJcbiAgICB9PiA9IFtdXHJcblxyXG4gICAgZm9yIChjb25zdCBwb2xpY3kgb2YgcG9saWNpZXMpIHtcclxuICAgICAgY29uc3QgcG9saWN5VmlvbGF0aW9ucyA9IGF3YWl0IHRoaXMudmFsaWRhdGVQb2xpY3kocG9saWN5LCBkYXRhKVxyXG4gICAgICB2aW9sYXRpb25zLnB1c2goLi4ucG9saWN5VmlvbGF0aW9ucylcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBjb21wbGlhbnQ6IHZpb2xhdGlvbnMubGVuZ3RoID09PSAwLFxyXG4gICAgICB2aW9sYXRpb25zLFxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBhc3luYyB2YWxpZGF0ZVBvbGljeShcclxuICAgIHBvbGljeTogRGF0YUdvdmVybmFuY2VQb2xpY3ksXHJcbiAgICBkYXRhOiBhbnlbXSxcclxuICApOiBQcm9taXNlPFxyXG4gICAgQXJyYXk8e1xyXG4gICAgICBwb2xpY3lJZDogc3RyaW5nXHJcbiAgICAgIHBvbGljeU5hbWU6IHN0cmluZ1xyXG4gICAgICB2aW9sYXRpb246IHN0cmluZ1xyXG4gICAgICBzZXZlcml0eTogc3RyaW5nXHJcbiAgICB9PlxyXG4gID4ge1xyXG4gICAgY29uc3QgdmlvbGF0aW9uczogQXJyYXk8e1xyXG4gICAgICBwb2xpY3lJZDogc3RyaW5nXHJcbiAgICAgIHBvbGljeU5hbWU6IHN0cmluZ1xyXG4gICAgICB2aW9sYXRpb246IHN0cmluZ1xyXG4gICAgICBzZXZlcml0eTogc3RyaW5nXHJcbiAgICB9PiA9IFtdXHJcblxyXG4gICAgc3dpdGNoIChwb2xpY3kucG9saWN5VHlwZSkge1xyXG4gICAgICBjYXNlIFwiZGF0YV9yZXRlbnRpb25cIjpcclxuICAgICAgICBjb25zdCByZXRlbnRpb25WaW9sYXRpb25zID0gdGhpcy5jaGVja1JldGVudGlvblBvbGljeShwb2xpY3ksIGRhdGEpXHJcbiAgICAgICAgdmlvbGF0aW9ucy5wdXNoKFxyXG4gICAgICAgICAgLi4ucmV0ZW50aW9uVmlvbGF0aW9ucy5tYXAoKHYpID0+ICh7XHJcbiAgICAgICAgICAgIHBvbGljeUlkOiBwb2xpY3kuaWQsXHJcbiAgICAgICAgICAgIHBvbGljeU5hbWU6IHBvbGljeS5uYW1lLFxyXG4gICAgICAgICAgICB2aW9sYXRpb246IHYsXHJcbiAgICAgICAgICAgIHNldmVyaXR5OiBcIm1lZGl1bVwiLFxyXG4gICAgICAgICAgfSkpLFxyXG4gICAgICAgIClcclxuICAgICAgICBicmVha1xyXG5cclxuICAgICAgY2FzZSBcImRhdGFfYWNjZXNzXCI6XHJcbiAgICAgICAgY29uc3QgYWNjZXNzVmlvbGF0aW9ucyA9IHRoaXMuY2hlY2tBY2Nlc3NQb2xpY3kocG9saWN5LCBkYXRhKVxyXG4gICAgICAgIHZpb2xhdGlvbnMucHVzaChcclxuICAgICAgICAgIC4uLmFjY2Vzc1Zpb2xhdGlvbnMubWFwKCh2KSA9PiAoe1xyXG4gICAgICAgICAgICBwb2xpY3lJZDogcG9saWN5LmlkLFxyXG4gICAgICAgICAgICBwb2xpY3lOYW1lOiBwb2xpY3kubmFtZSxcclxuICAgICAgICAgICAgdmlvbGF0aW9uOiB2LFxyXG4gICAgICAgICAgICBzZXZlcml0eTogXCJoaWdoXCIsXHJcbiAgICAgICAgICB9KSksXHJcbiAgICAgICAgKVxyXG4gICAgICAgIGJyZWFrXHJcblxyXG4gICAgICBjYXNlIFwiZGF0YV9jbGFzc2lmaWNhdGlvblwiOlxyXG4gICAgICAgIGNvbnN0IGNsYXNzaWZpY2F0aW9uVmlvbGF0aW9ucyA9IHRoaXMuY2hlY2tDbGFzc2lmaWNhdGlvblBvbGljeShwb2xpY3ksIGRhdGEpXHJcbiAgICAgICAgdmlvbGF0aW9ucy5wdXNoKFxyXG4gICAgICAgICAgLi4uY2xhc3NpZmljYXRpb25WaW9sYXRpb25zLm1hcCgodikgPT4gKHtcclxuICAgICAgICAgICAgcG9saWN5SWQ6IHBvbGljeS5pZCxcclxuICAgICAgICAgICAgcG9saWN5TmFtZTogcG9saWN5Lm5hbWUsXHJcbiAgICAgICAgICAgIHZpb2xhdGlvbjogdixcclxuICAgICAgICAgICAgc2V2ZXJpdHk6IFwibWVkaXVtXCIsXHJcbiAgICAgICAgICB9KSksXHJcbiAgICAgICAgKVxyXG4gICAgICAgIGJyZWFrXHJcblxyXG4gICAgICBjYXNlIFwiZGF0YV9wcml2YWN5XCI6XHJcbiAgICAgICAgY29uc3QgcHJpdmFjeVZpb2xhdGlvbnMgPSB0aGlzLmNoZWNrUHJpdmFjeVBvbGljeShwb2xpY3ksIGRhdGEpXHJcbiAgICAgICAgdmlvbGF0aW9ucy5wdXNoKFxyXG4gICAgICAgICAgLi4ucHJpdmFjeVZpb2xhdGlvbnMubWFwKCh2KSA9PiAoe1xyXG4gICAgICAgICAgICBwb2xpY3lJZDogcG9saWN5LmlkLFxyXG4gICAgICAgICAgICBwb2xpY3lOYW1lOiBwb2xpY3kubmFtZSxcclxuICAgICAgICAgICAgdmlvbGF0aW9uOiB2LFxyXG4gICAgICAgICAgICBzZXZlcml0eTogXCJjcml0aWNhbFwiLFxyXG4gICAgICAgICAgfSkpLFxyXG4gICAgICAgIClcclxuICAgICAgICBicmVha1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB2aW9sYXRpb25zXHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNoZWNrUmV0ZW50aW9uUG9saWN5KHBvbGljeTogRGF0YUdvdmVybmFuY2VQb2xpY3ksIGRhdGE6IGFueVtdKTogc3RyaW5nW10ge1xyXG4gICAgY29uc3QgdmlvbGF0aW9uczogc3RyaW5nW10gPSBbXVxyXG4gICAgY29uc3QgcmV0ZW50aW9uRGF5cyA9IHBvbGljeS5ydWxlcy5yZXRlbnRpb25EYXlzXHJcbiAgICBjb25zdCBkYXRlRmllbGQgPSBwb2xpY3kucnVsZXMuZGF0ZUZpZWxkIHx8IFwiY3JlYXRlZEF0XCJcclxuXHJcbiAgICBpZiAocmV0ZW50aW9uRGF5cykge1xyXG4gICAgICBjb25zdCBjdXRvZmZEYXRlID0gbmV3IERhdGUoKVxyXG4gICAgICBjdXRvZmZEYXRlLnNldERhdGUoY3V0b2ZmRGF0ZS5nZXREYXRlKCkgLSByZXRlbnRpb25EYXlzKVxyXG5cclxuICAgICAgY29uc3QgZXhwaXJlZFJlY29yZHMgPSBkYXRhLmZpbHRlcigoaXRlbSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHJlY29yZERhdGUgPSBuZXcgRGF0ZShpdGVtW2RhdGVGaWVsZF0pXHJcbiAgICAgICAgcmV0dXJuIHJlY29yZERhdGUgPCBjdXRvZmZEYXRlXHJcbiAgICAgIH0pXHJcblxyXG4gICAgICBpZiAoZXhwaXJlZFJlY29yZHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIHZpb2xhdGlvbnMucHVzaChgJHtleHBpcmVkUmVjb3Jkcy5sZW5ndGh9IHJlY29yZHMgZXhjZWVkIHJldGVudGlvbiBwZXJpb2Qgb2YgJHtyZXRlbnRpb25EYXlzfSBkYXlzYClcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB2aW9sYXRpb25zXHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNoZWNrQWNjZXNzUG9saWN5KHBvbGljeTogRGF0YUdvdmVybmFuY2VQb2xpY3ksIGRhdGE6IGFueVtdKTogc3RyaW5nW10ge1xyXG4gICAgY29uc3QgdmlvbGF0aW9uczogc3RyaW5nW10gPSBbXVxyXG4gICAgY29uc3QgYWxsb3dlZFJvbGVzID0gcG9saWN5LnJ1bGVzLmFsbG93ZWRSb2xlcyB8fCBbXVxyXG4gICAgY29uc3Qgc2Vuc2l0aXZlRmllbGRzID0gcG9saWN5LnJ1bGVzLnNlbnNpdGl2ZUZpZWxkcyB8fCBbXVxyXG5cclxuICAgIC8vIFRoaXMgd291bGQgdHlwaWNhbGx5IGNoZWNrIGFnYWluc3QgYWN0dWFsIGFjY2VzcyBsb2dzXHJcbiAgICAvLyBGb3Igbm93LCB3ZSdsbCBjaGVjayBpZiBzZW5zaXRpdmUgZmllbGRzIGFyZSBwcm9wZXJseSBwcm90ZWN0ZWRcclxuICAgIGZvciAoY29uc3QgaXRlbSBvZiBkYXRhKSB7XHJcbiAgICAgIGZvciAoY29uc3QgZmllbGQgb2Ygc2Vuc2l0aXZlRmllbGRzKSB7XHJcbiAgICAgICAgaWYgKGl0ZW1bZmllbGRdICYmICFpdGVtW2Ake2ZpZWxkfV9lbmNyeXB0ZWRgXSkge1xyXG4gICAgICAgICAgdmlvbGF0aW9ucy5wdXNoKGBTZW5zaXRpdmUgZmllbGQgJHtmaWVsZH0gaXMgbm90IGVuY3J5cHRlZGApXHJcbiAgICAgICAgICBicmVha1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB2aW9sYXRpb25zXHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNoZWNrQ2xhc3NpZmljYXRpb25Qb2xpY3kocG9saWN5OiBEYXRhR292ZXJuYW5jZVBvbGljeSwgZGF0YTogYW55W10pOiBzdHJpbmdbXSB7XHJcbiAgICBjb25zdCB2aW9sYXRpb25zOiBzdHJpbmdbXSA9IFtdXHJcbiAgICBjb25zdCByZXF1aXJlZENsYXNzaWZpY2F0aW9uID0gcG9saWN5LnJ1bGVzLnJlcXVpcmVkQ2xhc3NpZmljYXRpb25cclxuICAgIGNvbnN0IGNsYXNzaWZpY2F0aW9uRmllbGQgPSBwb2xpY3kucnVsZXMuY2xhc3NpZmljYXRpb25GaWVsZCB8fCBcImRhdGFDbGFzc2lmaWNhdGlvblwiXHJcblxyXG4gICAgaWYgKHJlcXVpcmVkQ2xhc3NpZmljYXRpb24pIHtcclxuICAgICAgY29uc3QgdW5jbGFzc2lmaWVkUmVjb3JkcyA9IGRhdGEuZmlsdGVyKFxyXG4gICAgICAgIChpdGVtKSA9PiAhaXRlbVtjbGFzc2lmaWNhdGlvbkZpZWxkXSB8fCAhcmVxdWlyZWRDbGFzc2lmaWNhdGlvbi5pbmNsdWRlcyhpdGVtW2NsYXNzaWZpY2F0aW9uRmllbGRdKSxcclxuICAgICAgKVxyXG5cclxuICAgICAgaWYgKHVuY2xhc3NpZmllZFJlY29yZHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIHZpb2xhdGlvbnMucHVzaChgJHt1bmNsYXNzaWZpZWRSZWNvcmRzLmxlbmd0aH0gcmVjb3JkcyBsYWNrIHByb3BlciBkYXRhIGNsYXNzaWZpY2F0aW9uYClcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB2aW9sYXRpb25zXHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNoZWNrUHJpdmFjeVBvbGljeShwb2xpY3k6IERhdGFHb3Zlcm5hbmNlUG9saWN5LCBkYXRhOiBhbnlbXSk6IHN0cmluZ1tdIHtcclxuICAgIGNvbnN0IHZpb2xhdGlvbnM6IHN0cmluZ1tdID0gW11cclxuICAgIGNvbnN0IHBpaUZpZWxkcyA9IHBvbGljeS5ydWxlcy5waWlGaWVsZHMgfHwgW11cclxuICAgIGNvbnN0IGNvbnNlbnRSZXF1aXJlZCA9IHBvbGljeS5ydWxlcy5jb25zZW50UmVxdWlyZWQgfHwgZmFsc2VcclxuXHJcbiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgZGF0YSkge1xyXG4gICAgICAvLyBDaGVjayBmb3IgUElJIHdpdGhvdXQgcHJvcGVyIGhhbmRsaW5nXHJcbiAgICAgIGZvciAoY29uc3QgZmllbGQgb2YgcGlpRmllbGRzKSB7XHJcbiAgICAgICAgaWYgKGl0ZW1bZmllbGRdICYmICFpdGVtW2Ake2ZpZWxkfV9hbm9ueW1pemVkYF0gJiYgIWl0ZW1bYCR7ZmllbGR9X2VuY3J5cHRlZGBdKSB7XHJcbiAgICAgICAgICB2aW9sYXRpb25zLnB1c2goYFBJSSBmaWVsZCAke2ZpZWxkfSBpcyBub3QgcHJvcGVybHkgcHJvdGVjdGVkYClcclxuICAgICAgICAgIGJyZWFrXHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBDaGVjayBmb3IgY29uc2VudFxyXG4gICAgICBpZiAoY29uc2VudFJlcXVpcmVkICYmICFpdGVtLmNvbnNlbnRHaXZlbikge1xyXG4gICAgICAgIHZpb2xhdGlvbnMucHVzaChcIlJlY29yZCBwcm9jZXNzZWQgd2l0aG91dCByZXF1aXJlZCBjb25zZW50XCIpXHJcbiAgICAgICAgYnJlYWtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB2aW9sYXRpb25zXHJcbiAgfVxyXG5cclxuICBhc3luYyByZWNvcmRMaW5lYWdlKGxpbmVhZ2VEYXRhOiBQYXJ0aWFsPERhdGFMaW5lYWdlPik6IFByb21pc2U8RGF0YUxpbmVhZ2U+IHtcclxuICAgIGNvbnN0IGxpbmVhZ2UgPSB0aGlzLmxpbmVhZ2VSZXBvc2l0b3J5LmNyZWF0ZShsaW5lYWdlRGF0YSlcclxuICAgIHJldHVybiB0aGlzLmxpbmVhZ2VSZXBvc2l0b3J5LnNhdmUobGluZWFnZSlcclxuICB9XHJcblxyXG4gIGFzeW5jIGdldExpbmVhZ2UoZW50aXR5TmFtZTogc3RyaW5nKTogUHJvbWlzZTx7XHJcbiAgICB1cHN0cmVhbTogRGF0YUxpbmVhZ2VbXVxyXG4gICAgZG93bnN0cmVhbTogRGF0YUxpbmVhZ2VbXVxyXG4gIH0+IHtcclxuICAgIGNvbnN0IHVwc3RyZWFtID0gYXdhaXQgdGhpcy5saW5lYWdlUmVwb3NpdG9yeS5maW5kKHtcclxuICAgICAgd2hlcmU6IHsgdGFyZ2V0RW50aXR5OiBlbnRpdHlOYW1lLCBpc0FjdGl2ZTogdHJ1ZSB9LFxyXG4gICAgICBvcmRlcjogeyBjcmVhdGVkQXQ6IFwiREVTQ1wiIH0sXHJcbiAgICB9KVxyXG5cclxuICAgIGNvbnN0IGRvd25zdHJlYW0gPSBhd2FpdCB0aGlzLmxpbmVhZ2VSZXBvc2l0b3J5LmZpbmQoe1xyXG4gICAgICB3aGVyZTogeyBzb3VyY2VFbnRpdHk6IGVudGl0eU5hbWUsIGlzQWN0aXZlOiB0cnVlIH0sXHJcbiAgICAgIG9yZGVyOiB7IGNyZWF0ZWRBdDogXCJERVNDXCIgfSxcclxuICAgIH0pXHJcblxyXG4gICAgcmV0dXJuIHsgdXBzdHJlYW0sIGRvd25zdHJlYW0gfVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2VuZXJhdGVHb3Zlcm5hbmNlUmVwb3J0KCk6IFByb21pc2U8R292ZXJuYW5jZVJlcG9ydD4ge1xyXG4gICAgY29uc3QgdG90YWxQb2xpY2llcyA9IGF3YWl0IHRoaXMucG9saWN5UmVwb3NpdG9yeS5jb3VudCgpXHJcbiAgICBjb25zdCBhY3RpdmVQb2xpY2llcyA9IGF3YWl0IHRoaXMucG9saWN5UmVwb3NpdG9yeS5jb3VudCh7XHJcbiAgICAgIHdoZXJlOiB7IHN0YXR1czogUG9saWN5U3RhdHVzLkFDVElWRSB9LFxyXG4gICAgfSlcclxuXHJcbiAgICBjb25zdCB0b3RhbExpbmVhZ2UgPSBhd2FpdCB0aGlzLmxpbmVhZ2VSZXBvc2l0b3J5LmNvdW50KHsgd2hlcmU6IHsgaXNBY3RpdmU6IHRydWUgfSB9KVxyXG4gICAgY29uc3QgdW5pcXVlRW50aXRpZXMgPSBhd2FpdCB0aGlzLmxpbmVhZ2VSZXBvc2l0b3J5XHJcbiAgICAgIC5jcmVhdGVRdWVyeUJ1aWxkZXIoXCJsaW5lYWdlXCIpXHJcbiAgICAgIC5zZWxlY3QoXCJESVNUSU5DVCBsaW5lYWdlLnNvdXJjZUVudGl0eVwiKVxyXG4gICAgICAuYWRkU2VsZWN0KFwiRElTVElOQ1QgbGluZWFnZS50YXJnZXRFbnRpdHlcIilcclxuICAgICAgLndoZXJlKFwibGluZWFnZS5pc0FjdGl2ZSA9IDppc0FjdGl2ZVwiLCB7IGlzQWN0aXZlOiB0cnVlIH0pXHJcbiAgICAgIC5nZXRSYXdNYW55KClcclxuXHJcbiAgICBjb25zdCByZWNvbW1lbmRhdGlvbnM6IHN0cmluZ1tdID0gW11cclxuXHJcbiAgICBpZiAoYWN0aXZlUG9saWNpZXMgPCB0b3RhbFBvbGljaWVzICogMC44KSB7XHJcbiAgICAgIHJlY29tbWVuZGF0aW9ucy5wdXNoKFwiQ29uc2lkZXIgYWN0aXZhdGluZyBtb3JlIGdvdmVybmFuY2UgcG9saWNpZXNcIilcclxuICAgIH1cclxuXHJcbiAgICBpZiAodG90YWxMaW5lYWdlIDwgdW5pcXVlRW50aXRpZXMubGVuZ3RoICogMikge1xyXG4gICAgICByZWNvbW1lbmRhdGlvbnMucHVzaChcIkltcHJvdmUgZGF0YSBsaW5lYWdlIGRvY3VtZW50YXRpb25cIilcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBwb2xpY3lDb21wbGlhbmNlOiB7XHJcbiAgICAgICAgdG90YWw6IHRvdGFsUG9saWNpZXMsXHJcbiAgICAgICAgY29tcGxpYW50OiBhY3RpdmVQb2xpY2llcyxcclxuICAgICAgICBub25Db21wbGlhbnQ6IHRvdGFsUG9saWNpZXMgLSBhY3RpdmVQb2xpY2llcyxcclxuICAgICAgICByYXRlOiB0b3RhbFBvbGljaWVzID4gMCA/IChhY3RpdmVQb2xpY2llcyAvIHRvdGFsUG9saWNpZXMpICogMTAwIDogMTAwLFxyXG4gICAgICB9LFxyXG4gICAgICBkYXRhTGluZWFnZToge1xyXG4gICAgICAgIGVudGl0aWVzOiB1bmlxdWVFbnRpdGllcy5sZW5ndGgsXHJcbiAgICAgICAgcmVsYXRpb25zaGlwczogdG90YWxMaW5lYWdlLFxyXG4gICAgICAgIG9ycGhhbmVkOiAwLCAvLyBXb3VsZCBuZWVkIG1vcmUgY29tcGxleCBxdWVyeVxyXG4gICAgICB9LFxyXG4gICAgICByZWNvbW1lbmRhdGlvbnMsXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBAQ3JvbihDcm9uRXhwcmVzc2lvbi5FVkVSWV9EQVlfQVRfTUlETklHSFQpXHJcbiAgYXN5bmMgcmV2aWV3UG9saWNpZXMoKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICB0aGlzLmxvZ2dlci5sb2coXCJTdGFydGluZyBkYWlseSBwb2xpY3kgcmV2aWV3XCIpXHJcblxyXG4gICAgY29uc3QgcG9saWNpZXMgPSBhd2FpdCB0aGlzLnBvbGljeVJlcG9zaXRvcnkuZmluZCh7XHJcbiAgICAgIHdoZXJlOiB7IHN0YXR1czogUG9saWN5U3RhdHVzLkFDVElWRSB9LFxyXG4gICAgfSlcclxuXHJcbiAgICBmb3IgKGNvbnN0IHBvbGljeSBvZiBwb2xpY2llcykge1xyXG4gICAgICAvLyBDaGVjayBpZiBwb2xpY3kgbmVlZHMgcmV2aWV3XHJcbiAgICAgIGlmIChwb2xpY3kucmV2aWV3RGF0ZSAmJiBwb2xpY3kucmV2aWV3RGF0ZSA8PSBuZXcgRGF0ZSgpKSB7XHJcbiAgICAgICAgdGhpcy5sb2dnZXIubG9nKGBQb2xpY3kgJHtwb2xpY3kubmFtZX0gaXMgZHVlIGZvciByZXZpZXdgKVxyXG4gICAgICAgIC8vIENvdWxkIHNlbmQgbm90aWZpY2F0aW9ucyBvciBjcmVhdGUgdGFza3MgaGVyZVxyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBDaGVjayBpZiBwb2xpY3kgaGFzIGV4cGlyZWRcclxuICAgICAgaWYgKHBvbGljeS5leHBpcmF0aW9uRGF0ZSAmJiBwb2xpY3kuZXhwaXJhdGlvbkRhdGUgPD0gbmV3IERhdGUoKSkge1xyXG4gICAgICAgIGF3YWl0IHRoaXMucG9saWN5UmVwb3NpdG9yeS51cGRhdGUocG9saWN5LmlkLCB7XHJcbiAgICAgICAgICBzdGF0dXM6IFBvbGljeVN0YXR1cy5JTkFDVElWRSxcclxuICAgICAgICB9KVxyXG4gICAgICAgIHRoaXMubG9nZ2VyLmxvZyhgUG9saWN5ICR7cG9saWN5Lm5hbWV9IGhhcyBiZWVuIGRlYWN0aXZhdGVkIGR1ZSB0byBleHBpcmF0aW9uYClcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxufVxyXG4iXSwidmVyc2lvbiI6M30=