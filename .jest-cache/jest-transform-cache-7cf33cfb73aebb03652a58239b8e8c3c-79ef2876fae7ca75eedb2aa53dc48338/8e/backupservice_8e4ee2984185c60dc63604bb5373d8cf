475b35c7491e274d102117cb7545de1a
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var BackupService_1;
var _a, _b, _c, _d, _e, _f;
Object.defineProperty(exports, "__esModule", { value: true });
exports.BackupService = void 0;
/* eslint-disable prettier/prettier */
const common_1 = require("@nestjs/common");
const config_1 = require("@nestjs/config");
const schedule_1 = require("@nestjs/schedule");
const child_process_1 = require("child_process");
const util_1 = require("util");
const fs = __importStar(require("fs/promises"));
const path = __importStar(require("path"));
const backup_verification_service_1 = require("./backup-verification.service");
const backup_retention_service_1 = require("./backup-retention.service");
const email_service_1 = require("../email/email.service");
const execAsync = (0, util_1.promisify)(child_process_1.exec);
/**
 * BackupService provides logic for creating, listing, and verifying backups.
 */
let BackupService = BackupService_1 = class BackupService {
    constructor(configService, verificationService, retentionService, emailService) {
        this.configService = configService;
        this.verificationService = verificationService;
        this.retentionService = retentionService;
        this.emailService = emailService;
        this.logger = new common_1.Logger(BackupService_1.name);
        this.backupDir = this.configService.get('BACKUP_DIR', './backups');
        this.dbConfig = {
            host: this.configService.get('database.host'),
            port: this.configService.get('database.port'),
            username: this.configService.get('database.user'),
            password: this.configService.get('database.password'),
            database: this.configService.get('database.name'),
        };
        this.ensureBackupDirectory();
    }
    async ensureBackupDirectory() {
        try {
            await fs.access(this.backupDir);
        }
        catch {
            await fs.mkdir(this.backupDir, { recursive: true });
            this.logger.log(`Created backup directory: ${this.backupDir}`);
        }
    }
    async scheduledDatabaseBackup() {
        this.logger.log('Starting scheduled database backup');
        try {
            const result = await this.createDatabaseBackup();
            if (result.success) {
                this.logger.log(`Scheduled backup completed successfully: ${result.backupPath}`);
                await this.retentionService.cleanupOldBackups();
            }
            else {
                this.logger.error(`Scheduled backup failed: ${result.error}`);
                await this.sendBackupFailureAlert(result.error);
            }
        }
        catch (error) {
            this.logger.error(`Scheduled backup error: ${error.message}`, error.stack);
            await this.sendBackupFailureAlert(error.message);
        }
    }
    async scheduledApplicationDataBackup() {
        this.logger.log('Starting scheduled application data backup');
        try {
            const result = await this.createApplicationDataBackup();
            if (result.success) {
                this.logger.log(`Application data backup completed: ${result.backupPath}`);
            }
            else {
                this.logger.error(`Application data backup failed: ${result.error}`);
            }
        }
        catch (error) {
            this.logger.error(`Application data backup error: ${error.message}`, error.stack);
        }
    }
    /**
     * Create a manual database backup.
     */
    async createDatabaseBackup() {
        const startTime = Date.now();
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        const backupFileName = `db-backup-${timestamp}.sql`;
        const backupPath = path.join(this.backupDir, backupFileName);
        try {
            // Set PGPASSWORD environment variable for pg_dump
            const env = { ...process.env, PGPASSWORD: this.dbConfig.password };
            const command = `pg_dump -h ${this.dbConfig.host} -p ${this.dbConfig.port} -U ${this.dbConfig.username} -d ${this.dbConfig.database} -f "${backupPath}" --verbose --no-password`;
            this.logger.log(`Executing backup command for database: ${this.dbConfig.database}`);
            await execAsync(command, { env });
            // Get backup file size
            const stats = await fs.stat(backupPath);
            const duration = Date.now() - startTime;
            this.logger.log(`Database backup created: ${backupPath} (${stats.size} bytes, ${duration}ms)`);
            // Verify backup
            const isValid = await this.verificationService.verifyDatabaseBackup(backupPath);
            if (!isValid) {
                await this.sendBackupFailureAlert('Backup verification failed');
                throw new Error('Backup verification failed');
            }
            return {
                success: true,
                backupPath,
                size: stats.size,
                duration,
            };
        }
        catch (error) {
            this.logger.error(`Database backup failed: ${error.message}`, error.stack);
            await this.sendBackupFailureAlert(error.message);
            return {
                success: false,
                error: error.message,
            };
        }
    }
    /**
     * Create a manual application data backup.
     */
    async createApplicationDataBackup() {
        const startTime = Date.now(); // Add missing startTime variable
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        const backupFileName = `app-data-backup-${timestamp}.tar.gz`;
        const backupPath = path.join(this.backupDir, backupFileName);
        try {
            // Use the variables in the tar command or remove them if not needed
            const uploadDir = this.configService.get('UPLOAD_DIR', './uploads');
            const logsDir = './logs';
            // Create tar.gz archive of application data using the variables
            const command = `tar -czf "${backupPath}" -C . "${uploadDir.replace('./', '')}", "${logsDir.replace('./', '')}", .env.production`;
            this.logger.log('Creating application data backup');
            await execAsync(command);
            const stats = await fs.stat(backupPath);
            const duration = Date.now() - startTime;
            this.logger.log(`Application data backup created: ${backupPath} (${stats.size} bytes, ${duration}ms)`);
            return {
                success: true,
                backupPath,
                size: stats.size,
                duration,
            };
        }
        catch (error) {
            this.logger.error(`Application data backup failed: ${error.message}`, error.stack);
            return {
                success: false,
                error: error.message,
            };
        }
    }
    /**
     * List all backup files.
     */
    async listBackups() {
        try {
            const files = await fs.readdir(this.backupDir);
            return files.filter((file) => file.endsWith('.sql') || file.endsWith('.tar.gz'));
        }
        catch (error) {
            this.logger.error(`Failed to list backups: ${error.message}`);
            return [];
        }
    }
    /**
     * Get information about a specific backup file.
     */
    async getBackupInfo(filename) {
        try {
            const backupPath = path.join(this.backupDir, filename);
            const stats = await fs.stat(backupPath);
            return {
                filename,
                size: stats.size,
                created: stats.birthtime,
                modified: stats.mtime,
            };
        }
        catch (error) {
            this.logger.error(`Failed to get backup info: ${error.message}`);
            return null;
        }
    }
    async sendBackupFailureAlert(error) {
        const adminEmail = this.configService.get('BACKUP_ADMIN_EMAIL');
        if (!adminEmail) {
            this.logger.warn('No BACKUP_ADMIN_EMAIL configured, cannot send alert.');
            return;
        }
        await this.emailService.sendImmediate({
            to: adminEmail,
            subject: 'Backup Failure Alert',
            templateName: 'backup-failure',
            context: {
                error,
                timestamp: new Date().toISOString(),
            },
        });
    }
};
exports.BackupService = BackupService;
__decorate([
    (0, schedule_1.Cron)(schedule_1.CronExpression.EVERY_DAY_AT_2AM),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", typeof (_e = typeof Promise !== "undefined" && Promise) === "function" ? _e : Object)
], BackupService.prototype, "scheduledDatabaseBackup", null);
__decorate([
    (0, schedule_1.Cron)(schedule_1.CronExpression.EVERY_WEEK),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", typeof (_f = typeof Promise !== "undefined" && Promise) === "function" ? _f : Object)
], BackupService.prototype, "scheduledApplicationDataBackup", null);
exports.BackupService = BackupService = BackupService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof config_1.ConfigService !== "undefined" && config_1.ConfigService) === "function" ? _a : Object, typeof (_b = typeof backup_verification_service_1.BackupVerificationService !== "undefined" && backup_verification_service_1.BackupVerificationService) === "function" ? _b : Object, typeof (_c = typeof backup_retention_service_1.BackupRetentionService !== "undefined" && backup_retention_service_1.BackupRetentionService) === "function" ? _c : Object, typeof (_d = typeof email_service_1.EmailService !== "undefined" && email_service_1.EmailService) === "function" ? _d : Object])
], BackupService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxvam9zZXBoXFxEb2N1bWVudHNcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFxiYWNrdXBcXGJhY2t1cC5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsc0NBQXNDO0FBQ3RDLDJDQUFvRDtBQUNwRCwyQ0FBK0M7QUFDL0MsK0NBQXdEO0FBQ3hELGlEQUFxQztBQUNyQywrQkFBaUM7QUFDakMsZ0RBQWtDO0FBQ2xDLDJDQUE2QjtBQUM3QiwrRUFBMEU7QUFDMUUseUVBQW9FO0FBQ3BFLDBEQUFzRDtBQUV0RCxNQUFNLFNBQVMsR0FBRyxJQUFBLGdCQUFTLEVBQUMsb0JBQUksQ0FBQyxDQUFDO0FBVWxDOztHQUVHO0FBRUksSUFBTSxhQUFhLHFCQUFuQixNQUFNLGFBQWE7SUFLeEIsWUFDbUIsYUFBNEIsRUFDNUIsbUJBQThDLEVBQzlDLGdCQUF3QyxFQUN4QyxZQUEwQjtRQUgxQixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUM1Qix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQTJCO1FBQzlDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBd0I7UUFDeEMsaUJBQVksR0FBWixZQUFZLENBQWM7UUFSNUIsV0FBTSxHQUFHLElBQUksZUFBTSxDQUFDLGVBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQVV2RCxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFTLFlBQVksRUFBRSxXQUFXLENBQUMsQ0FBQztRQUMzRSxJQUFJLENBQUMsUUFBUSxHQUFHO1lBQ2QsSUFBSSxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFTLGVBQWUsQ0FBQztZQUNyRCxJQUFJLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQVMsZUFBZSxDQUFDO1lBQ3JELFFBQVEsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBUyxlQUFlLENBQUM7WUFD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LE1BQU0sQ0FBQyxJQUFJLENBQUMsc0RBQXNELENBQUMsQ0FBQztZQUN6RSxPQUFPO1FBQ1QsQ0FBQztRQUNELE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxhQUFhLENBQUM7WUFDcEMsRUFBRSxFQUFFLFVBQVU7WUFDZCxPQUFPLEVBQUUsc0JBQXNCO1lBQy9CLFlBQVksRUFBRSxnQkFBZ0I7WUFDOUIsT0FBTyxFQUFFO2dCQUNQLEtBQUs7Z0JBQ0wsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO2FBQ3BDO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGLENBQUE7QUFuT1ksc0NBQWE7QUFnQ2xCO0lBREwsSUFBQSxlQUFJLEVBQUMseUJBQWMsQ0FBQyxnQkFBZ0IsQ0FBQzs7O3dEQUNMLE9BQU8sb0JBQVAsT0FBTzs0REFvQnZDO0FBR0s7SUFETCxJQUFBLGVBQUksRUFBQyx5QkFBYyxDQUFDLFVBQVUsQ0FBQzs7O3dEQUNRLE9BQU8sb0JBQVAsT0FBTzttRUFpQjlDO3dCQXhFVSxhQUFhO0lBRHpCLElBQUEsbUJBQVUsR0FBRTt5REFPdUIsc0JBQWEsb0JBQWIsc0JBQWEsb0RBQ1AsdURBQXlCLG9CQUF6Qix1REFBeUIsb0RBQzVCLGlEQUFzQixvQkFBdEIsaURBQXNCLG9EQUMxQiw0QkFBWSxvQkFBWiw0QkFBWTtHQVRsQyxhQUFhLENBbU96QiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXG9qb3NlcGhcXERvY3VtZW50c1xcU3RyZWxsZXJNaW5kcy1CYWNrZW5kXFxzcmNcXGJhY2t1cFxcYmFja3VwLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgcHJldHRpZXIvcHJldHRpZXIgKi9cclxuaW1wb3J0IHsgSW5qZWN0YWJsZSwgTG9nZ2VyIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xyXG5pbXBvcnQgeyBDb25maWdTZXJ2aWNlIH0gZnJvbSAnQG5lc3Rqcy9jb25maWcnO1xyXG5pbXBvcnQgeyBDcm9uLCBDcm9uRXhwcmVzc2lvbiB9IGZyb20gJ0BuZXN0anMvc2NoZWR1bGUnO1xyXG5pbXBvcnQgeyBleGVjIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XHJcbmltcG9ydCB7IHByb21pc2lmeSB9IGZyb20gJ3V0aWwnO1xyXG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcy9wcm9taXNlcyc7XHJcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XHJcbmltcG9ydCB7IEJhY2t1cFZlcmlmaWNhdGlvblNlcnZpY2UgfSBmcm9tICcuL2JhY2t1cC12ZXJpZmljYXRpb24uc2VydmljZSc7XHJcbmltcG9ydCB7IEJhY2t1cFJldGVudGlvblNlcnZpY2UgfSBmcm9tICcuL2JhY2t1cC1yZXRlbnRpb24uc2VydmljZSc7XHJcbmltcG9ydCB7IEVtYWlsU2VydmljZSB9IGZyb20gJy4uL2VtYWlsL2VtYWlsLnNlcnZpY2UnO1xyXG5cclxuY29uc3QgZXhlY0FzeW5jID0gcHJvbWlzaWZ5KGV4ZWMpO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBCYWNrdXBSZXN1bHQge1xyXG4gIHN1Y2Nlc3M6IGJvb2xlYW47XHJcbiAgYmFja3VwUGF0aD86IHN0cmluZztcclxuICBzaXplPzogbnVtYmVyO1xyXG4gIGR1cmF0aW9uPzogbnVtYmVyO1xyXG4gIGVycm9yPzogc3RyaW5nO1xyXG59XHJcblxyXG4vKipcclxuICogQmFja3VwU2VydmljZSBwcm92aWRlcyBsb2dpYyBmb3IgY3JlYXRpbmcsIGxpc3RpbmcsIGFuZCB2ZXJpZnlpbmcgYmFja3Vwcy5cclxuICovXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEJhY2t1cFNlcnZpY2Uge1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyID0gbmV3IExvZ2dlcihCYWNrdXBTZXJ2aWNlLm5hbWUpO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgYmFja3VwRGlyOiBzdHJpbmc7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBkYkNvbmZpZzogYW55O1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgY29uZmlnU2VydmljZTogQ29uZmlnU2VydmljZSxcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgdmVyaWZpY2F0aW9uU2VydmljZTogQmFja3VwVmVyaWZpY2F0aW9uU2VydmljZSxcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgcmV0ZW50aW9uU2VydmljZTogQmFja3VwUmV0ZW50aW9uU2VydmljZSxcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgZW1haWxTZXJ2aWNlOiBFbWFpbFNlcnZpY2UsXHJcbiAgKSB7XHJcbiAgICB0aGlzLmJhY2t1cERpciA9IHRoaXMuY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPignQkFDS1VQX0RJUicsICcuL2JhY2t1cHMnKTtcclxuICAgIHRoaXMuZGJDb25maWcgPSB7XHJcbiAgICAgIGhvc3Q6IHRoaXMuY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPignZGF0YWJhc2UuaG9zdCcpLFxyXG4gICAgICBwb3J0OiB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PG51bWJlcj4oJ2RhdGFiYXNlLnBvcnQnKSxcclxuICAgICAgdXNlcm5hbWU6IHRoaXMuY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPignZGF0YWJhc2UudXNlcicpLFxyXG4gICAgICBwYXNzd29yZDogdGhpcy5jb25maWdTZXJ2aWNlLmdldDxzdHJpbmc+KCdkYXRhYmFzZS5wYXNzd29yZCcpLFxyXG4gICAgICBkYXRhYmFzZTogdGhpcy5jb25maWdTZXJ2aWNlLmdldDxzdHJpbmc+KCdkYXRhYmFzZS5uYW1lJyksXHJcbiAgICB9O1xyXG4gICAgdGhpcy5lbnN1cmVCYWNrdXBEaXJlY3RvcnkoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYXN5bmMgZW5zdXJlQmFja3VwRGlyZWN0b3J5KCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgYXdhaXQgZnMuYWNjZXNzKHRoaXMuYmFja3VwRGlyKTtcclxuICAgIH0gY2F0Y2gge1xyXG4gICAgICBhd2FpdCBmcy5ta2Rpcih0aGlzLmJhY2t1cERpciwgeyByZWN1cnNpdmU6IHRydWUgfSk7XHJcbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhgQ3JlYXRlZCBiYWNrdXAgZGlyZWN0b3J5OiAke3RoaXMuYmFja3VwRGlyfWApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgQENyb24oQ3JvbkV4cHJlc3Npb24uRVZFUllfREFZX0FUXzJBTSlcclxuICBhc3luYyBzY2hlZHVsZWREYXRhYmFzZUJhY2t1cCgpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIHRoaXMubG9nZ2VyLmxvZygnU3RhcnRpbmcgc2NoZWR1bGVkIGRhdGFiYXNlIGJhY2t1cCcpO1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5jcmVhdGVEYXRhYmFzZUJhY2t1cCgpO1xyXG4gICAgICBpZiAocmVzdWx0LnN1Y2Nlc3MpIHtcclxuICAgICAgICB0aGlzLmxvZ2dlci5sb2coXHJcbiAgICAgICAgICBgU2NoZWR1bGVkIGJhY2t1cCBjb21wbGV0ZWQgc3VjY2Vzc2Z1bGx5OiAke3Jlc3VsdC5iYWNrdXBQYXRofWAsXHJcbiAgICAgICAgKTtcclxuICAgICAgICBhd2FpdCB0aGlzLnJldGVudGlvblNlcnZpY2UuY2xlYW51cE9sZEJhY2t1cHMoKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihgU2NoZWR1bGVkIGJhY2t1cCBmYWlsZWQ6ICR7cmVzdWx0LmVycm9yfWApO1xyXG4gICAgICAgIGF3YWl0IHRoaXMuc2VuZEJhY2t1cEZhaWx1cmVBbGVydChyZXN1bHQuZXJyb3IpO1xyXG4gICAgICB9XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcclxuICAgICAgICBgU2NoZWR1bGVkIGJhY2t1cCBlcnJvcjogJHtlcnJvci5tZXNzYWdlfWAsXHJcbiAgICAgICAgZXJyb3Iuc3RhY2ssXHJcbiAgICAgICk7XHJcbiAgICAgIGF3YWl0IHRoaXMuc2VuZEJhY2t1cEZhaWx1cmVBbGVydChlcnJvci5tZXNzYWdlKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIEBDcm9uKENyb25FeHByZXNzaW9uLkVWRVJZX1dFRUspXHJcbiAgYXN5bmMgc2NoZWR1bGVkQXBwbGljYXRpb25EYXRhQmFja3VwKCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgdGhpcy5sb2dnZXIubG9nKCdTdGFydGluZyBzY2hlZHVsZWQgYXBwbGljYXRpb24gZGF0YSBiYWNrdXAnKTtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuY3JlYXRlQXBwbGljYXRpb25EYXRhQmFja3VwKCk7XHJcbiAgICAgIGlmIChyZXN1bHQuc3VjY2Vzcykge1xyXG4gICAgICAgIHRoaXMubG9nZ2VyLmxvZyhcclxuICAgICAgICAgIGBBcHBsaWNhdGlvbiBkYXRhIGJhY2t1cCBjb21wbGV0ZWQ6ICR7cmVzdWx0LmJhY2t1cFBhdGh9YCxcclxuICAgICAgICApO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGBBcHBsaWNhdGlvbiBkYXRhIGJhY2t1cCBmYWlsZWQ6ICR7cmVzdWx0LmVycm9yfWApO1xyXG4gICAgICB9XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcclxuICAgICAgICBgQXBwbGljYXRpb24gZGF0YSBiYWNrdXAgZXJyb3I6ICR7ZXJyb3IubWVzc2FnZX1gLFxyXG4gICAgICAgIGVycm9yLnN0YWNrLFxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ3JlYXRlIGEgbWFudWFsIGRhdGFiYXNlIGJhY2t1cC5cclxuICAgKi9cclxuICBhc3luYyBjcmVhdGVEYXRhYmFzZUJhY2t1cCgpOiBQcm9taXNlPEJhY2t1cFJlc3VsdD4ge1xyXG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcclxuICAgIGNvbnN0IHRpbWVzdGFtcCA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5yZXBsYWNlKC9bOi5dL2csICctJyk7XHJcbiAgICBjb25zdCBiYWNrdXBGaWxlTmFtZSA9IGBkYi1iYWNrdXAtJHt0aW1lc3RhbXB9LnNxbGA7XHJcbiAgICBjb25zdCBiYWNrdXBQYXRoID0gcGF0aC5qb2luKHRoaXMuYmFja3VwRGlyLCBiYWNrdXBGaWxlTmFtZSk7XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgLy8gU2V0IFBHUEFTU1dPUkQgZW52aXJvbm1lbnQgdmFyaWFibGUgZm9yIHBnX2R1bXBcclxuICAgICAgY29uc3QgZW52ID0geyAuLi5wcm9jZXNzLmVudiwgUEdQQVNTV09SRDogdGhpcy5kYkNvbmZpZy5wYXNzd29yZCB9O1xyXG5cclxuICAgICAgY29uc3QgY29tbWFuZCA9IGBwZ19kdW1wIC1oICR7dGhpcy5kYkNvbmZpZy5ob3N0fSAtcCAke3RoaXMuZGJDb25maWcucG9ydH0gLVUgJHt0aGlzLmRiQ29uZmlnLnVzZXJuYW1lfSAtZCAke3RoaXMuZGJDb25maWcuZGF0YWJhc2V9IC1mIFwiJHtiYWNrdXBQYXRofVwiIC0tdmVyYm9zZSAtLW5vLXBhc3N3b3JkYDtcclxuXHJcbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhcclxuICAgICAgICBgRXhlY3V0aW5nIGJhY2t1cCBjb21tYW5kIGZvciBkYXRhYmFzZTogJHt0aGlzLmRiQ29uZmlnLmRhdGFiYXNlfWAsXHJcbiAgICAgICk7XHJcbiAgICAgIGF3YWl0IGV4ZWNBc3luYyhjb21tYW5kLCB7IGVudiB9KTtcclxuXHJcbiAgICAgIC8vIEdldCBiYWNrdXAgZmlsZSBzaXplXHJcbiAgICAgIGNvbnN0IHN0YXRzID0gYXdhaXQgZnMuc3RhdChiYWNrdXBQYXRoKTtcclxuICAgICAgY29uc3QgZHVyYXRpb24gPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lO1xyXG5cclxuICAgICAgdGhpcy5sb2dnZXIubG9nKFxyXG4gICAgICAgIGBEYXRhYmFzZSBiYWNrdXAgY3JlYXRlZDogJHtiYWNrdXBQYXRofSAoJHtzdGF0cy5zaXplfSBieXRlcywgJHtkdXJhdGlvbn1tcylgLFxyXG4gICAgICApO1xyXG5cclxuICAgICAgLy8gVmVyaWZ5IGJhY2t1cFxyXG4gICAgICBjb25zdCBpc1ZhbGlkID1cclxuICAgICAgICBhd2FpdCB0aGlzLnZlcmlmaWNhdGlvblNlcnZpY2UudmVyaWZ5RGF0YWJhc2VCYWNrdXAoYmFja3VwUGF0aCk7XHJcbiAgICAgIGlmICghaXNWYWxpZCkge1xyXG4gICAgICAgIGF3YWl0IHRoaXMuc2VuZEJhY2t1cEZhaWx1cmVBbGVydCgnQmFja3VwIHZlcmlmaWNhdGlvbiBmYWlsZWQnKTtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0JhY2t1cCB2ZXJpZmljYXRpb24gZmFpbGVkJyk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcclxuICAgICAgICBiYWNrdXBQYXRoLFxyXG4gICAgICAgIHNpemU6IHN0YXRzLnNpemUsXHJcbiAgICAgICAgZHVyYXRpb24sXHJcbiAgICAgIH07XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcclxuICAgICAgICBgRGF0YWJhc2UgYmFja3VwIGZhaWxlZDogJHtlcnJvci5tZXNzYWdlfWAsXHJcbiAgICAgICAgZXJyb3Iuc3RhY2ssXHJcbiAgICAgICk7XHJcbiAgICAgIGF3YWl0IHRoaXMuc2VuZEJhY2t1cEZhaWx1cmVBbGVydChlcnJvci5tZXNzYWdlKTtcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICBlcnJvcjogZXJyb3IubWVzc2FnZSxcclxuICAgICAgfTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENyZWF0ZSBhIG1hbnVhbCBhcHBsaWNhdGlvbiBkYXRhIGJhY2t1cC5cclxuICAgKi9cclxuICBhc3luYyBjcmVhdGVBcHBsaWNhdGlvbkRhdGFCYWNrdXAoKTogUHJvbWlzZTxCYWNrdXBSZXN1bHQ+IHtcclxuICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7IC8vIEFkZCBtaXNzaW5nIHN0YXJ0VGltZSB2YXJpYWJsZVxyXG4gICAgY29uc3QgdGltZXN0YW1wID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpLnJlcGxhY2UoL1s6Ll0vZywgJy0nKTtcclxuICAgIGNvbnN0IGJhY2t1cEZpbGVOYW1lID0gYGFwcC1kYXRhLWJhY2t1cC0ke3RpbWVzdGFtcH0udGFyLmd6YDtcclxuICAgIGNvbnN0IGJhY2t1cFBhdGggPSBwYXRoLmpvaW4odGhpcy5iYWNrdXBEaXIsIGJhY2t1cEZpbGVOYW1lKTtcclxuXHJcbiAgICB0cnkge1xyXG4gICAgICAvLyBVc2UgdGhlIHZhcmlhYmxlcyBpbiB0aGUgdGFyIGNvbW1hbmQgb3IgcmVtb3ZlIHRoZW0gaWYgbm90IG5lZWRlZFxyXG4gICAgICBjb25zdCB1cGxvYWREaXIgPSB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oXHJcbiAgICAgICAgJ1VQTE9BRF9ESVInLFxyXG4gICAgICAgICcuL3VwbG9hZHMnLFxyXG4gICAgICApO1xyXG4gICAgICBjb25zdCBsb2dzRGlyID0gJy4vbG9ncyc7XHJcblxyXG4gICAgICAvLyBDcmVhdGUgdGFyLmd6IGFyY2hpdmUgb2YgYXBwbGljYXRpb24gZGF0YSB1c2luZyB0aGUgdmFyaWFibGVzXHJcbiAgICAgIGNvbnN0IGNvbW1hbmQgPSBgdGFyIC1jemYgXCIke2JhY2t1cFBhdGh9XCIgLUMgLiBcIiR7dXBsb2FkRGlyLnJlcGxhY2UoJy4vJywgJycpfVwiLCBcIiR7bG9nc0Rpci5yZXBsYWNlKCcuLycsICcnKX1cIiwgLmVudi5wcm9kdWN0aW9uYDtcclxuXHJcbiAgICAgIHRoaXMubG9nZ2VyLmxvZygnQ3JlYXRpbmcgYXBwbGljYXRpb24gZGF0YSBiYWNrdXAnKTtcclxuICAgICAgYXdhaXQgZXhlY0FzeW5jKGNvbW1hbmQpO1xyXG5cclxuICAgICAgY29uc3Qgc3RhdHMgPSBhd2FpdCBmcy5zdGF0KGJhY2t1cFBhdGgpO1xyXG4gICAgICBjb25zdCBkdXJhdGlvbiA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XHJcblxyXG4gICAgICB0aGlzLmxvZ2dlci5sb2coXHJcbiAgICAgICAgYEFwcGxpY2F0aW9uIGRhdGEgYmFja3VwIGNyZWF0ZWQ6ICR7YmFja3VwUGF0aH0gKCR7c3RhdHMuc2l6ZX0gYnl0ZXMsICR7ZHVyYXRpb259bXMpYCxcclxuICAgICAgKTtcclxuXHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcclxuICAgICAgICBiYWNrdXBQYXRoLFxyXG4gICAgICAgIHNpemU6IHN0YXRzLnNpemUsXHJcbiAgICAgICAgZHVyYXRpb24sXHJcbiAgICAgIH07XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcclxuICAgICAgICBgQXBwbGljYXRpb24gZGF0YSBiYWNrdXAgZmFpbGVkOiAke2Vycm9yLm1lc3NhZ2V9YCxcclxuICAgICAgICBlcnJvci5zdGFjayxcclxuICAgICAgKTtcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICBlcnJvcjogZXJyb3IubWVzc2FnZSxcclxuICAgICAgfTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIExpc3QgYWxsIGJhY2t1cCBmaWxlcy5cclxuICAgKi9cclxuICBhc3luYyBsaXN0QmFja3VwcygpOiBQcm9taXNlPHN0cmluZ1tdPiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCBmaWxlcyA9IGF3YWl0IGZzLnJlYWRkaXIodGhpcy5iYWNrdXBEaXIpO1xyXG4gICAgICByZXR1cm4gZmlsZXMuZmlsdGVyKFxyXG4gICAgICAgIChmaWxlKSA9PiBmaWxlLmVuZHNXaXRoKCcuc3FsJykgfHwgZmlsZS5lbmRzV2l0aCgnLnRhci5neicpLFxyXG4gICAgICApO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoYEZhaWxlZCB0byBsaXN0IGJhY2t1cHM6ICR7ZXJyb3IubWVzc2FnZX1gKTtcclxuICAgICAgcmV0dXJuIFtdO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2V0IGluZm9ybWF0aW9uIGFib3V0IGEgc3BlY2lmaWMgYmFja3VwIGZpbGUuXHJcbiAgICovXHJcbiAgYXN5bmMgZ2V0QmFja3VwSW5mbyhmaWxlbmFtZTogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IGJhY2t1cFBhdGggPSBwYXRoLmpvaW4odGhpcy5iYWNrdXBEaXIsIGZpbGVuYW1lKTtcclxuICAgICAgY29uc3Qgc3RhdHMgPSBhd2FpdCBmcy5zdGF0KGJhY2t1cFBhdGgpO1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIGZpbGVuYW1lLFxyXG4gICAgICAgIHNpemU6IHN0YXRzLnNpemUsXHJcbiAgICAgICAgY3JlYXRlZDogc3RhdHMuYmlydGh0aW1lLFxyXG4gICAgICAgIG1vZGlmaWVkOiBzdGF0cy5tdGltZSxcclxuICAgICAgfTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGBGYWlsZWQgdG8gZ2V0IGJhY2t1cCBpbmZvOiAke2Vycm9yLm1lc3NhZ2V9YCk7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBhc3luYyBzZW5kQmFja3VwRmFpbHVyZUFsZXJ0KGVycm9yOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGNvbnN0IGFkbWluRW1haWwgPSB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oJ0JBQ0tVUF9BRE1JTl9FTUFJTCcpO1xyXG4gICAgaWYgKCFhZG1pbkVtYWlsKSB7XHJcbiAgICAgIHRoaXMubG9nZ2VyLndhcm4oJ05vIEJBQ0tVUF9BRE1JTl9FTUFJTCBjb25maWd1cmVkLCBjYW5ub3Qgc2VuZCBhbGVydC4nKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgYXdhaXQgdGhpcy5lbWFpbFNlcnZpY2Uuc2VuZEltbWVkaWF0ZSh7XHJcbiAgICAgIHRvOiBhZG1pbkVtYWlsLFxyXG4gICAgICBzdWJqZWN0OiAnQmFja3VwIEZhaWx1cmUgQWxlcnQnLFxyXG4gICAgICB0ZW1wbGF0ZU5hbWU6ICdiYWNrdXAtZmFpbHVyZScsXHJcbiAgICAgIGNvbnRleHQ6IHtcclxuICAgICAgICBlcnJvcixcclxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcclxuICAgICAgfSxcclxuICAgIH0pO1xyXG4gIH1cclxufVxyXG4iXSwidmVyc2lvbiI6M30=