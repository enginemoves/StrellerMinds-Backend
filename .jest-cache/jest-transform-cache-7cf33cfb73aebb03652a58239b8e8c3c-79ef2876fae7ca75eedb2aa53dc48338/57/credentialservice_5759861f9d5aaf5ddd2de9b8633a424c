0f0030224cc887554c95d9af469b9790
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.CredentialService = void 0;
const common_1 = require("@nestjs/common");
const typeorm_1 = require("@nestjs/typeorm");
const typeorm_2 = require("typeorm");
const credential_entity_1 = require("./entities/credential.entity");
const credential_history_query_dto_1 = require("./dto/credential-history-query.dto");
const stellar_service_1 = require("../blockchain/stellar/stellar.service");
/**
 * CredentialService provides logic for credential management and history retrieval.
 */
let CredentialService = class CredentialService {
    constructor(credentialRepository, stellarService) {
        this.credentialRepository = credentialRepository;
        this.stellarService = stellarService;
    }
    /**
     * Get user credential history.
     *
     * @param userId - The ID of the user whose credential history is to be retrieved.
     * @param queryParams - The query parameters for retrieving credential history, including pagination and filters.
     * @returns A promise that resolves to the user's credential history response DTO.
     */
    async getUserCredentialHistory(userId, queryParams) {
        const { page = 1, limit = 10, credentialType, startDate, endDate, status } = queryParams;
        // Build query conditions
        const findOptions = {
            where: { userId },
            order: { issuedAt: 'DESC' },
            skip: (page - 1) * limit,
            take: limit,
        };
        // Add filters if provided
        if (credentialType) {
            findOptions.where = { ...findOptions.where, type: credentialType };
        }
        if (startDate && endDate) {
            findOptions.where = {
                ...findOptions.where,
                issuedAt: (0, typeorm_2.Between)(startDate, endDate)
            };
        }
        if (status && status !== credential_history_query_dto_1.CredentialStatus.ALL) {
            findOptions.where = { ...findOptions.where, status };
        }
        // Execute query with pagination
        const [credentials, totalItems] = await this.credentialRepository.findAndCount(findOptions);
        // Map to DTOs
        const mappedCredentials = credentials.map(credential => this.mapToCredentialDto(credential));
        return {
            data: mappedCredentials,
            meta: {
                page,
                limit,
                totalItems,
                totalPages: Math.ceil(totalItems / limit),
            },
        };
    }
    /**
     * Verify a user's credential by its ID.
     *
     * @param userId - The ID of the user who owns the credential.
     * @param credentialId - The ID of the credential to be verified.
     * @returns A promise that resolves to an object containing the verification result and the credential DTO.
     */
    async verifyCredential(userId, credentialId) {
        // Find the credential
        const credential = await this.credentialRepository.findOne({
            where: { id: credentialId, userId }
        });
        if (!credential) {
            throw new common_1.HttpException('Credential not found', common_1.HttpStatus.NOT_FOUND);
        }
        // Verify on the blockchain using Stellar SDK
        let verified = false;
        try {
            if (credential.network?.toLowerCase() !== 'stellar') {
                // Currently only Stellar network is supported for on-chain verification
                verified = false;
            }
            else if (credential.txHash) {
                const tx = await this.stellarService.monitorTransaction(credential.txHash);
                if (tx) {
                    // If blockHeight is stored, ensure it matches the ledger sequence
                    if (credential.blockHeight && typeof tx.ledger === 'number') {
                        verified = Number(credential.blockHeight) === Number(tx.ledger);
                    }
                    else {
                        verified = true;
                    }
                }
            }
        }
        catch (err) {
            verified = false;
        }
        // Update verification status in database
        credential.verificationStatus = verified;
        await this.credentialRepository.save(credential);
        return {
            verified,
            credential: this.mapToCredentialDto(credential),
        };
    }
    /**
     * Maps a Credential entity to a CredentialDto.
     * @param credential - The Credential entity instance.
     * @returns The mapped CredentialDto.
     */
    mapToCredentialDto(credential) {
        return {
            id: credential.id,
            type: credential.type,
            name: credential.name,
            issuedAt: credential.issuedAt,
            expiresAt: credential.expiresAt,
            issuer: {
                id: credential.issuerId,
                name: credential.issuerName,
            },
            status: credential.status,
            verificationStatus: credential.verificationStatus,
            metadata: credential.metadata,
            blockchainReference: {
                txHash: credential.txHash,
                network: credential.network,
                timestamp: credential.issuedAt,
                blockHeight: credential.blockHeight,
            },
        };
    }
};
exports.CredentialService = CredentialService;
exports.CredentialService = CredentialService = __decorate([
    (0, common_1.Injectable)(),
    __param(0, (0, typeorm_1.InjectRepository)(credential_entity_1.Credential)),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _a : Object, typeof (_b = typeof stellar_service_1.StellarService !== "undefined" && stellar_service_1.StellarService) === "function" ? _b : Object])
], CredentialService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxvam9zZXBoXFxEb2N1bWVudHNcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFxjcmVkZW50aWFsXFxjcmVkZW50aWFsLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUF1RTtBQUN2RSw2Q0FBbUQ7QUFDbkQscUNBQStEO0FBQy9ELG9FQUEwRDtBQUMxRCxxRkFBaUc7QUFFakcsMkVBQXVFO0FBRXZFOztHQUVHO0FBRUksSUFBTSxpQkFBaUIsR0FBdkIsTUFBTSxpQkFBaUI7SUFDNUIsWUFFVSxvQkFBNEMsRUFDbkMsY0FBOEI7UUFEdkMseUJBQW9CLEdBQXBCLG9CQUFvQixDQUF3QjtRQUNuQyxtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7SUFDOUMsQ0FBQztJQUVKOzs7Ozs7T0FNRztJQUNILEtBQUssQ0FBQyx3QkFBd0IsQ0FDNUIsTUFBYyxFQUNkLFdBQXNDO1FBRXRDLE1BQU0sRUFBRSxJQUFJLEdBQUcsQ0FBQyxFQUFFLEtBQUssR0FBRyxFQUFFLEVBQUUsY0FBYyxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLEdBQUcsV0FBVyxDQUFDO1FBRXpGLHlCQUF5QjtRQUN6QixNQUFNLFdBQVcsR0FBZ0M7WUFDL0MsS0FBSyxFQUFFLEVBQUUsTUFBTSxFQUFFO1lBQ2pCLEtBQUssRUFBRSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUU7WUFDM0IsSUFBSSxFQUFFLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxHQUFHLEtBQUs7WUFDeEIsSUFBSSxFQUFFLEtBQUs7U0FDWixDQUFDO1FBRUYsMEJBQTBCO1FBQzFCLElBQUksY0FBYyxFQUFFLENBQUM7WUFDbkIsV0FBVyxDQUFDLEtBQUssR0FBRyxFQUFFLEdBQUcsV0FBVyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFLENBQUM7UUFDckUsQ0FBQztRQUVELElBQUksU0FBUyxJQUFJLE9BQU8sRUFBRSxDQUFDO1lBQ3pCLFdBQVcsQ0FBQyxLQUFL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QyxVQUFzQjtRQUMvQyxPQUFPO1lBQ0wsRUFBRSxFQUFFLFVBQVUsQ0FBQyxFQUFFO1lBQ2pCLElBQUksRUFBRSxVQUFVLENBQUMsSUFBSTtZQUNyQixJQUFJLEVBQUUsVUFBVSxDQUFDLElBQUk7WUFDckIsUUFBUSxFQUFFLFVBQVUsQ0FBQyxRQUFRO1lBQzdCLFNBQVMsRUFBRSxVQUFVLENBQUMsU0FBUztZQUMvQixNQUFNLEVBQUU7Z0JBQ04sRUFBRSxFQUFFLFVBQVUsQ0FBQyxRQUFRO2dCQUN2QixJQUFJLEVBQUUsVUFBVSxDQUFDLFVBQVU7YUFDNUI7WUFDRCxNQUFNLEVBQUUsVUFBVSxDQUFDLE1BQU07WUFDekIsa0JBQWtCLEVBQUUsVUFBVSxDQUFDLGtCQUFrQjtZQUNqRCxRQUFRLEVBQUUsVUFBVSxDQUFDLFFBQVE7WUFDN0IsbUJBQW1CLEVBQUU7Z0JBQ25CLE1BQU0sRUFBRSxVQUFVLENBQUMsTUFBTTtnQkFDekIsT0FBTyxFQUFFLFVBQVUsQ0FBQyxPQUFPO2dCQUMzQixTQUFTLEVBQUUsVUFBVSxDQUFDLFFBQVE7Z0JBQzlCLFdBQVcsRUFBRSxVQUFVLENBQUMsV0FBVzthQUNwQztTQUNGLENBQUM7SUFDSixDQUFDO0NBQ0YsQ0FBQTtBQXhJWSw4Q0FBaUI7NEJBQWpCLGlCQUFpQjtJQUQ3QixJQUFBLG1CQUFVLEdBQUU7SUFHUixXQUFBLElBQUEsMEJBQWdCLEVBQUMsOEJBQVUsQ0FBQyxDQUFBO3lEQUNDLG9CQUFVLG9CQUFWLG9CQUFVLG9EQUNQLGdDQUFjLG9CQUFkLGdDQUFjO0dBSnRDLGlCQUFpQixDQXdJN0IiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxvam9zZXBoXFxEb2N1bWVudHNcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFxjcmVkZW50aWFsXFxjcmVkZW50aWFsLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSHR0cEV4Y2VwdGlvbiwgSHR0cFN0YXR1cyB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcclxuaW1wb3J0IHsgSW5qZWN0UmVwb3NpdG9yeSB9IGZyb20gJ0BuZXN0anMvdHlwZW9ybSc7XHJcbmltcG9ydCB7IFJlcG9zaXRvcnksIEJldHdlZW4sIEZpbmRNYW55T3B0aW9ucyB9IGZyb20gJ3R5cGVvcm0nO1xyXG5pbXBvcnQgeyBDcmVkZW50aWFsIH0gZnJvbSAnLi9lbnRpdGllcy9jcmVkZW50aWFsLmVudGl0eSc7XHJcbmltcG9ydCB7IENyZWRlbnRpYWxIaXN0b3J5UXVlcnlEdG8sIENyZWRlbnRpYWxTdGF0dXMgfSBmcm9tICcuL2R0by9jcmVkZW50aWFsLWhpc3RvcnktcXVlcnkuZHRvJztcclxuaW1wb3J0IHsgQ3JlZGVudGlhbEhpc3RvcnlSZXNwb25zZUR0bywgQ3JlZGVudGlhbER0byB9IGZyb20gJy4vZHRvL2NyZWRlbnRpYWwtaGlzdG9yeS1yZXNwb25zZS5kdG8nO1xyXG5pbXBvcnQgeyBTdGVsbGFyU2VydmljZSB9IGZyb20gJy4uL2Jsb2NrY2hhaW4vc3RlbGxhci9zdGVsbGFyLnNlcnZpY2UnO1xyXG5cclxuLyoqXHJcbiAqIENyZWRlbnRpYWxTZXJ2aWNlIHByb3ZpZGVzIGxvZ2ljIGZvciBjcmVkZW50aWFsIG1hbmFnZW1lbnQgYW5kIGhpc3RvcnkgcmV0cmlldmFsLlxyXG4gKi9cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgQ3JlZGVudGlhbFNlcnZpY2Uge1xyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgQEluamVjdFJlcG9zaXRvcnkoQ3JlZGVudGlhbClcclxuICAgIHByaXZhdGUgY3JlZGVudGlhbFJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8Q3JlZGVudGlhbD4sXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IHN0ZWxsYXJTZXJ2aWNlOiBTdGVsbGFyU2VydmljZSxcclxuICApIHt9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdldCB1c2VyIGNyZWRlbnRpYWwgaGlzdG9yeS5cclxuICAgKlxyXG4gICAqIEBwYXJhbSB1c2VySWQgLSBUaGUgSUQgb2YgdGhlIHVzZXIgd2hvc2UgY3JlZGVudGlhbCBoaXN0b3J5IGlzIHRvIGJlIHJldHJpZXZlZC5cclxuICAgKiBAcGFyYW0gcXVlcnlQYXJhbXMgLSBUaGUgcXVlcnkgcGFyYW1ldGVycyBmb3IgcmV0cmlldmluZyBjcmVkZW50aWFsIGhpc3RvcnksIGluY2x1ZGluZyBwYWdpbmF0aW9uIGFuZCBmaWx0ZXJzLlxyXG4gICAqIEByZXR1cm5zIEEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIHRvIHRoZSB1c2VyJ3MgY3JlZGVudGlhbCBoaXN0b3J5IHJlc3BvbnNlIERUTy5cclxuICAgKi9cclxuICBhc3luYyBnZXRVc2VyQ3JlZGVudGlhbEhpc3RvcnkoXHJcbiAgICB1c2VySWQ6IHN0cmluZyxcclxuICAgIHF1ZXJ5UGFyYW1zOiBDcmVkZW50aWFsSGlzdG9yeVF1ZXJ5RHRvLFxyXG4gICk6IFByb21pc2U8Q3JlZGVudGlhbEhpc3RvcnlSZXNwb25zZUR0bz4ge1xyXG4gICAgY29uc3QgeyBwYWdlID0gMSwgbGltaXQgPSAxMCwgY3JlZGVudGlhbFR5cGUsIHN0YXJ0RGF0ZSwgZW5kRGF0ZSwgc3RhdHVzIH0gPSBxdWVyeVBhcmFtcztcclxuICAgIFxyXG4gICAgLy8gQnVpbGQgcXVlcnkgY29uZGl0aW9uc1xyXG4gICAgY29uc3QgZmluZE9wdGlvbnM6IEZpbmRNYW55T3B0aW9uczxDcmVkZW50aWFsPiA9IHtcclxuICAgICAgd2hlcmU6IHsgdXNlcklkIH0sXHJcbiAgICAgIG9yZGVyOiB7IGlzc3VlZEF0OiAnREVTQycgfSxcclxuICAgICAgc2tpcDogKHBhZ2UgLSAxKSAqIGxpbWl0LFxyXG4gICAgICB0YWtlOiBsaW1pdCxcclxuICAgIH07XHJcblxyXG4gICAgLy8gQWRkIGZpbHRlcnMgaWYgcHJvdmlkZWRcclxuICAgIGlmIChjcmVkZW50aWFsVHlwZSkge1xyXG4gICAgICBmaW5kT3B0aW9ucy53aGVyZSA9IHsgLi4uZmluZE9wdGlvbnMud2hlcmUsIHR5cGU6IGNyZWRlbnRpYWxUeXBlIH07XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHN0YXJ0RGF0ZSAmJiBlbmREYXRlKSB7XHJcbiAgICAgIGZpbmRPcHRpb25zLndoZXJlID0geyBcclxuICAgICAgICAuLi5maW5kT3B0aW9ucy53aGVyZSwgXHJcbiAgICAgICAgaXNzdWVkQXQ6IEJldHdlZW4oc3RhcnREYXRlLCBlbmREYXRlKSBcclxuICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoc3RhdHVzICYmIHN0YXR1cyAhPT0gQ3JlZGVudGlhbFN0YXR1cy5BTEwpIHtcclxuICAgICAgZmluZE9wdGlvbnMud2hlcmUgPSB7IC4uLmZpbmRPcHRpb25zLndoZXJlLCBzdGF0dXMgfTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBFeGVjdXRlIHF1ZXJ5IHdpdGggcGFnaW5hdGlvblxyXG4gICAgY29uc3QgW2NyZWRlbnRpYWxzLCB0b3RhbEl0ZW1zXSA9IGF3YWl0IHRoaXMuY3JlZGVudGlhbFJlcG9zaXRvcnkuZmluZEFuZENvdW50KGZpbmRPcHRpb25zKTtcclxuICAgIFxyXG4gICAgLy8gTWFwIHRvIERUT3NcclxuICAgIGNvbnN0IG1hcHBlZENyZWRlbnRpYWxzID0gY3JlZGVudGlhbHMubWFwKGNyZWRlbnRpYWwgPT4gdGhpcy5tYXBUb0NyZWRlbnRpYWxEdG8oY3JlZGVudGlhbCkpO1xyXG5cclxuICAgIHJldHVybiB7XHJcbiAgICAgIGRhdGE6IG1hcHBlZENyZWRlbnRpYWxzLFxyXG4gICAgICBtZXRhOiB7XHJcbiAgICAgICAgcGFnZSxcclxuICAgICAgICBsaW1pdCxcclxuICAgICAgICB0b3RhbEl0ZW1zLFxyXG4gICAgICAgIHRvdGFsUGFnZXM6IE1hdGguY2VpbCh0b3RhbEl0ZW1zIC8gbGltaXQpLFxyXG4gICAgICB9LFxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFZlcmlmeSBhIHVzZXIncyBjcmVkZW50aWFsIGJ5IGl0cyBJRC5cclxuICAgKiBcclxuICAgKiBAcGFyYW0gdXNlcklkIC0gVGhlIElEIG9mIHRoZSB1c2VyIHdobyBvd25zIHRoZSBjcmVkZW50aWFsLlxyXG4gICAqIEBwYXJhbSBjcmVkZW50aWFsSWQgLSBUaGUgSUQgb2YgdGhlIGNyZWRlbnRpYWwgdG8gYmUgdmVyaWZpZWQuXHJcbiAgICogQHJldHVybnMgQSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgdG8gYW4gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIHZlcmlmaWNhdGlvbiByZXN1bHQgYW5kIHRoZSBjcmVkZW50aWFsIERUTy5cclxuICAgKi9cclxuICBhc3luYyB2ZXJpZnlDcmVkZW50aWFsKHVzZXJJZDogc3RyaW5nLCBjcmVkZW50aWFsSWQ6IHN0cmluZyk6IFByb21pc2U8eyB2ZXJpZmllZDogYm9vbGVhbjsgY3JlZGVudGlhbDogQ3JlZGVudGlhbER0byB9PiB7XHJcbiAgICAvLyBGaW5kIHRoZSBjcmVkZW50aWFsXHJcbiAgICBjb25zdCBjcmVkZW50aWFsID0gYXdhaXQgdGhpcy5jcmVkZW50aWFsUmVwb3NpdG9yeS5maW5kT25lKHsgXHJcbiAgICAgIHdoZXJlOiB7IGlkOiBjcmVkZW50aWFsSWQsIHVzZXJJZCB9IFxyXG4gICAgfSk7XHJcblxyXG4gICAgaWYgKCFjcmVkZW50aWFsKSB7XHJcbiAgICAgIHRocm93IG5ldyBIdHRwRXhjZXB0aW9uKCdDcmVkZW50aWFsIG5vdCBmb3VuZCcsIEh0dHBTdGF0dXMuTk9UX0ZPVU5EKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBWZXJpZnkgb24gdGhlIGJsb2NrY2hhaW4gdXNpbmcgU3RlbGxhciBTREtcclxuICAgIGxldCB2ZXJpZmllZCA9IGZhbHNlO1xyXG4gICAgdHJ5IHtcclxuICAgICAgaWYgKGNyZWRlbnRpYWwubmV0d29yaz8udG9Mb3dlckNhc2UoKSAhPT0gJ3N0ZWxsYXInKSB7XHJcbiAgICAgICAgLy8gQ3VycmVudGx5IG9ubHkgU3RlbGxhciBuZXR3b3JrIGlzIHN1cHBvcnRlZCBmb3Igb24tY2hhaW4gdmVyaWZpY2F0aW9uXHJcbiAgICAgICAgdmVyaWZpZWQgPSBmYWxzZTtcclxuICAgICAgfSBlbHNlIGlmIChjcmVkZW50aWFsLnR4SGFzaCkge1xyXG4gICAgICAgIGNvbnN0IHR4ID0gYXdhaXQgdGhpcy5zdGVsbGFyU2VydmljZS5tb25pdG9yVHJhbnNhY3Rpb24oY3JlZGVudGlhbC50eEhhc2gpO1xyXG4gICAgICAgIGlmICh0eCkge1xyXG4gICAgICAgICAgLy8gSWYgYmxvY2tIZWlnaHQgaXMgc3RvcmVkLCBlbnN1cmUgaXQgbWF0Y2hlcyB0aGUgbGVkZ2VyIHNlcXVlbmNlXHJcbiAgICAgICAgICBpZiAoY3JlZGVudGlhbC5ibG9ja0hlaWdodCAmJiB0eXBlb2YgdHgubGVkZ2VyID09PSAnbnVtYmVyJykge1xyXG4gICAgICAgICAgICB2ZXJpZmllZCA9IE51bWJlcihjcmVkZW50aWFsLmJsb2NrSGVpZ2h0KSA9PT0gTnVtYmVyKHR4LmxlZGdlcik7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB2ZXJpZmllZCA9IHRydWU7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgdmVyaWZpZWQgPSBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBVcGRhdGUgdmVyaWZpY2F0aW9uIHN0YXR1cyBpbiBkYXRhYmFzZVxyXG4gICAgY3JlZGVudGlhbC52ZXJpZmljYXRpb25TdGF0dXMgPSB2ZXJpZmllZDtcclxuICAgIGF3YWl0IHRoaXMuY3JlZGVudGlhbFJlcG9zaXRvcnkuc2F2ZShjcmVkZW50aWFsKTtcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICB2ZXJpZmllZCxcclxuICAgICAgY3JlZGVudGlhbDogdGhpcy5tYXBUb0NyZWRlbnRpYWxEdG8oY3JlZGVudGlhbCksXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogTWFwcyBhIENyZWRlbnRpYWwgZW50aXR5IHRvIGEgQ3JlZGVudGlhbER0by5cclxuICAgKiBAcGFyYW0gY3JlZGVudGlhbCAtIFRoZSBDcmVkZW50aWFsIGVudGl0eSBpbnN0YW5jZS5cclxuICAgKiBAcmV0dXJucyBUaGUgbWFwcGVkIENyZWRlbnRpYWxEdG8uXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBtYXBUb0NyZWRlbnRpYWxEdG8oY3JlZGVudGlhbDogQ3JlZGVudGlhbCk6IENyZWRlbnRpYWxEdG8ge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgaWQ6IGNyZWRlbnRpYWwuaWQsXHJcbiAgICAgIHR5cGU6IGNyZWRlbnRpYWwudHlwZSxcclxuICAgICAgbmFtZTogY3JlZGVudGlhbC5uYW1lLFxyXG4gICAgICBpc3N1ZWRBdDogY3JlZGVudGlhbC5pc3N1ZWRBdCxcclxuICAgICAgZXhwaXJlc0F0OiBjcmVkZW50aWFsLmV4cGlyZXNBdCxcclxuICAgICAgaXNzdWVyOiB7XHJcbiAgICAgICAgaWQ6IGNyZWRlbnRpYWwuaXNzdWVySWQsXHJcbiAgICAgICAgbmFtZTogY3JlZGVudGlhbC5pc3N1ZXJOYW1lLFxyXG4gICAgICB9LFxyXG4gICAgICBzdGF0dXM6IGNyZWRlbnRpYWwuc3RhdHVzLFxyXG4gICAgICB2ZXJpZmljYXRpb25TdGF0dXM6IGNyZWRlbnRpYWwudmVyaWZpY2F0aW9uU3RhdHVzLFxyXG4gICAgICBtZXRhZGF0YTogY3JlZGVudGlhbC5tZXRhZGF0YSxcclxuICAgICAgYmxvY2tjaGFpblJlZmVyZW5jZToge1xyXG4gICAgICAgIHR4SGFzaDogY3JlZGVudGlhbC50eEhhc2gsXHJcbiAgICAgICAgbmV0d29yazogY3JlZGVudGlhbC5uZXR3b3JrLFxyXG4gICAgICAgIHRpbWVzdGFtcDogY3JlZGVudGlhbC5pc3N1ZWRBdCxcclxuICAgICAgICBibG9ja0hlaWdodDogY3JlZGVudGlhbC5ibG9ja0hlaWdodCxcclxuICAgICAgfSxcclxuICAgIH07XHJcbiAgfVxyXG59Il0sInZlcnNpb24iOjN9