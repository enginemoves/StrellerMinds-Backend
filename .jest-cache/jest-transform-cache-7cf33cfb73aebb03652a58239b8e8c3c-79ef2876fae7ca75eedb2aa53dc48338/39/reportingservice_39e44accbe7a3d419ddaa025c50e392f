064c2213f01d018e859aa7d65ff66fd2
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var ReportingService_1;
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.ReportingService = void 0;
const common_1 = require("@nestjs/common");
const schedule_1 = require("@nestjs/schedule");
const report_entity_1 = require("../entities/report.entity");
let ReportingService = ReportingService_1 = class ReportingService {
    constructor(reportRepository, businessIntelligenceService) {
        this.reportRepository = reportRepository;
        this.businessIntelligenceService = businessIntelligenceService;
        this.logger = new common_1.Logger(ReportingService_1.name);
    }
    async createReport(reportData) {
        const report = this.reportRepository.create(reportData);
        return this.reportRepository.save(report);
    }
    async executeReport(reportId) {
        try {
            const report = await this.reportRepository.findOne({
                where: { id: reportId },
            });
            if (!report) {
                throw new Error(`Report ${reportId} not found`);
            }
            const query = {
                metrics: report.configuration.metrics,
                timeRange: {
                    start: new Date(report.configuration.timeRange.start),
                    end: new Date(report.configuration.timeRange.end),
                },
                dimensions: report.configuration.groupBy,
                filters: report.configuration.filters,
            };
            const result = await this.businessIntelligenceService.executeQuery(query);
            // Update report with last execution
            await this.reportRepository.update(reportId, {
                lastExecuted: new Date(),
                lastResult: result,
            });
            return this.formatReportResult(result, report.format);
        }
        catch (error) {
            this.logger.error(`Failed to execute report ${reportId}: ${error.message}`, error.stack);
            throw error;
        }
    }
    formatReportResult(result, format) {
        switch (format) {
            case report_entity_1.ReportFormat.JSON:
                return result;
            case report_entity_1.ReportFormat.CSV:
                return this.convertToCSV(result);
            case report_entity_1.ReportFormat.PDF:
                return this.convertToPDF(result);
            case report_entity_1.ReportFormat.EXCEL:
                return this.convertToExcel(result);
            default:
                return result;
        }
    }
    convertToCSV(result) {
        if (!result.data || result.data.length === 0) {
            return "";
        }
        const headers = ["timestamp", ...Object.keys(result.data[0].metrics)];
        const rows = result.data.map((row) => [row.timestamp.toISOString(), ...Object.values(row.metrics)]);
        return [headers, ...rows].map((row) => row.join(",")).join("\n");
    }
    convertToPDF(result) {
        // Implementation would use a PDF library like puppeteer or pdfkit
        // For now, return a placeholder
        return Buffer.from(JSON.stringify(result));
    }
    convertToExcel(result) {
        // Implementation would use a library like exceljs
        // For now, return a placeholder
        return Buffer.from(JSON.stringify(result));
    }
    async executeScheduledReports() {
        this.logger.log("Checking for scheduled reports");
        const scheduledReports = await this.reportRepository.find({
            where: { type: report_entity_1.ReportType.SCHEDULED, isActive: true },
        });
        for (const report of scheduledReports) {
            if (this.shouldExecuteReport(report)) {
                try {
                    await this.executeReport(report.id);
                    this.logger.log(`Executed scheduled report: ${report.name}`);
                }
                catch (error) {
                    this.logger.error(`Failed to execute scheduled report ${report.name}: ${error.message}`, error.stack);
                }
            }
        }
    }
    shouldExecuteReport(report) {
        if (!report.schedule?.cron) {
            return false;
        }
        // Simple cron check - in production, use a proper cron parser
        const now = new Date();
        const lastExecuted = report.lastExecuted;
        if (!lastExecuted) {
            return true;
        }
        // Check if enough time has passed based on cron schedule
        const timeDiff = now.getTime() - lastExecuted.getTime();
        const fifteenMinutes = 15 * 60 * 1000;
        return timeDiff >= fifteenMinutes;
    }
    async getReports(filters) {
        const query = this.reportRepository.createQueryBuilder("report");
        if (filters?.type) {
            query.andWhere("report.type = :type", { type: filters.type });
        }
        if (filters?.createdBy) {
            query.andWhere("report.createdBy = :createdBy", {
                createdBy: filters.createdBy,
            });
        }
        if (filters?.isActive !== undefined) {
            query.andWhere("report.isActive = :isActive", {
                isActive: filters.isActive,
            });
        }
        return query.orderBy("report.createdAt", "DESC").getMany();
    }
};
exports.ReportingService = ReportingService;
__decorate([
    (0, schedule_1.Cron)("0 */15 * * * *") // Every 15 minutes
    ,
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", typeof (_a = typeof Promise !== "undefined" && Promise) === "function" ? _a : Object)
], ReportingService.prototype, "executeScheduledReports", null);
exports.ReportingService = ReportingService = ReportingService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [Object, Object])
], ReportingService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxvam9zZXBoXFxEb2N1bWVudHNcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFxhbmFseXRpY1xcc2VydmljZXNcXHJlcG9ydGluZy5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQW1EO0FBRW5ELCtDQUF1QztBQUV2Qyw2REFBaUY7QUFJMUUsSUFBTSxnQkFBZ0Isd0JBQXRCLE1BQU0sZ0JBQWdCO0lBRzNCLFlBQ21CLGdCQUFvQyxFQUNwQywyQkFBd0Q7UUFEeEQscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFvQjtRQUNwQyxnQ0FBMkIsR0FBM0IsMkJBQTJCLENBQTZCO1FBSjFELFdBQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyxrQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUt4RCxDQUFDO0lBRUosS0FBSyxDQUFDLFlBQVksQ0FBQyxVQUEyQjtRQUM1QyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFBO1FBQ3ZELE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQTtJQUMzQyxDQUFDO0lBRUQsS0FBSyxDQUFDLGFBQWEsQ0FBQyxRQUFnQjtRQUNsQyxJQUFJLENBQUM7WUFDSCxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUM7Z0JBQ2pELEtBQUssRUFBRSxFQUFFLEVBQUUsRUFBRSxRQUFRLEVBQUU7YUFDeEIsQ0FBQyxDQUFBO1lBRUYsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO2dCQUNaLE1BQU0sSUFBSSxLQUFLLENBQUMsVUFBVSxRQUFRLFlBQVksQ0FBQyxDQUFBO1lBQ2pELENBQUM7WUFFRCxNQUFNLEtBQUssR0FBRztnQkFDWixPQUFPLEVBQUUsTUFBTSxDQUFDLGFBQWEsQ0FBQyxPQUFPO2dCQUNyQyxTQUFTLEVBQUU7b0JBQ1QsS0FBSyxFQUFFLElBQUksSUFB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SUFETCxJQUFBLGVBQUksRUFBQyxnQkFBZ0IsQ0FBQyxDQUFDLG1CQUFtQjs7Ozt3REFDVixPQUFPLG9CQUFQLE9BQU87K0RBaUJ2QzsyQkF4R1UsZ0JBQWdCO0lBRDVCLElBQUEsbUJBQVUsR0FBRTs7R0FDQSxnQkFBZ0IsQ0F1SjVCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcb2pvc2VwaFxcRG9jdW1lbnRzXFxTdHJlbGxlck1pbmRzLUJhY2tlbmRcXHNyY1xcYW5hbHl0aWNcXHNlcnZpY2VzXFxyZXBvcnRpbmcuc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBMb2dnZXIgfSBmcm9tIFwiQG5lc3Rqcy9jb21tb25cIlxyXG5pbXBvcnQgdHlwZSB7IFJlcG9zaXRvcnkgfSBmcm9tIFwidHlwZW9ybVwiXHJcbmltcG9ydCB7IENyb24gfSBmcm9tIFwiQG5lc3Rqcy9zY2hlZHVsZVwiXHJcblxyXG5pbXBvcnQgeyB0eXBlIFJlcG9ydCwgUmVwb3J0VHlwZSwgUmVwb3J0Rm9ybWF0IH0gZnJvbSBcIi4uL2VudGl0aWVzL3JlcG9ydC5lbnRpdHlcIlxyXG5pbXBvcnQgdHlwZSB7IEJ1c2luZXNzSW50ZWxsaWdlbmNlU2VydmljZSB9IGZyb20gXCIuL2J1c2luZXNzLWludGVsbGlnZW5jZS5zZXJ2aWNlXCJcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIFJlcG9ydGluZ1NlcnZpY2Uge1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyID0gbmV3IExvZ2dlcihSZXBvcnRpbmdTZXJ2aWNlLm5hbWUpXHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSByZWFkb25seSByZXBvcnRSZXBvc2l0b3J5OiBSZXBvc2l0b3J5PFJlcG9ydD4sXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IGJ1c2luZXNzSW50ZWxsaWdlbmNlU2VydmljZTogQnVzaW5lc3NJbnRlbGxpZ2VuY2VTZXJ2aWNlLFxyXG4gICkge31cclxuXHJcbiAgYXN5bmMgY3JlYXRlUmVwb3J0KHJlcG9ydERhdGE6IFBhcnRpYWw8UmVwb3J0Pik6IFByb21pc2U8UmVwb3J0PiB7XHJcbiAgICBjb25zdCByZXBvcnQgPSB0aGlzLnJlcG9ydFJlcG9zaXRvcnkuY3JlYXRlKHJlcG9ydERhdGEpXHJcbiAgICByZXR1cm4gdGhpcy5yZXBvcnRSZXBvc2l0b3J5LnNhdmUocmVwb3J0KVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgZXhlY3V0ZVJlcG9ydChyZXBvcnRJZDogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHJlcG9ydCA9IGF3YWl0IHRoaXMucmVwb3J0UmVwb3NpdG9yeS5maW5kT25lKHtcclxuICAgICAgICB3aGVyZTogeyBpZDogcmVwb3J0SWQgfSxcclxuICAgICAgfSlcclxuXHJcbiAgICAgIGlmICghcmVwb3J0KSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBSZXBvcnQgJHtyZXBvcnRJZH0gbm90IGZvdW5kYClcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3QgcXVlcnkgPSB7XHJcbiAgICAgICAgbWV0cmljczogcmVwb3J0LmNvbmZpZ3VyYXRpb24ubWV0cmljcyxcclxuICAgICAgICB0aW1lUmFuZ2U6IHtcclxuICAgICAgICAgIHN0YXJ0OiBuZXcgRGF0ZShyZXBvcnQuY29uZmlndXJhdGlvbi50aW1lUmFuZ2Uuc3RhcnQpLFxyXG4gICAgICAgICAgZW5kOiBuZXcgRGF0ZShyZXBvcnQuY29uZmlndXJhdGlvbi50aW1lUmFuZ2UuZW5kKSxcclxuICAgICAgICB9LFxyXG4gICAgICAgIGRpbWVuc2lvbnM6IHJlcG9ydC5jb25maWd1cmF0aW9uLmdyb3VwQnksXHJcbiAgICAgICAgZmlsdGVyczogcmVwb3J0LmNvbmZpZ3VyYXRpb24uZmlsdGVycyxcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5idXNpbmVzc0ludGVsbGlnZW5jZVNlcnZpY2UuZXhlY3V0ZVF1ZXJ5KHF1ZXJ5KVxyXG5cclxuICAgICAgLy8gVXBkYXRlIHJlcG9ydCB3aXRoIGxhc3QgZXhlY3V0aW9uXHJcbiAgICAgIGF3YWl0IHRoaXMucmVwb3J0UmVwb3NpdG9yeS51cGRhdGUocmVwb3J0SWQsIHtcclxuICAgICAgICBsYXN0RXhlY3V0ZWQ6IG5ldyBEYXRlKCksXHJcbiAgICAgICAgbGFzdFJlc3VsdDogcmVzdWx0LFxyXG4gICAgICB9KVxyXG5cclxuICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0UmVwb3J0UmVzdWx0KHJlc3VsdCwgcmVwb3J0LmZvcm1hdClcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGBGYWlsZWQgdG8gZXhlY3V0ZSByZXBvcnQgJHtyZXBvcnRJZH06ICR7ZXJyb3IubWVzc2FnZX1gLCBlcnJvci5zdGFjaylcclxuICAgICAgdGhyb3cgZXJyb3JcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgZm9ybWF0UmVwb3J0UmVzdWx0KHJlc3VsdDogYW55LCBmb3JtYXQ6IFJlcG9ydEZvcm1hdCk6IGFueSB7XHJcbiAgICBzd2l0Y2ggKGZvcm1hdCkge1xyXG4gICAgICBjYXNlIFJlcG9ydEZvcm1hdC5KU09OOlxyXG4gICAgICAgIHJldHVybiByZXN1bHRcclxuICAgICAgY2FzZSBSZXBvcnRGb3JtYXQuQ1NWOlxyXG4gICAgICAgIHJldHVybiB0aGlzLmNvbnZlcnRUb0NTVihyZXN1bHQpXHJcbiAgICAgIGNhc2UgUmVwb3J0Rm9ybWF0LlBERjpcclxuICAgICAgICByZXR1cm4gdGhpcy5jb252ZXJ0VG9QREYocmVzdWx0KVxyXG4gICAgICBjYXNlIFJlcG9ydEZvcm1hdC5FWENFTDpcclxuICAgICAgICByZXR1cm4gdGhpcy5jb252ZXJ0VG9FeGNlbChyZXN1bHQpXHJcbiAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdFxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjb252ZXJ0VG9DU1YocmVzdWx0OiBhbnkpOiBzdHJpbmcge1xyXG4gICAgaWYgKCFyZXN1bHQuZGF0YSB8fCByZXN1bHQuZGF0YS5sZW5ndGggPT09IDApIHtcclxuICAgICAgcmV0dXJuIFwiXCJcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBoZWFkZXJzID0gW1widGltZXN0YW1wXCIsIC4uLk9iamVjdC5rZXlzKHJlc3VsdC5kYXRhWzBdLm1ldHJpY3MpXVxyXG4gICAgY29uc3Qgcm93cyA9IHJlc3VsdC5kYXRhLm1hcCgocm93OiBhbnkpID0+IFtyb3cudGltZXN0YW1wLnRvSVNPU3RyaW5nKCksIC4uLk9iamVjdC52YWx1ZXMocm93Lm1ldHJpY3MpXSlcclxuXHJcbiAgICByZXR1cm4gW2hlYWRlcnMsIC4uLnJvd3NdLm1hcCgocm93KSA9PiByb3cuam9pbihcIixcIikpLmpvaW4oXCJcXG5cIilcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY29udmVydFRvUERGKHJlc3VsdDogYW55KTogQnVmZmVyIHtcclxuICAgIC8vIEltcGxlbWVudGF0aW9uIHdvdWxkIHVzZSBhIFBERiBsaWJyYXJ5IGxpa2UgcHVwcGV0ZWVyIG9yIHBkZmtpdFxyXG4gICAgLy8gRm9yIG5vdywgcmV0dXJuIGEgcGxhY2Vob2xkZXJcclxuICAgIHJldHVybiBCdWZmZXIuZnJvbShKU09OLnN0cmluZ2lmeShyZXN1bHQpKVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjb252ZXJ0VG9FeGNlbChyZXN1bHQ6IGFueSk6IEJ1ZmZlciB7XHJcbiAgICAvLyBJbXBsZW1lbnRhdGlvbiB3b3VsZCB1c2UgYSBsaWJyYXJ5IGxpa2UgZXhjZWxqc1xyXG4gICAgLy8gRm9yIG5vdywgcmV0dXJuIGEgcGxhY2Vob2xkZXJcclxuICAgIHJldHVybiBCdWZmZXIuZnJvbShKU09OLnN0cmluZ2lmeShyZXN1bHQpKVxyXG4gIH1cclxuXHJcbiAgQENyb24oXCIwICovMTUgKiAqICogKlwiKSAvLyBFdmVyeSAxNSBtaW51dGVzXHJcbiAgYXN5bmMgZXhlY3V0ZVNjaGVkdWxlZFJlcG9ydHMoKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICB0aGlzLmxvZ2dlci5sb2coXCJDaGVja2luZyBmb3Igc2NoZWR1bGVkIHJlcG9ydHNcIilcclxuXHJcbiAgICBjb25zdCBzY2hlZHVsZWRSZXBvcnRzID0gYXdhaXQgdGhpcy5yZXBvcnRSZXBvc2l0b3J5LmZpbmQoe1xyXG4gICAgICB3aGVyZTogeyB0eXBlOiBSZXBvcnRUeXBlLlNDSEVEVUxFRCwgaXNBY3RpdmU6IHRydWUgfSxcclxuICAgIH0pXHJcblxyXG4gICAgZm9yIChjb25zdCByZXBvcnQgb2Ygc2NoZWR1bGVkUmVwb3J0cykge1xyXG4gICAgICBpZiAodGhpcy5zaG91bGRFeGVjdXRlUmVwb3J0KHJlcG9ydCkpIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgYXdhaXQgdGhpcy5leGVjdXRlUmVwb3J0KHJlcG9ydC5pZClcclxuICAgICAgICAgIHRoaXMubG9nZ2VyLmxvZyhgRXhlY3V0ZWQgc2NoZWR1bGVkIHJlcG9ydDogJHtyZXBvcnQubmFtZX1gKVxyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihgRmFpbGVkIHRvIGV4ZWN1dGUgc2NoZWR1bGVkIHJlcG9ydCAke3JlcG9ydC5uYW1lfTogJHtlcnJvci5tZXNzYWdlfWAsIGVycm9yLnN0YWNrKVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzaG91bGRFeGVjdXRlUmVwb3J0KHJlcG9ydDogUmVwb3J0KTogYm9vbGVhbiB7XHJcbiAgICBpZiAoIXJlcG9ydC5zY2hlZHVsZT8uY3Jvbikge1xyXG4gICAgICByZXR1cm4gZmFsc2VcclxuICAgIH1cclxuXHJcbiAgICAvLyBTaW1wbGUgY3JvbiBjaGVjayAtIGluIHByb2R1Y3Rpb24sIHVzZSBhIHByb3BlciBjcm9uIHBhcnNlclxyXG4gICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKVxyXG4gICAgY29uc3QgbGFzdEV4ZWN1dGVkID0gcmVwb3J0Lmxhc3RFeGVjdXRlZFxyXG5cclxuICAgIGlmICghbGFzdEV4ZWN1dGVkKSB7XHJcbiAgICAgIHJldHVybiB0cnVlXHJcbiAgICB9XHJcblxyXG4gICAgLy8gQ2hlY2sgaWYgZW5vdWdoIHRpbWUgaGFzIHBhc3NlZCBiYXNlZCBvbiBjcm9uIHNjaGVkdWxlXHJcbiAgICBjb25zdCB0aW1lRGlmZiA9IG5vdy5nZXRUaW1lKCkgLSBsYXN0RXhlY3V0ZWQuZ2V0VGltZSgpXHJcbiAgICBjb25zdCBmaWZ0ZWVuTWludXRlcyA9IDE1ICogNjAgKiAxMDAwXHJcblxyXG4gICAgcmV0dXJuIHRpbWVEaWZmID49IGZpZnRlZW5NaW51dGVzXHJcbiAgfVxyXG5cclxuICBhc3luYyBnZXRSZXBvcnRzKGZpbHRlcnM/OiB7XHJcbiAgICB0eXBlPzogUmVwb3J0VHlwZVxyXG4gICAgY3JlYXRlZEJ5Pzogc3RyaW5nXHJcbiAgICBpc0FjdGl2ZT86IGJvb2xlYW5cclxuICB9KTogUHJvbWlzZTxSZXBvcnRbXT4ge1xyXG4gICAgY29uc3QgcXVlcnkgPSB0aGlzLnJlcG9ydFJlcG9zaXRvcnkuY3JlYXRlUXVlcnlCdWlsZGVyKFwicmVwb3J0XCIpXHJcblxyXG4gICAgaWYgKGZpbHRlcnM/LnR5cGUpIHtcclxuICAgICAgcXVlcnkuYW5kV2hlcmUoXCJyZXBvcnQudHlwZSA9IDp0eXBlXCIsIHsgdHlwZTogZmlsdGVycy50eXBlIH0pXHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGZpbHRlcnM/LmNyZWF0ZWRCeSkge1xyXG4gICAgICBxdWVyeS5hbmRXaGVyZShcInJlcG9ydC5jcmVhdGVkQnkgPSA6Y3JlYXRlZEJ5XCIsIHtcclxuICAgICAgICBjcmVhdGVkQnk6IGZpbHRlcnMuY3JlYXRlZEJ5LFxyXG4gICAgICB9KVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChmaWx0ZXJzPy5pc0FjdGl2ZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIHF1ZXJ5LmFuZFdoZXJlKFwicmVwb3J0LmlzQWN0aXZlID0gOmlzQWN0aXZlXCIsIHtcclxuICAgICAgICBpc0FjdGl2ZTogZmlsdGVycy5pc0FjdGl2ZSxcclxuICAgICAgfSlcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcXVlcnkub3JkZXJCeShcInJlcG9ydC5jcmVhdGVkQXRcIiwgXCJERVNDXCIpLmdldE1hbnkoKVxyXG4gIH1cclxufVxyXG4iXSwidmVyc2lvbiI6M30=